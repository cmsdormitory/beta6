<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明馬二樓積分兌換系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2575fc;
            --secondary: #6a11cb;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --light: #f8f9fa;
            --dark: #343a40;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }

        .theme-dark {
            --glass-bg: rgba(30, 30, 40, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --text-color: #f0f0f0;
            --card-bg: rgba(40, 40, 50, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background: linear-gradient(135deg, #a6d1ff 0%, #c2e9fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: #333;
        }
        
        body.theme-dark {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-color);
        }
        
        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .loader-content {
            text-align: center;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(37, 117, 252, 0.3);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 落叶动画效果 */
        .leaf {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ffd700;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            opacity: 0.7;
            animation: falling linear infinite;
            z-index: 0;
        }
        
        @keyframes falling {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* 玻璃水滴型卡片设计 */
        .card {
            background: var(--glass-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .card {
            background: var(--card-bg);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.5) 0%, rgba(106, 17, 203, 0.5) 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .card-header i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .card:hover .card-header i {
            transform: scale(1.1);
        }
        
        .card-header h2 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .theme-dark .card-header h2 {
            color: var(--text-color);
        }
        
        .login-section {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .login-card {
            flex: 1;
            min-width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .form-group label {
            color: #ccc;
        }
        
        /* 玻璃水滴型输入框 */
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
        }
        
        .theme-dark .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }
        
        .form-control:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .form-control:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 层次感按钮设计 */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:hover::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #1a68e8 0%, #5a0fb5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 117, 252, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(37, 117, 252, 0.4);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, #219955 100%);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d35400 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400 0%, #ba4a00 100%);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7a7d 100%);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }
        
        .barcode-scan {
            text-align: center;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .barcode-scan:hover {
            border-color: rgba(37, 117, 252, 0.7);
            background: rgba(37, 117, 252, 0.1);
        }
        
        .barcode-scan i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        
        .barcode-scan:hover i {
            transform: scale(1.1);
        }
        
        .barcode-scan p {
            color: #666;
            font-size: 16px;
        }
        
        .theme-dark .barcode-scan p {
            color: #ccc;
        }
        
        .dashboard {
            display: none;
        }
        
        .user-info {
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.7) 0%, rgba(106, 17, 203, 0.7) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .user-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .points {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: var(--dark);
        }
        
        .theme-dark .tab {
            color: var(--text-color);
        }
        
        .tab.active {
            border-bottom: 3px solid rgba(37, 117, 252, 0.7);
            color: var(--primary);
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .prize-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .prize-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .prize-image {
            width: 100%;
            height: 150px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .theme-dark .prize-image {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover .prize-image {
            transform: scale(1.05);
        }
        
        .prize-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .prize-points {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .admin-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .users-table, .history-table, .prizes-table, .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th, .users-table td,
        .history-table th, .history-table td,
        .prizes-table th, .prizes-table td,
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        
        .users-table th, .history-table th, .prizes-table th, .leaderboard-table th {
            background: rgba(248, 249, 250, 0.5);
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .users-table th, 
        .theme-dark .history-table th, 
        .theme-dark .prizes-table th, 
        .theme-dark .leaderboard-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }
        
        .users-table tr:hover, .history-table tr:hover, .prizes-table tr:hover, .leaderboard-table tr:hover {
            background: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .users-table tr:hover, 
        .theme-dark .history-table tr:hover, 
        .theme-dark .prizes-table tr:hover, 
        .theme-dark .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .action-btn {
            padding: 6px 12px;
            margin-right: 5px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .modal-content {
            background: var(--card-bg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .modal-header h3 {
            color: var(--dark);
            font-size: 1.5rem;
        }
        
        .theme-dark .modal-header h3 {
            color: var(--text-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--dark);
        }
        
        .theme-dark .close-btn:hover {
            color: var(--text-color);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            transition: background-color 0.2s;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .history-item:hover {
            background-color: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .history-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-points {
            font-weight: bold;
        }
        
        .points-positive {
            color: var(--success);
        }
        
        .points-negative {
            color: var(--danger);
        }
        
        .barcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
        }
        
        .theme-dark .barcode-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .barcode-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: white;
        }
        
        .barcode-placeholder {
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .theme-dark .barcode-placeholder {
            color: #ccc;
        }
        
        .scan-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .theme-dark #scanner-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .scan-line {
            width: 80%;
            height: 2px;
            background: var(--primary);
            position: relative;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: -50%; }
            100% { top: 150%; }
        }
        
        .scan-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-barcode {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }
        
        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* 玻璃水滴型登录选项按钮 */
        .login-option-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .login-option-btn {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .login-option-btn.active {
            background: rgba(37, 117, 252, 0.3);
            color: white;
            border-color: rgba(37, 117, 252, 0.5);
        }
        
        .login-option-btn:hover {
            background: rgba(37, 117, 252, 0.2);
            transform: translateY(-2px);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .data-management {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-management .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .stat-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .stat-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .theme-dark .stat-label {
            color: #ccc;
        }
        
        /* 优化选项框样式 - 更圆滑、半透明 */
        .reason-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }
        
        .theme-dark .reason-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .reason-select:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .reason-select:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .reason-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: inherit;
        }
        
        .theme-dark .reason-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-tier {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .tier-king {
            background-color: #ffd900;
            color: #000;
        }
        
        .tier-diamond {
            background-color: #9035F8;
            color: white;
        }
        
        .tier-platinum {
            background-color: #75c8ff;
            color: #000;
        }
        
        .tier-gold {
            background-color: #ff8904;
            color: white;
        }
        
        .tier-silver {
            background-color: #5fecfc;
            color: #000;
        }
        
        .tier-bronze {
            background-color: brown;
            color: white;
        }
        
        /* 排行榜样式 - 前三名更醒目 */
        .leaderboard-container {
            display: flex;
            gap: 25px;
            margin-top: 20px;
        }
        
        .leaderboard-table-container {
            flex: 2;
        }
        
        .leaderboard-table tr.top-three {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-left: 4px solid #ffd700;
        }
        
        .leaderboard-table tr:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.15) 100%);
            border-left: 4px solid #ffd700;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(192, 192, 192, 0.15) 100%);
            border-left: 4px solid #c0c0c0;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(205, 127, 50, 0.15) 100%);
            border-left: 4px solid #cd7f32;
            font-weight: bold;
        }
        
        .theme-dark .leaderboard-table tr:nth-child(1),
        .theme-dark .leaderboard-table tr:nth-child(2),
        .theme-dark .leaderboard-table tr:nth-child(3) {
            color: white;
        }
        
        .pie-chart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .pie-chart-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .pie-chart {
            width: 250px;
            height: 250px;
            position: relative;
        }
        
        .pie-chart canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* 成就系统样式 */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .achievement-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .achievement-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(50%);
        }
        
        .achievement-card.unlocked {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }
        
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .achievement-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 32px;
            color: white;
            transition: transform 0.3s ease;
        }
        
        .achievement-card:hover .achievement-icon {
            transform: scale(1.1) rotate(10deg);
        }
        
        .achievement-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .theme-dark .achievement-name {
            color: var(--text-color);
        }
        
        .achievement-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .theme-dark .achievement-description {
            color: #ccc;
        }
        
        .achievement-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .achievement-unlocked {
            background: var(--success);
            color: white;
        }
        
        .achievement-locked {
            background: #95a5a6;
            color: white;
        }
        
        .achievement-progress {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .achievement-progress-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .theme-dark .achievement-progress-text {
            color: #ccc;
        }
        
        .achievement-reward {
            margin-top: 10px;
            color: var(--warning);
            font-weight: 600;
        }
        
        /* 动画定义 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes achievementUnlock {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 0 30px rgba(46, 204, 113, 0.8); }
            100% { transform: scale(1); }
        }
        
        /* 新增的颜色设定 */
        #activeUsers,
        #activeUsers + .stat-label {
            color: #ffd900; /* 王者用户 */
        }

        #activeUser4,
        #activeUser4 + .stat-label {
            color: #9035F8; /* 钻石用户 */
        }

        #activeUser3,
        #activeUser3 + .stat-label {
            color: #75c8ff; /* 铂金用户 */
        }

        #activeUser2,
        #activeUser2 + .stat-label {
            color: #ff8904; /* 黄金用户 */
        }

        #activeUser1,
        #activeUser1 + .stat-label {
            color: #5fecfc; /* 白银用户 */
        }

        #activeUser0,
        #activeUser0 + .stat-label {
            color: brown; /* 青铜用户 */
        }
        
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* 徽章样式 */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .login-section {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .prizes-grid {
                grid-template-columns: 1fr;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .users-table, .history-table, .prizes-table, .leaderboard-table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .login-options {
                flex-direction: column;
            }
            
            .data-management {
                flex-direction: column;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-container {
                flex-direction: column;
            }
            
            .pie-chart {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h3>加載中...</h3>
            <p>正在初始化系統</p>
        </div>
    </div>
    
    <!-- 落叶动画元素 -->
    <div id="leaves-container"></div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <h1>明馬二樓宿舍積分兌換系統</h1>
            <p>明愛馬鞍山中學二樓宿舍專用</p>
        </div>
        
        <!-- 登陸區域 -->
        <div class="login-section" id="loginSection">
            <!-- 用戶登錄 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user"></i>
                    <h2>用戶登錄</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="userCodeLoginBtn">用戶編號登陸</div>
                    <div class="login-option-btn" id="userBarcodeLoginBtn">QRcode登陸</div>
                </div>
                
                <div id="userCodeLoginForm">
                    <div class="form-group">
                        <label for="userIdInput">用戶編號</label>
                        <input type="text" id="userIdInput" class="form-control" placeholder="輸入用戶編號">
                    </div>
                    <button class="btn btn-block" id="userLoginBtn">用戶登錄</button>
                </div>
                
                <div id="userBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="userBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
                
                <div class="user-info" style="display: none;" id="userInfo">
                    <div>
                        <h3 id="userName">张三</h3>
                        <p>用户编号: <span id="userId">U1001</span></p>
                    </div>
                    <div class="points" id="userPoints">1500</div>
                </div>
            </div>
            
            <!-- 管理员登录 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user-shield"></i>
                    <h2>管理员登录</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="adminCodeLoginBtn">管理員編號登陸</div>
                    <div class="login-option-btn" id="adminBarcodeLoginBtn">管理員QRcode登陸</div>
                </div>
                
                <div id="adminCodeLoginForm">
                    <div class="form-group">
                        <label for="adminId">管理員編號</label>
                        <input type="text" id="adminId" class="form-control" placeholder="輸入管理員編號">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">管理員密碼</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="請輸入管理員密碼">
                    </div>
                    
                    <button class="btn btn-block" id="adminLoginBtn">管理員登陸</button>
                </div>
                
                <div id="adminBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="adminBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户仪表盘 -->
        <div class="dashboard card" id="userDashboard">
            <div class="card-header">
                <i class="fas fa-gift"></i>
                <h2>積分兌換中心</h2>
            </div>
            
            <div class="user-info">
                <div>
                    <h3 id="dashboardUserName">张三</h3>
                    <p>用戶編號: <span id="dashboardUserId">U1001</span></p>
                    <p>QRcode編碼: <span id="dashboardUserBarcode">BARCODE001</span></p>
                    <p>段位: <span id="dashboardUserTier">青銅</span></p>
                </div>
                <div>
                    <div class="points" id="dashboardUserPoints">1500</div>
                    <div style="text-align: right;">累積積分: <span id="dashboardUserTotalPoints">2500</span></div>
                </div>
            </div>
            
            <div class="user-barcode">
                <h4>我的QRcode</h4>
                <div id="userBarcodeDisplay"></div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="prizes">獎品兌換</div>
                <div class="tab" data-tab="history">積分歷史</div>
                <div class="tab" data-tab="leaderboard">排行榜</div>
                <div class="tab" data-tab="achievements">成就系統</div>
            </div>
            
            <div class="tab-content active" id="prizes-tab">
                <h3 style="margin-bottom: 15px;">可用獎品</h3>
                <div class="prizes-grid" id="prizesGrid">
                    <!-- 奖品将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <h3 style="margin-bottom: 15px;">積分歷史紀錄</h3>
                <div id="userHistoryContent">
                    <!-- 用户积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="userLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="tierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="pieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="achievements-tab">
                <h3 style="margin-bottom: 15px;">成就系統</h3>
                <div class="user-stats" style="margin-bottom: 25px;">
                    <div class="stat-card">
                        <div class="stat-value" id="achievementUnlocked">0</div>
                        <div class="stat-label">已解鎖成就</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementTotal">0</div>
                        <div class="stat-label">總成就數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementProgress">0%</div>
                        <div class="stat-label">成就進度</div>
                    </div>
                </div>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- 成就将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="userLogoutBtn">退出登陸</button>
        </div>
        
        <!-- 管理员仪表盘 -->
        <div class="dashboard card" id="adminDashboard">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <h2>積分管理系統</h2>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="users">用戶管理</div>
                <div class="tab" data-tab="prizes-admin">獎品管理</div>
                <div class="tab" data-tab="history-admin">積分歷史</div>
                <div class="tab" data-tab="leaderboard-admin">排行榜</div>
                <div class="tab" data-tab="system-admin">系統管理</div>
            </div>
            
            <div class="tab-content active" id="users-tab">
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">總積分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">👑👑👑王者用戶🏅️🏅️🏅️</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser4">0</div>
                        <div class="stat-label">💎鑽石用戶💎</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser3">0</div>
                        <div class="stat-label">💍鉑金用戶💍</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser2">0</div>
                        <div class="stat-label">✨黃金用戶✨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser1">0</div>
                        <div class="stat-label">🥈白銀用戶🥈</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser0">0</div>
                        <div class="stat-label">.🔥青銅用戶🔥.</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchUser" class="form-control" placeholder="輸入用戶編號·姓名或QRcode編碼">
                    <button class="btn" id="searchUserBtn">搜索</button>
                    <button class="btn btn-secondary" id="clearSearchBtn">清除</button>
                </div>
                
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="pointsChange">積分變更</label>
                        <input type="number" id="pointsChange" class="form-control" placeholder="輸入積分變更值">
                    </div>
                    <div class="form-group">
                        <label for="pointsReason">變更原因</label>
                        <select id="pointsReason" class="reason-select">
                            <option value="">-- 選擇原因 --</option>
                            <option value="任務獎勵">任務獎勵</option>
                            <option value="活動獎勵">活動獎勵</option>
                            <option value="挑戰獎勵">挑戰獎勵</option>
                            <option value="閱讀獎勵">閱讀獎勵</option>
                            <option value="管理員調整">管理員調整</option>
                            <option value="其他">其他</option>
                        </select>
                        <input type="text" id="customReason" class="reason-input" placeholder="輸入其他原因" style="display: none;">
                    </div>
                    <button class="btn" id="updatePointsBtn" style="align-self: flex-end;">更新積分</button>
                    <button class="btn btn-success" id="addUserBtn" style="align-self: flex-end;">添加用戶</button>
                    <button class="btn btn-info" id="exportUsersBtn" style="align-self: flex-end;">導出用戶</button>
                </div>
                
                <h3>用戶列表</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>用戶編號</th>
                            <th>姓名</th>
                            <th>QRcode編碼</th>
                            <th>當前積分</th>
                            <th>累積積分</th>
                            <th>段位</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- 用户数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="prizes-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="prizeName">獎品名稱</label>
                        <input type="text" id="prizeName" class="form-control" placeholder="輸入獎品名稱">
                    </div>
                    <div class="form-group">
                        <label for="prizePoints">所需積分</label>
                        <input type="number" id="prizePoints" class="form-control" placeholder="輸入所需積分" min="1">
                    </div>
                    <div class="form-group">
                        <label for="prizeIcon">圖標</label>
                        <input type="text" id="prizeIcon" class="form-control" placeholder="輸入FontAwesome圖標名稱" value="fa-gift">
                    </div>
                    <button class="btn btn-success" id="addPrizeBtn" style="align-self: flex-end;">添加獎品</button>
                    <button class="btn btn-info" id="exportPrizesBtn" style="align-self: flex-end;">導出獎品</button>
                </div>
                
                <h3>獎品列表</h3>
                <table class="prizes-table">
                    <thead>
                        <tr>
                            <th>獎品ID</th>
                            <th>獎品名稱</th>
                            <th>所需積分</th>
                            <th>圖標</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="prizesTableBody">
                        <!-- 奖品数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="history-admin-tab">
                <div class="search-box">
                    <input type="text" id="searchHistoryUser" class="form-control" placeholder="輸入用戶編號、姓名或QRcode編碼">
                    <button class="btn" id="searchHistoryBtn">搜索歷史紀錄</button>
                    <button class="btn btn-secondary" id="clearHistorySearchBtn">清除</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="exportHistoryBtn">導出歷史紀錄</button>
                    <button class="btn btn-warning" id="clearHistoryBtn">清空歷史紀錄</button>
                </div>
                
                <h3>積分歷史紀錄</h3>
                <div id="adminHistoryContent">
                    <!-- 管理员查看的积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-admin-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="adminLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="adminTierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="adminPieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="system-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="currentPassword">當前密碼</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="輸入當前密碼">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密碼</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="輸入新密碼">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">確認新密碼</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="再次輸入新密碼">
                    </div>
                    <button class="btn btn-warning" id="changePasswordBtn" style="align-self: flex-end;">修改密碼</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="importDataBtn">導入歷史數據</button>
                    <button class="btn btn-success" id="exportDataBtn">導出所有數據</button>
                    <button class="btn btn-danger" id="resetDataBtn">重置所有數據</button>
                </div>
                
                <div class="form-group">
                    <label for="dataFile">選擇數據文件 (JSON格式)</label>
                    <input type="file" id="dataFile" class="form-control" accept=".json">
                </div>
                
                <h3>系统信息</h3>
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="systemUsers">0</div>
                        <div class="stat-label">用戶數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemPrizes">0</div>
                        <div class="stat-label">獎品數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemHistory">0</div>
                        <div class="stat-label">歷史紀錄</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemAdmins">0</div>
                        <div class="stat-label">管理員數量</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="adminLogoutBtn">退出登陸</button>
        </div>
    </div>
    
    <!-- 添加用户模态框 -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新用戶</h3>
                <button class="close-btn" id="closeAddUserModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newUserName">用户姓名</label>
                <input type="text" id="newUserName" class="form-control" placeholder="請輸入用户姓名">
            </div>
            <div class="form-group">
                <label for="newUserId">用户編號</label>
                <input type="text" id="newUserId" class="form-control" placeholder="請輸入用户編號">
            </div>
            <div class="form-group">
                <label for="newUserPoints">初始積分</label>
                <input type="number" id="newUserPoints" class="form-control" value="0" min="0">
            </div>
            <div class="form-group">
                <label>生成的QRcode編碼: <span id="generatedBarcodeCode">BARCODE001</span></label>
            </div>
            <div class="barcode-container" id="newUserBarcode"></div>
            <button class="btn btn-success btn-block" id="confirmAddUser">確認添加用户</button>
        </div>
    </div>
    
    <!-- 编辑奖品模态框 -->
    <div class="modal" id="editPrizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯獎品</h3>
                <button class="close-btn" id="closeEditPrizeModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editPrizeName">獎品名稱</label>
                <input type="text" id="editPrizeName" class="form-control" placeholder="請輸入獎品名稱">
            </div>
            <div class="form-group">
                <label for="editPrizePoints">所需積分</label>
                <input type="number" id="editPrizePoints" class="form-control" placeholder="請輸入所需積分" min="1">
            </div>
            <div class="form-group">
                <label for="editPrizeIcon">圖標類名</label>
                <input type="text" id="editPrizeIcon" class="form-control" placeholder="輸入FontAwesome圖標類名">
            </div>
            <input type="hidden" id="editPrizeId">
            <button class="btn btn-success btn-block" id="confirmEditPrize">确认修改</button>
        </div>
    </div>
    
    <!-- 条形码扫描模态框 -->
    <div class="modal" id="barcodeScannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>掃描QRcode</h3>
                <button class="close-btn" id="closeScannerModal">&times;</button>
            </div>
            <div class="scan-area">
                <div id="scanner-container">
                    <!-- 摄像头预览将在这里显示 -->
                </div>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div class="scan-controls">
                <button class="btn" id="startScannerBtn">開始掃描</button>
                <button class="btn btn-danger" id="stopScannerBtn" style="display: none;">停止掃描</button>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>掃描結果: <span id="scanResult">等待掃描...</span></label>
            </div>
            <button class="btn btn-success btn-block" id="confirmScanBtn" style="display: none;">確認此QRcode編碼正確？</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // 创建落叶效果
        function createLeaves() {
            const leavesContainer = document.getElementById('leaves-container');
            const leafCount = 15; // 落叶数量
            
            for (let i = 0; i < leafCount; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                
                // 随机位置
                const left = Math.random() * 100;
                leaf.style.left = left + 'vw';
                
                // 随机大小
                const size = 15 + Math.random() * 20;
                leaf.style.width = size + 'px';
                leaf.style.height = size + 'px';
                
                // 随机动画延迟和持续时间
                const delay = Math.random() * 10;
                const duration = 5 + Math.random() * 10;
                leaf.style.animationDelay = delay + 's';
                leaf.style.animationDuration = duration + 's';
                
                leavesContainer.appendChild(leaf);
            }
        }
        
        // 用户数据存储
        let users = JSON.parse(localStorage.getItem('barcodePointsUsers')) || [
            { 
                id: 'U1001', 
                name: '张三', 
                barcodeCode: 'USER001', 
                points: 1500, 
                totalPoints: 2500,
                tier: '鉑金',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅', '大佬帶帶我'],
                achievementData: {}
            },
            { 
                id: 'U1002', 
                name: '李四', 
                barcodeCode: 'USER002', 
                points: 800, 
                totalPoints: 1200,
                tier: '黃金',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅'],
                achievementData: {}
            },
            { 
                id: 'U1003', 
                name: '王五', 
                barcodeCode: 'USER003', 
                points: 2200, 
                totalPoints: 3200,
                tier: '鑽石',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅', '中等貴族✨', '大佬帶帶我'],
                achievementData: {}
            },
            { 
                id: 'wwlwcf002', 
                name: '管理员', 
                barcodeCode: 'wwlwcf002', 
                points: 0, 
                totalPoints: 0,
                tier: '',
                isAdmin: true,
                achievements: [],
                achievementData: {}
            }
        ];
        
        // 奖品数据存储
        let prizes = JSON.parse(localStorage.getItem('barcodePointsPrizes')) || [
            { id: 'P001', name: '咖啡券', points: 200, icon: 'fa-mug-hot' },
            { id: 'P002', name: '电影票', points: 500, icon: 'fa-film' },
            { id: 'P003', name: '蓝牙耳机', points: 1500, icon: 'fa-headphones' },
            { id: 'P004', name: '智能手表', points: 3000, icon: 'fa-clock' },
            { id: 'P005', name: '平板电脑', points: 5000, icon: 'fa-tablet-alt' },
            { id: 'P006', name: '购物卡', points: 1000, icon: 'fa-shopping-bag' }
        ];
        
        // 积分历史记录存储
        let pointsHistory = JSON.parse(localStorage.getItem('barcodePointsHistory')) || [
            { userId: 'U1001', timestamp: new Date('2023-10-01 09:30:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-05 14:20:00').getTime(), pointsChange: -200, reason: '兑换咖啡券' },
            { userId: 'U1001', timestamp: new Date('2023-10-10 11:15:00').getTime(), pointsChange: 500, reason: '活动奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-15 15:40:00').getTime(), pointsChange: 800, reason: '管理员调整' },
            { userId: 'U1002', timestamp: new Date('2023-10-02 10:45:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1002', timestamp: new Date('2023-10-07 16:30:00').getTime(), pointsChange: 300, reason: '完成任务' },
            { userId: 'U1003', timestamp: new Date('2023-10-03 08:20:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-08 13:10:00').getTime(), pointsChange: 1000, reason: '推荐用户奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-12 17:25:00').getTime(), pointsChange: 400, reason: '活动奖励' }
        ];
        
        // 完善后的成就系统
        const achievements = [
            { 
                id: 'new_user', 
                name: '新手求帶！😭', 
                description: '積分達到100分', 
                icon: 'fa-baby', 
                reward: '+50積分',
                condition: (user, data) => user.totalPoints >= 100,
                progress: (user, data) => Math.min(100, (user.totalPoints / 100) * 100)
            },
            { 
                id: 'points_collector_1', 
                name: '低等貴族🫅', 
                description: '累積積分達到500點', 
                icon: 'fa-crown', 
                reward: '+100積分',
                condition: (user, data) => user.totalPoints >= 500,
                progress: (user, data) => Math.min(100, (user.totalPoints / 500) * 100)
            },
            { 
                id: 'points_collector_2', 
                name: '中等貴族✨', 
                description: '累積積分達到1200點', 
                icon: 'fa-gem', 
                reward: '+200積分',
                condition: (user, data) => user.totalPoints >= 1200,
                progress: (user, data) => Math.min(100, (user.totalPoints / 1200) * 100)
            },
            { 
                id: 'points_collector_3', 
                name: '💎高等貴族💎', 
                description: '累積積分達到2000點', 
                icon: 'fa-diamond', 
                reward: '+300積分',
                condition: (user, data) => user.totalPoints >= 2000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 2000) * 100)
            },
            { 
                id: 'points_collector_4', 
                name: '👑全服之王👑', 
                description: '累積積分達到3000點', 
                icon: 'fa-trophy', 
                reward: '+500積分',
                condition: (user, data) => user.totalPoints >= 3000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 3000) * 100)
            },
            { 
                id: 'tier_master', 
                name: '大佬帶帶我', 
                description: '達到鉑金段位', 
                icon: 'fa-star', 
                reward: '+150積分',
                condition: (user, data) => user.tier === '鉑金' || user.tier === '鑽石' || user.tier === '王者',
                progress: (user, data) => {
                    const tiers = ['青銅', '白銀', '黃金', '鉑金', '鑽石', '王者'];
                    const currentIndex = tiers.indexOf(user.tier);
                    return Math.min(100, ((currentIndex + 1) / 4) * 100);
                }
            },
            { 
                id: 'exchange_expert', 
                name: '兄弟手頭有點緊啊～', 
                description: '成功兌換5次獎品', 
                icon: 'fa-gift', 
                reward: '+100積分',
                condition: (user, data) => {
                    if (!data || !data.exchangeCount) return false;
                    return data.exchangeCount >= 5;
                },
                progress: (user, data) => {
                    const exchangeCount = data && data.exchangeCount ? data.exchangeCount : 0;
                    return Math.min(100, (exchangeCount / 5) * 100);
                },
                getData: (user) => {
                    const exchangeCount = pointsHistory.filter(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    ).length;
                    return { exchangeCount };
                }
            },
                progress: (user, data) => {
                    const consecutiveDays = data && data.consecutiveDays ? data.consecutiveDays : 0;
                    return Math.min(100, (consecutiveDays / 7) * 100);
                },
                getData: (user) => {
                    const userHistory = pointsHistory
                        .filter(h => h.userId === user.id && h.pointsChange > 0)
                        .sort((a, b) => a.timestamp - b.timestamp);
                    
                    let consecutiveDays = 0;
                    let currentStreak = 1;
                    
                    for (let i = 1; i < userHistory.length; i++) {
                        const prevDate = new Date(userHistory[i-1].timestamp);
                        const currDate = new Date(userHistory[i].timestamp);
                        const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            currentStreak++;
                        } else if (diffDays > 1) {
                            currentStreak = 1;
                        }
                        
                        if (currentStreak > consecutiveDays) {
                            consecutiveDays = currentStreak;
                        }
                    }
                    
                    return { consecutiveDays };
                }
            },
            { 
                id: 'first_exchange', 
                name: '首次兌換', 
                description: '第一次兌換獎品', 
                icon: 'fa-shopping-cart', 
                reward: '+50積分',
                condition: (user, data) => {
                    if (!data || !data.hasExchanged) return false;
                    return data.hasExchanged;
                },
                progress: (user, data) => {
                    const hasExchanged = data && data.hasExchanged ? data.hasExchanged : false;
                    return hasExchanged ? 100 : 0;
                },
                getData: (user) => {
                    const hasExchanged = pointsHistory.some(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    );
                    return { hasExchanged };
                }
            },
            { 
                id: 'daily_login', 
                name: '連續登錄', 
                description: '連續登錄3天', 
                icon: 'fa-calendar-check', 
                reward: '+30積分',
                condition: (user, data) => {
                    if (!data || !data.loginDays) return false;
                    return data.loginDays >= 3;
                },
                progress: (user, data) => {
                    const loginDays = data && data.loginDays ? data.loginDays : 0;
                    return Math.min(100, (loginDays / 3) * 100);
                },
                getData: (user) => {
                    // 模拟数据 - 实际应用中应该记录用户登录时间
                    return { loginDays: Math.floor(Math.random() * 5) };
                }
            }
        ];
        
        // 段位划分标准（基于累积积分）
        const tierThresholds = [
            { name: '青銅', min: 0, max: 299, color: 'brown' },
            { name: '白銀', min: 300, max: 599, color: '#5fecfc' },
            { name: '黃金', min: 600, max: 899, color: '#ff8904' },
            { name: '鉑金', min: 900, max: 1199, color: '#75c8ff' },
            { name: '鑽石', min: 1200, max: 1499, color: '#9035F8' },
            { name: '王者', min: 1500, max: Infinity, color: '#ffd900' }
        ];
        
        // 计算用户段位
        function calculateUserTier(totalPoints) {
            for (const tier of tierThresholds) {
                if (totalPoints >= tier.min && totalPoints <= tier.max) {
                    return tier.name;
                }
            }
            return '青銅';
        }
        
        // 获取段位对应的CSS类名
        function getTierClass(tierName) {
            switch(tierName) {
                case '王者': return 'tier-king';
                case '鑽石': return 'tier-diamond';
                case '鉑金': return 'tier-platinum';
                case '黃金': return 'tier-gold';
                case '白銀': return 'tier-silver';
                case '青銅': return 'tier-bronze';
                default: return 'tier-bronze';
            }
        }
        
        // 获取段位对应的颜色
        function getTierColor(tierName) {
            for (const tier of tierThresholds) {
                if (tier.name === tierName) {
                    return tier.color;
                }
            }
            return 'brown';
        }
        
        // 管理员密码
        const adminPassword = 'admin123';
        
        // DOM元素
        const pageLoader = document.getElementById('pageLoader');
        const loginSection = document.getElementById('loginSection');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const userBarcodeScan = document.getElementById('userBarcodeScan');
        const adminBarcodeScan = document.getElementById('adminBarcodeScan');
        const userLoginBtn = document.getElementById('userLoginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const userLogoutBtn = document.getElementById('userLogoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const prizesGrid = document.getElementById('prizesGrid');
        const usersTableBody = document.getElementById('usersTableBody');
        const prizesTableBody = document.getElementById('prizesTableBody');
        const updatePointsBtn = document.getElementById('updatePointsBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const closeAddUserModal = document.getElementById('closeAddUserModal');
        const confirmAddUser = document.getElementById('confirmAddUser');
        const generatedBarcodeCode = document.getElementById('generatedBarcodeCode');
        const newUserBarcode = document.getElementById('newUserBarcode');
        const addPrizeBtn = document.getElementById('addPrizeBtn');
        const editPrizeModal = document.getElementById('editPrizeModal');
        const closeEditPrizeModal = document.getElementById('closeEditPrizeModal');
        const confirmEditPrize = document.getElementById('confirmEditPrize');
        const searchHistoryBtn = document.getElementById('searchHistoryBtn');
        const barcodeScannerModal = document.getElementById('barcodeScannerModal');
        const closeScannerModal = document.getElementById('closeScannerModal');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scanResult = document.getElementById('scanResult');
        const confirmScanBtn = document.getElementById('confirmScanBtn');
        const userIdInput = document.getElementById('userIdInput');
        const userBarcodeDisplay = document.getElementById('userBarcodeDisplay');
        const notification = document.getElementById('notification');
        const userLeaderboardBody = document.getElementById('userLeaderboardBody');
        const adminLeaderboardBody = document.getElementById('adminLeaderboardBody');
        const tierPieChart = document.getElementById('tierPieChart');
        const adminTierPieChart = document.getElementById('adminTierPieChart');
        const pieLegend = document.getElementById('pieLegend');
        const adminPieLegend = document.getElementById('adminPieLegend');
        const themeToggle = document.getElementById('themeToggle');
        const achievementsGrid = document.getElementById('achievementsGrid');
        
        // 登录选项切换
        const userCodeLoginBtn = document.getElementById('userCodeLoginBtn');
        const userBarcodeLoginBtn = document.getElementById('userBarcodeLoginBtn');
        const userCodeLoginForm = document.getElementById('userCodeLoginForm');
        const userBarcodeLoginForm = document.getElementById('userBarcodeLoginForm');
        
        const adminCodeLoginBtn = document.getElementById('adminCodeLoginBtn');
        const adminBarcodeLoginBtn = document.getElementById('adminBarcodeLoginBtn');
        const adminCodeLoginForm = document.getElementById('adminCodeLoginForm');
        const adminBarcodeLoginForm = document.getElementById('adminBarcodeLoginForm');
        
        // 新增功能元素
        const searchUserBtn = document.getElementById('searchUserBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const exportUsersBtn = document.getElementById('exportUsersBtn');
        const exportPrizesBtn = document.getElementById('exportPrizesBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearHistorySearchBtn = document.getElementById('clearHistorySearchBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const dataFile = document.getElementById('dataFile');
        const pointsReason = document.getElementById('pointsReason');
        const customReason = document.getElementById('customReason');
        
        // 当前登录的用户和管理员
        let currentUser = null;
        let currentAdmin = false;
        let scannerActive = false;
        let scannedBarcode = '';
        let scannerType = '';
        let pieChartAnimations = {};
        
        // 修复条形码生成函数
        function generateBarcode(code, container) {
            container.innerHTML = '';
            
            if (!code || code.trim() === '') {
                container.innerHTML = '<div class="barcode-placeholder">条形码编码为空</div>';
                return;
            }
            
            try {
                // 创建canvas元素
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                
                // 使用JsBarcode生成条形码
                JsBarcode(canvas, code, {
                    format: "CODE128",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontOptions: "bold",
                    fontSize: 16,
                    textMargin: 10,
                    margin: 10,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
                
                console.log('QRcode生成成功:', code);
            } catch (error) {
                console.error('QRcode生成失敗:', error);
                container.innerHTML = '<div class="barcode-placeholder">QRcode生成失敗: ' + error.message + '</div>';
            }
        }

        // 初始化页面
        function initPage() {
            // 隐藏加载动画
            setTimeout(() => {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 500);
            }, 1500); // 保持初始化时间
            
            // 创建落叶效果
            createLeaves();
            
            // 保存初始数据到localStorage
            saveDataToStorage();
            
            // 只渲染必要的组件，延迟渲染其他组件
            renderPrizes();
            renderUsersTable();
            renderPrizesTable();
            setupTabs();
            setupLoginOptions();
            updateSystemStats();
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 检查是否已保存主题偏好
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('theme-dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // 积分变更原因选择事件
            pointsReason.addEventListener('change', function() {
                if (this.value === '其他') {
                    customReason.style.display = 'block';
                } else {
                    customReason.style.display = 'none';
                    customReason.value = '';
                }
            });
            
            // 用户登录按钮事件
            userLoginBtn.addEventListener('click', function() {
                const userId = userIdInput.value;
                if (userId) {
                    loginWithUserId(userId);
                } else {
                    showNotification('請輸入用戶編號', 'error');
                }
            });
            
            // 用户条形码扫描事件
            userBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('user');
            });
            
            // 管理员条形码扫描事件
            adminBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('admin');
            });
            
            // 管理员登录按钮事件
            adminLoginBtn.addEventListener('click', function() {
                const adminId = document.getElementById('adminId').value;
                const password = document.getElementById('adminPassword').value;
                
                if (adminId && password) {
                    loginAdminWithCredentials(adminId, password);
                } else {
                    showNotification('請輸入管理員編號和密碼', 'error');
                }
            });
            
            // 用户退出登录
            userLogoutBtn.addEventListener('click', function() {
                currentUser = null;
                showLoginSection();
                showNotification('已登出用戶登錄', 'info');
            });
            
            // 管理员退出登录
            adminLogoutBtn.addEventListener('click', function() {
                // 询问是否要下载备份
                if (confirm('是否要下載最新的系統文件？')) {
                    exportAllData();
                }
                currentAdmin = false;
                document.getElementById('adminId').value = '';
                document.getElementById('adminPassword').value = '';
                showLoginSection();
                showNotification('已登出管理員登陸', 'info');
            });
            
            // 更新积分按钮事件 - 添加成功提示
            updatePointsBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                const pointsChange = parseInt(document.getElementById('pointsChange').value);
                let reason = pointsReason.value;
                
                if (reason === '其他') {
                    reason = customReason.value;
                }
                
                if (!searchTerm || isNaN(pointsChange)) {
                    showNotification('請輸入有效的變更值和用戶編號', 'error');
                    return;
                }
                
                if (!reason) {
                    showNotification('請選擇或輸入變更原因', 'error');
                    return;
                }
                
                const user = users.find(u => 
                    u.id === searchTerm || 
                    u.name === searchTerm || 
                    u.barcodeCode === searchTerm
                );
                
                if (user) {
                    user.points += pointsChange;
                    if (user.points < 0) user.points = 0;
                    
                    // 如果是增加积分，同时增加累积积分
                    if (pointsChange > 0) {
                        user.totalPoints += pointsChange;
                    }
                    
                    // 更新段位
                    user.tier = calculateUserTier(user.totalPoints);
                    
                    // 检查成就
                    checkAchievements(user);
                    
                    // 记录积分变更历史
                    pointsHistory.push({
                        userId: user.id,
                        timestamp: new Date().getTime(),
                        pointsChange: pointsChange,
                        reason: reason
                    });
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    renderUsersTable();
                    updateSystemStats();
                    document.getElementById('pointsChange').value = '';
                    pointsReason.value = '';
                    customReason.value = '';
                    customReason.style.display = 'none';
                    
                    // 添加成功提示
                    showNotification(`成功更新 ${user.name} 的積分！變更: ${pointsChange > 0 ? '+' : ''}${pointsChange}`, 'success');
                } else {
                    showNotification('未找到該用戶', 'error');
                }
            });
            
            // 添加用户按钮事件
            addUserBtn.addEventListener('click', function() {
                // 生成随机条形码编码
                const newBarcodeCode = generateBarcodeCode();
                generatedBarcodeCode.textContent = newBarcodeCode;
                
                // 生成条形码 - 添加延迟确保DOM更新
                setTimeout(() => {
                    generateBarcode(newBarcodeCode, newUserBarcode);
                }, 100);
                
                // 显示模态框
                addUserModal.style.display = 'flex';
            });
            
            // 关闭添加用户模态框
            closeAddUserModal.addEventListener('click', function() {
                addUserModal.style.display = 'none';
            });
            
            // 确认添加用户
            confirmAddUser.addEventListener('click', function() {
                const userName = document.getElementById('newUserName').value;
                const userId = document.getElementById('newUserId').value;
                const userPoints = parseInt(document.getElementById('newUserPoints').value) || 0;
                const barcodeCode = generatedBarcodeCode.textContent;
                
                if (!userName || !userId) {
                    showNotification('請輸入用戶姓名或編號', 'error');
                    return;
                }
                
                // 检查用户编号是否已存在
                if (users.find(u => u.id === userId)) {
                    showNotification('用戶編號已存在，請使用其他編號', 'error');
                    return;
                }
                
                // 计算段位
                const userTier = calculateUserTier(userPoints);
                
                // 添加新用户
                const newUser = {
                    id: userId,
                    name: userName,
                    barcodeCode: barcodeCode,
                    points: userPoints,
                    totalPoints: userPoints, // 初始累积积分等于当前积分
                    tier: userTier, // 初始段位
                    isAdmin: false,
                    achievements: [], // 初始成就
                    achievementData: {} // 初始成就数据
                };
                
                // 检查初始成就
                checkAchievements(newUser);
                
                users.push(newUser);
                
                // 记录初始积分历史
                if (userPoints > 0) {
                    pointsHistory.push({
                        userId: userId,
                        timestamp: new Date().getTime(),
                        pointsChange: userPoints,
                        reason: '初始積分'
                    });
                }
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderUsersTable();
                updateSystemStats();
                
                // 关闭模态框并重置表单
                addUserModal.style.display = 'none';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserId').value = '';
                document.getElementById('newUserPoints').value = '0';
                
                showNotification(`成功添加用户 ${userName}，条形码编码: ${barcodeCode}`, 'success');
            });
            
            // 添加奖品按钮事件
            addPrizeBtn.addEventListener('click', function() {
                const prizeName = document.getElementById('prizeName').value;
                const prizePoints = parseInt(document.getElementById('prizePoints').value);
                const prizeIcon = document.getElementById('prizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的獎品信息', 'error');
                    return;
                }
                
                // 生成奖品ID
                const prizeId = generatePrizeId();
                
                // 添加新奖品
                prizes.push({
                    id: prizeId,
                    name: prizeName,
                    points: prizePoints,
                    icon: prizeIcon
                });
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                // 重置表单
                document.getElementById('prizeName').value = '';
                document.getElementById('prizePoints').value = '';
                document.getElementById('prizeIcon').value = 'fa-gift';
                
                showNotification(`成功添加獎品 ${prizeName}`, 'success');
            });
            
            // 关闭编辑奖品模态框
            closeEditPrizeModal.addEventListener('click', function() {
                editPrizeModal.style.display = 'none';
            });
            
            // 确认编辑奖品
            confirmEditPrize.addEventListener('click', function() {
                const prizeId = document.getElementById('editPrizeId').value;
                const prizeName = document.getElementById('editPrizeName').value;
                const prizePoints = parseInt(document.getElementById('editPrizePoints').value);
                const prizeIcon = document.getElementById('editPrizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的奖品信息', 'error');
                    return;
                }
                
                // 更新奖品信息
                const prize = prizes.find(p => p.id === prizeId);
                if (prize) {
                    prize.name = prizeName;
                    prize.points = prizePoints;
                    prize.icon = prizeIcon;
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    // 更新界面
                    renderPrizesTable();
                    renderPrizes();
                    
                    // 关闭模态框
                    editPrizeModal.style.display = 'none';
                    
                    showNotification(`成功更新獎品 ${prizeName}`, 'success');
                }
            });
            
            // 搜索历史记录按钮事件
            searchHistoryBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchHistoryUser').value;
                renderAdminHistory(searchTerm);
            });
            
            // 条形码扫描模态框事件
            closeScannerModal.addEventListener('click', function() {
                closeBarcodeScanner();
            });
            
            startScannerBtn.addEventListener('click', function() {
                startBarcodeScanner();
            });
            
            stopScannerBtn.addEventListener('click', function() {
                stopBarcodeScanner();
            });
            
            confirmScanBtn.addEventListener('click', function() {
                if (scannedBarcode) {
                    if (scannerType === 'user') {
                        loginWithBarcode(scannedBarcode);
                    } else if (scannerType === 'admin') {
                        loginAdminWithBarcode(scannedBarcode);
                    }
                    closeBarcodeScanner();
                }
            });
            
            // 新增功能事件
            searchUserBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                renderUsersTable(searchTerm);
            });
            
            clearSearchBtn.addEventListener('click', function() {
                document.getElementById('searchUser').value = '';
                renderUsersTable();
            });
            
            exportUsersBtn.addEventListener('click', function() {
                exportUsersData();
            });
            
            exportPrizesBtn.addEventListener('click', function() {
                exportPrizesData();
            });
            
            exportHistoryBtn.addEventListener('click', function() {
                exportHistoryData();
            });
            
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有積分歷史紀錄吗？此操作不可恢復！')) {
                    pointsHistory = [];
                    saveDataToStorage();
                    renderAdminHistory();
                    updateSystemStats();
                    showNotification('歷史紀錄已清空', 'success');
                }
            });
            
            clearHistorySearchBtn.addEventListener('click', function() {
                document.getElementById('searchHistoryUser').value = '';
                renderAdminHistory();
            });
            
            changePasswordBtn.addEventListener('click', function() {
                changeAdminPassword();
            });
            
            importDataBtn.addEventListener('click', function() {
                dataFile.click();
            });
            
            exportDataBtn.addEventListener('click', function() {
                exportAllData();
            });
            
            resetDataBtn.addEventListener('click', function() {
                resetSystemData();
            });
            
            dataFile.addEventListener('change', function(e) {
                importData(e);
            });
        }
        
        // 主题切换
        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            if (document.body.classList.contains('theme-dark')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // 设置登录选项切换
        function setupLoginOptions() {
            // 用户登录选项
            userCodeLoginBtn.addEventListener('click', function() {
                userCodeLoginBtn.classList.add('active');
                userBarcodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'block';
                userBarcodeLoginForm.style.display = 'none';
            });
            
            userBarcodeLoginBtn.addEventListener('click', function() {
                userBarcodeLoginBtn.classList.add('active');
                userCodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'none';
                userBarcodeLoginForm.style.display = 'block';
            });
            
            // 管理员登录选项
            adminCodeLoginBtn.addEventListener('click', function() {
                adminCodeLoginBtn.classList.add('active');
                adminBarcodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'block';
                adminBarcodeLoginForm.style.display = 'none';
            });
            
            adminBarcodeLoginBtn.addEventListener('click', function() {
                adminBarcodeLoginBtn.classList.add('active');
                adminCodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'none';
                adminBarcodeLoginForm.style.display = 'block';
            });
        }
        
        // 设置选项卡切换
        function setupTabs() {
            // 用户界面选项卡
            const userTabs = document.querySelectorAll('#userDashboard .tab');
            userTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    userTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#userDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history') {
                        renderUserHistory();
                    } else if (tabId === 'leaderboard') {
                        renderUserLeaderboard();
                        renderTierPieChartWithAnimation(tierPieChart, pieLegend);
                    } else if (tabId === 'achievements') {
                        renderAchievements();
                    }
                });
            });
            
            // 管理员界面选项卡
            const adminTabs = document.querySelectorAll('#adminDashboard .tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    adminTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#adminDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history-admin') {
                        renderAdminHistory();
                    } else if (tabId === 'leaderboard-admin') {
                        renderAdminLeaderboard();
                        renderTierPieChartWithAnimation(adminTierPieChart, adminPieLegend);
                    } else if (tabId === 'system-admin') {
                        updateSystemStats();
                    }
                });
            });
        }
        
        // 使用用户编号登录
        function loginWithUserId(userId) {
            const user = users.find(u => u.id === userId && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('用户編號錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用条形码登录
        function loginWithBarcode(barcode) {
            const user = users.find(u => u.barcodeCode === barcode && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('QRcode錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用管理员凭据登录
        function loginAdminWithCredentials(adminId, password) {
            if (password === adminPassword) {
                const adminUser = users.find(u => u.id === adminId && u.isAdmin);
                if (adminUser) {
                    currentAdmin = true;
                    showAdminDashboard();
                    showNotification('管理員登陸成功！', 'success');
                } else {
                    showNotification('管理員編號錯誤！', 'error');
                }
            } else {
                showNotification('密碼錯誤，請重試！', 'error');
            }
        }
        
        // 使用管理员条形码登录
        function loginAdminWithBarcode(barcode) {
            const adminUser = users.find(u => u.barcodeCode === barcode && u.isAdmin);
            if (adminUser) {
                currentAdmin = true;
                showAdminDashboard();
                showNotification('管理員登錄成功！', 'success');
            } else {
                showNotification('管理員QRcode錯誤！', 'error');
            }
        }
        
        // 打开条形码扫描器
        function openBarcodeScanner(type) {
            scannerType = type;
            barcodeScannerModal.style.display = 'flex';
            scanResult.textContent = '等待掃描...';
            confirmScanBtn.style.display = 'none';
            scannedBarcode = '';
        }
        
        // 关闭条形码扫描器
        function closeBarcodeScanner() {
            barcodeScannerModal.style.display = 'none';
            stopBarcodeScanner();
        }
        
        // 开始条形码扫描
        function startBarcodeScanner() {
            if (scannerActive) return;
            
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.innerHTML = '';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerContainer,
                    constraints: {
                        width: 480,
                        height: 320,
                        facingMode: "environment" // 使用后置攝像頭
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showNotification('無法啟動攝像頭: ' + err, 'error');
                    return;
                }
                Quagga.start();
                scannerActive = true;
                startScannerBtn.style.display = 'none';
                stopScannerBtn.style.display = 'inline-block';
            });
            
            Quagga.onDetected(function(result) {
                if (result && result.codeResult) {
                    scannedBarcode = result.codeResult.code;
                    scanResult.textContent = scannedBarcode;
                    confirmScanBtn.style.display = 'block';
                    showNotification('監測到QRcode: ' + scannedBarcode, 'success');
                    
                    // 自动停止扫描
                    stopBarcodeScanner();
                }
            });
        }
        
        // 停止条形码扫描
        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                startScannerBtn.style.display = 'inline-block';
                stopScannerBtn.style.display = 'none';
            }
        }
        
        // 显示登录区域
        function showLoginSection() {
            loginSection.style.display = 'flex';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            userIdInput.value = '';
        }
        
        // 显示用户仪表盘
        function showUserDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'block';
            adminDashboard.style.display = 'none';
            
            // 更新用户信息
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            document.getElementById('dashboardUserId').textContent = currentUser.id;
            document.getElementById('dashboardUserBarcode').textContent = currentUser.barcodeCode;
            document.getElementById('dashboardUserPoints').textContent = currentUser.points;
            document.getElementById('dashboardUserTotalPoints').textContent = currentUser.totalPoints;
            document.getElementById('dashboardUserTier').textContent = currentUser.tier;
            document.getElementById('dashboardUserTier').className = 'user-tier ' + getTierClass(currentUser.tier);
            
            // 生成用户条形码 - 添加延迟
            setTimeout(() => {
                generateBarcode(currentUser.barcodeCode, userBarcodeDisplay);
            }, 100);
            
            // 重新渲染奖品列表
            renderPrizes();
            
            // 更新成就统计
            updateAchievementStats();
        }
        
        // 显示管理员仪表盘
        function showAdminDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'block';
        }
        
        // 渲染奖品列表（用户界面）
        function renderPrizes() {
            prizesGrid.innerHTML = '';
            
            prizes.forEach(prize => {
                const prizeCard = document.createElement('div');
                prizeCard.className = 'prize-card';
                
                const canAfford = currentUser && currentUser.points >= prize.points;
                
                prizeCard.innerHTML = `
                    <div class="prize-image">
                        <i class="fas ${prize.icon}"></i>
                    </div>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-points">${prize.points} 积分</div>
                    <button class="btn ${canAfford ? '' : 'disabled'}" 
                            ${canAfford ? '' : 'disabled'}
                            onclick="redeemPrize('${prize.id}')">
                        ${canAfford ? '立即兌換' : '積分不足'}
                    </button>
                `;
                
                prizesGrid.appendChild(prizeCard);
            });
        }
        
        // 兑换奖品
        function redeemPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            
            if (currentUser.points >= prize.points) {
                currentUser.points -= prize.points;
                
                // 记录积分变更历史
                pointsHistory.push({
                    userId: currentUser.id,
                    timestamp: new Date().getTime(),
                    pointsChange: -prize.points,
                    reason: `兌換獎品：${prize.name}`
                });
                
                // 检查成就
                checkAchievements(currentUser);
                
                // 保存数据
                saveDataToStorage();
                
                document.getElementById('dashboardUserPoints').textContent = currentUser.points;
                renderPrizes();
                showNotification(`成功兑换 ${prize.name}！`, 'success');
                
                // 如果用户在成就页面，刷新成就显示
                if (document.getElementById('achievements-tab').classList.contains('active')) {
                    renderAchievements();
                    updateAchievementStats();
                }
            } else {
                showNotification('積分不足，无法兑换該獎品', 'error');
            }
        }
        
        // 渲染用户表格 - 移除批量操作相关代码
        function renderUsersTable(searchTerm = '') {
            usersTableBody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = users.filter(user => 
                    user.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.barcodeCode.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.barcodeCode}</td>
                    <td>${user.points}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="selectUser('${user.id}')">选择</button>
                        ${!user.isAdmin ? 
                            `<button class="action-btn" style="background: #f39c12;" onclick="promoteUser('${user.id}')">升级为管理員</button>` : 
                            ''
                        }
                        <button class="action-btn" style="background: #e74c3c;" onclick="deleteUser('${user.id}')">移除人員</button>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            updateUserStats();
        }
        
        // 渲染奖品表格（管理员界面）
        function renderPrizesTable() {
            prizesTableBody.innerHTML = '';
            
            prizes.forEach(prize => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${prize.id}</td>
                    <td>${prize.name}</td>
                    <td>${prize.points}</td>
                    <td><i class="fas ${prize.icon}"></i> ${prize.icon}</td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="editPrize('${prize.id}')">编辑</button>
                        <button class="action-btn" style="background: #e74c3c;" onclick="deletePrize('${prize.id}')">移除人員</button>
                    </td>
                `;
                
                prizesTableBody.appendChild(row);
            });
        }
        
        // 渲染用户积分历史
        function renderUserHistory() {
            const userHistoryContent = document.getElementById('userHistoryContent');
            userHistoryContent.innerHTML = '';
            
            // 获取当前用户的历史记录
            const userHistory = pointsHistory
                .filter(record => record.userId === currentUser.id)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (userHistory.length === 0) {
                userHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            userHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                userHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染管理员查看的积分历史
        function renderAdminHistory(searchTerm = '') {
            const adminHistoryContent = document.getElementById('adminHistoryContent');
            adminHistoryContent.innerHTML = '';
            
            let filteredHistory = pointsHistory;
            
            // 如果提供了搜索条件，过滤历史记录
            if (searchTerm) {
                // 查找匹配的用户
                const matchedUsers = users.filter(u => 
                    u.id.includes(searchTerm) || 
                    u.name.includes(searchTerm) || 
                    u.barcodeCode.includes(searchTerm)
                );
                
                const matchedUserIds = matchedUsers.map(u => u.id);
                filteredHistory = pointsHistory.filter(record => 
                    matchedUserIds.includes(record.userId)
                );
            }
            
            // 按时间排序
            filteredHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredHistory.length === 0) {
                adminHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const user = users.find(u => u.id === record.userId);
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div><strong>${user ? user.name : '未知用户'} (${record.userId})</strong></div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                adminHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染用户排行榜 - 前三名更醒目
        function renderUserLeaderboard() {
            userLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                userLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                userLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染管理员排行榜 - 前三名更醒目
        function renderAdminLeaderboard() {
            adminLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                adminLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                adminLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染成就系统
        function renderAchievements() {
            achievementsGrid.innerHTML = '';
            
            if (!currentUser) return;
            
            // 检查并更新用户成就
            checkAchievements(currentUser);
            
            achievements.forEach(achievement => {
                // 获取成就数据
                const achievementData = achievement.getData ? achievement.getData(currentUser) : {};
                
                // 检查是否已解锁
                const isUnlocked = achievement.condition(currentUser, achievementData);
                const progress = achievement.progress ? achievement.progress(currentUser, achievementData) : (isUnlocked ? 100 : 0);
                
                const achievementCard = document.createElement('div');
                achievementCard.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
                
                achievementCard.innerHTML = `
                    <div class="achievement-icon">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="achievement-reward">獎勵: ${achievement.reward}</div>
                    
                    ${!isUnlocked ? `
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div class="achievement-progress-text">${progress.toFixed(0)}% 完成</div>
                    ` : ''}
                    
                    <div class="achievement-status ${isUnlocked ? 'achievement-unlocked' : 'achievement-locked'}">
                        ${isUnlocked ? '已解鎖' : '未解鎖'}
                    </div>
                `;
                
                // 添加解锁动画效果
                if (isUnlocked && !currentUser.achievementData[achievement.id]) {
                    achievementCard.style.animation = 'achievementUnlock 0.5s ease';
                    currentUser.achievementData[achievement.id] = true;
                    saveDataToStorage();
                }
                
                achievementsGrid.appendChild(achievementCard);
            });
            
            // 更新成就统计
            updateAchievementStats();
        }
        
        // 更新成就统计
        function updateAchievementStats() {
            if (!currentUser) return;
            
            const unlockedCount = achievements.filter(achievement => 
                achievement.condition(currentUser, achievement.getData ? achievement.getData(currentUser) : {})
            ).length;
            
            const totalCount = achievements.length;
            const progressPercentage = totalCount > 0 ? Math.round((unlockedCount / totalCount) * 100) : 0;
            
            document.getElementById('achievementUnlocked').textContent = unlockedCount;
            document.getElementById('achievementTotal').textContent = totalCount;
            document.getElementById('achievementProgress').textContent = `${progressPercentage}%`;
        }
        
        // 检查用户成就
        function checkAchievements(user) {
            let newAchievements = [];
            
            achievements.forEach(achievement => {
                const achievementData = achievement.getData ? achievement.getData(user) : {};
                const isUnlocked = achievement.condition(user, achievementData);
                
                if (isUnlocked && !user.achievements.includes(achievement.name)) {
                    user.achievements.push(achievement.name);
                    newAchievements.push(achievement.name);
                    
                    // 给予成就奖励
                    if (achievement.reward) {
                        const match = achievement.reward.match(/\+(\d+)/);
                        if (match) {
                            const rewardPoints = parseInt(match[1]);
                            user.points += rewardPoints;
                            user.totalPoints += rewardPoints;
                            
                            // 记录奖励
                            pointsHistory.push({
                                userId: user.id,
                                timestamp: new Date().getTime(),
                                pointsChange: rewardPoints,
                                reason: `成就獎勵: ${achievement.name}`
                            });
                            
                            // 更新段位
                            user.tier = calculateUserTier(user.totalPoints);
                        }
                    }
                }
            });
            
            // 如果有新成就，显示通知
            if (newAchievements.length > 0) {
                // 保存数据
                saveDataToStorage();
                
                // 如果当前用户是成就获得者，显示通知
                if (currentUser && currentUser.id === user.id) {
                    showNotification(`恭喜獲得新成就: ${newAchievements.join(', ')}`, 'success');
                    
                    // 如果用户在成就页面，刷新显示
                    if (document.getElementById('achievements-tab').classList.contains('active')) {
                        renderAchievements();
                        updateAchievementStats();
                    }
                }
            }
            
            return newAchievements;
        }
        
        // 渲染段位饼图 - 带动画效果，更圆润
        function renderTierPieChartWithAnimation(canvasElement, legendElement) {
            // 如果已有动画在进行，取消它
            if (pieChartAnimations[canvasElement.id]) {
                cancelAnimationFrame(pieChartAnimations[canvasElement.id]);
                delete pieChartAnimations[canvasElement.id];
            }
            
            // 统计各段位用户数量
            const tierCounts = {};
            tierThresholds.forEach(tier => {
                tierCounts[tier.name] = 0;
            });
            
            users.filter(u => !u.isAdmin).forEach(user => {
                tierCounts[user.tier]++;
            });
            
            // 过滤掉数量为0的段位
            const filteredTiers = tierThresholds.filter(tier => tierCounts[tier.name] > 0);
            
            // 计算总数
            const totalUsers = users.filter(u => !u.isAdmin).length;
            
            // 生成图例
            legendElement.innerHTML = '';
            filteredTiers.forEach(tier => {
                const percentage = totalUsers > 0 ? ((tierCounts[tier.name] / totalUsers) * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${tier.color};"></div>
                    <span>${tier.name}: ${tierCounts[tier.name]}人 (${percentage}%)</span>
                `;
                legendElement.appendChild(legendItem);
            });
            
            const ctx = canvasElement.getContext('2d');
            const width = canvasElement.width;
            const height = canvasElement.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 * 0.8;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 如果没有数据，显示提示
            if (totalUsers === 0) {
                ctx.fillStyle = '#ccc';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', centerX, centerY);
                return;
            }
            
            // 计算每个扇形的起始和结束角度
            let startAngle = -Math.PI / 2; // 从12点钟方向开始
            const slices = filteredTiers.map(tier => {
                const sliceAngle = (2 * Math.PI * tierCounts[tier.name]) / totalUsers;
                const slice = {
                    tier: tier,
                    startAngle: startAngle,
                    endAngle: startAngle + sliceAngle,
                    color: tier.color
                };
                startAngle += sliceAngle;
                return slice;
            });
            
            // 动画参数
            const duration = 1500; // 动画持续1500毫秒
            let startTime = null;
            
            // 动画函数
            function animate(currentTime) {
                if (!startTime) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1); // 0到1
                
                // 当前角度从0到2PI
                const currentAngle = progress * 2 * Math.PI;
                
                // 清除画布
                ctx.clearRect(0, 0, width, height);
                
                // 绘制每个扇形
                slices.forEach(slice => {
                    // 如果当前角度大于这个扇形的起始角度，则绘制
                    if (currentAngle > slice.startAngle + Math.PI / 2) {
                        const start = slice.startAngle;
                        const end = Math.min(currentAngle - Math.PI / 2, slice.endAngle);
                        
                        if (end > start) {
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            ctx.arc(centerX, centerY, radius, start, end);
                            ctx.closePath();
                            ctx.fillStyle = slice.color;
                            ctx.fill();
                            
                            // 绘制分隔线
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                });
                
                // 如果动画未完成，继续
                if (progress < 1) {
                    pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
                } else {
                    // 动画完成，绘制中心圆和文字
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('段位分布', centerX, centerY - 8);
                    ctx.font = '14px Arial';
                    ctx.fillText(`${totalUsers}人`, centerX, centerY + 10);
                    
                    // 动画完成，清除动画ID
                    delete pieChartAnimations[canvasElement.id];
                }
            }
            
            // 启动动画
            pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
        }
        
        // 选择用户
        function selectUser(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('searchUser').value = user.id;
        }
        
        // 升级用户为管理员
        function promoteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.isAdmin = true;
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification(`已将 ${user.name} 升級為管理員`, 'success');
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？此操作不可撤銷。')) {
                users = users.filter(u => u.id !== userId);
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification('用户已删除', 'success');
            }
        }
        
        // 编辑奖品
        function editPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            if (prize) {
                document.getElementById('editPrizeId').value = prize.id;
                document.getElementById('editPrizeName').value = prize.name;
                document.getElementById('editPrizePoints').value = prize.points;
                document.getElementById('editPrizeIcon').value = prize.icon;
                
                editPrizeModal.style.display = 'flex';
            }
        }
        
        // 删除奖品
        function deletePrize(prizeId) {
            if (confirm('确定要删除这个獎品吗？此操作不可撤銷。')) {
                prizes = prizes.filter(p => p.id !== prizeId);
                
                // 保存数据
                saveDataToStorage();
                
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                showNotification('獎品已删除', 'success');
            }
        }
        
        // 更新用户统计信息 - 使用累积积分
        function updateUserStats() {
            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalPoints = users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0);
            
            // 使用累积积分统计各段位用户数量
            const activeUsers = users.filter(u => !u.isAdmin && u.totalPoints >= 1500).length;
            const activeUser4 = users.filter(u => !u.isAdmin && u.totalPoints >= 1200 && u.totalPoints < 1500).length;
            const activeUser3 = users.filter(u => !u.isAdmin && u.totalPoints >= 900 && u.totalPoints < 1200).length;
            const activeUser2 = users.filter(u => !u.isAdmin && u.totalPoints >= 600 && u.totalPoints < 900).length;
            const activeUser1 = users.filter(u => !u.isAdmin && u.totalPoints >= 300 && u.totalPoints < 600).length;
            const activeUser0 = users.filter(u => !u.isAdmin && u.totalPoints < 300).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('activeUser4').textContent = activeUser4;
            document.getElementById('activeUser3').textContent = activeUser3;
            document.getElementById('activeUser2').textContent = activeUser2;
            document.getElementById('activeUser1').textContent = activeUser1;
            document.getElementById('activeUser0').textContent = activeUser0;
        }
        
        // 更新系统统计信息
        function updateSystemStats() {
            document.getElementById('systemUsers').textContent = users.filter(u => !u.isAdmin).length;
            document.getElementById('systemPrizes').textContent = prizes.length;
            document.getElementById('systemHistory').textContent = pointsHistory.length;
            document.getElementById('systemAdmins').textContent = users.filter(u => u.isAdmin).length;
            
            updateUserStats();
        }
        
        // 导出用户数据
        function exportUsersData() {
            const dataStr = JSON.stringify(users.filter(u => !u.isAdmin), null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('用户數據導出成功', 'success');
        }
        
        // 导出奖品数据
        function exportPrizesData() {
            const dataStr = JSON.stringify(prizes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'prizes_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('獎品數據導出成功', 'success');
        }
        
        // 导出历史数据
        function exportHistoryData() {
            const dataStr = JSON.stringify(pointsHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'history_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('歷史數據導出成功', 'success');
        }
        
        // 导出所有数据
        function exportAllData() {
            const allData = {
                users: users,
                prizes: prizes,
                history: pointsHistory,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'barcode_system_backup.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('系統數據備份成功', 'success');
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.users && Array.isArray(importedData.users)) {
                        users = importedData.users;
                        
                        // 确保导入的用户数据有累积积分和段位字段
                        users.forEach(user => {
                            if (user.totalPoints === undefined) {
                                user.totalPoints = user.points || 0;
                            }
                            if (user.tier === undefined) {
                                user.tier = calculateUserTier(user.totalPoints);
                            }
                            if (user.achievements === undefined) {
                                user.achievements = [];
                            }
                            if (user.achievementData === undefined) {
                                user.achievementData = {};
                            }
                            
                            // 检查成就
                            checkAchievements(user);
                        });
                    }
                    
                    if (importedData.prizes && Array.isArray(importedData.prizes)) {
                        prizes = importedData.prizes;
                    }
                    
                    if (importedData.history && Array.isArray(importedData.history)) {
                        pointsHistory = importedData.history;
                    }
                    
                    saveDataToStorage();
                    renderUsersTable();
                    renderPrizesTable();
                    renderPrizes();
                    updateSystemStats();
                    
                    showNotification('數據導入成功', 'success');
                } catch (error) {
                    showNotification('數據導入失败：文件格式錯誤', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入
            event.target.value = '';
        }
        
        // 修改管理员密码
        function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('請填寫所有密碼字段', 'error');
                return;
            }
            
            if (currentPassword !== adminPassword) {
                showNotification('當前密碼錯誤', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('新密碼和确认密碼不匹配', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('新密码长度至少6位', 'error');
                return;
            }
            
            // 在实际应用中，这里应该将新密码保存到安全的地方
            // 由于这是前端演示，我们无法真正修改硬编码的密码
            // 但可以保存到localStorage作为演示
            localStorage.setItem('adminNewPassword', newPassword);
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('密码修改需到代碼層尋找*****', 'success');
        }
        
        // 重置系统数据
        function resetSystemData() {
            if (confirm('确定要重置所有系統數據吗？此操作将删除所有用户、獎品和歷史紀錄，且不可恢复！')) {
                users = [
                    { 
                        id: 'wwlwcf002', 
                        name: '管理员', 
                        barcodeCode: 'wwlwcf002', 
                        points: 0, 
                        totalPoints: 0,
                        tier: '',
                        isAdmin: true,
                        achievements: [],
                        achievementData: {}
                    }
                ];
                prizes = [];
                pointsHistory = [];
                
                saveDataToStorage();
                renderUsersTable();
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                showNotification('系統數據已重置', 'success');
            }
        }
        
        // 生成随机用户ID
        function generateUserId() {
            const prefix = 'U';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机条形码编码
        function generateBarcodeCode() {
            const prefix = 'USER';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机奖品ID
        function generatePrizeId() {
            const prefix = 'P';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 保存数据到本地存储
        function saveDataToStorage() {
            localStorage.setItem('barcodePointsUsers', JSON.stringify(users));
            localStorage.setItem('barcodePointsPrizes', JSON.stringify(prizes));
            localStorage.setItem('barcodePointsHistory', JSON.stringify(pointsHistory));
        }
        
        // 显示通知
        function showNotification(message, type) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = '#2ecc71';
            } else if (type === 'error') {
                notification.style.background = '#e74c3c';
            } else {
                notification.style.background = '#3498db';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 确保JsBarcode库已加载
        function checkBarcodeLibrary() {
            if (typeof JsBarcode === 'undefined') {
                console.error('JsBarcode库未正确加载');
                // 尝试重新加载
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js';
                script.onload = function() {
                    console.log('JsBarcode库重新加载成功');
                    initPage();
                };
                document.head.appendChild(script);
            } else {
                console.log('JsBarcode库已加载');
                initPage();
            }
        }

        // 在页面加载时检查
        window.addEventListener('load', function() {
            checkBarcodeLibrary();
        });
    </script>
</body>
</html>            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background: linear-gradient(135deg, #a6d1ff 0%, #c2e9fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: #333;
        }
        
        body.theme-dark {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-color);
        }
        
        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .loader-content {
            text-align: center;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(37, 117, 252, 0.3);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 落叶动画效果 */
        .leaf {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ffd700;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            opacity: 0.7;
            animation: falling linear infinite;
            z-index: 0;
        }
        
        @keyframes falling {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* 玻璃水滴型卡片设计 */
        .card {
            background: var(--glass-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .card {
            background: var(--card-bg);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.5) 0%, rgba(106, 17, 203, 0.5) 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .card-header i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .card:hover .card-header i {
            transform: scale(1.1);
        }
        
        .card-header h2 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .theme-dark .card-header h2 {
            color: var(--text-color);
        }
        
        .login-section {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .login-card {
            flex: 1;
            min-width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .form-group label {
            color: #ccc;
        }
        
        /* 玻璃水滴型输入框 */
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
        }
        
        .theme-dark .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }
        
        .form-control:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .form-control:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 层次感按钮设计 */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:hover::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #1a68e8 0%, #5a0fb5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 117, 252, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(37, 117, 252, 0.4);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, #219955 100%);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d35400 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400 0%, #ba4a00 100%);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7a7d 100%);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }
        
        .barcode-scan {
            text-align: center;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .barcode-scan:hover {
            border-color: rgba(37, 117, 252, 0.7);
            background: rgba(37, 117, 252, 0.1);
        }
        
        .barcode-scan i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        
        .barcode-scan:hover i {
            transform: scale(1.1);
        }
        
        .barcode-scan p {
            color: #666;
            font-size: 16px;
        }
        
        .theme-dark .barcode-scan p {
            color: #ccc;
        }
        
        .dashboard {
            display: none;
        }
        
        .user-info {
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.7) 0%, rgba(106, 17, 203, 0.7) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .user-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .points {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: var(--dark);
        }
        
        .theme-dark .tab {
            color: var(--text-color);
        }
        
        .tab.active {
            border-bottom: 3px solid rgba(37, 117, 252, 0.7);
            color: var(--primary);
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .prize-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .prize-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .prize-image {
            width: 100%;
            height: 150px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .theme-dark .prize-image {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover .prize-image {
            transform: scale(1.05);
        }
        
        .prize-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .prize-points {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .admin-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .users-table, .history-table, .prizes-table, .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th, .users-table td,
        .history-table th, .history-table td,
        .prizes-table th, .prizes-table td,
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        
        .users-table th, .history-table th, .prizes-table th, .leaderboard-table th {
            background: rgba(248, 249, 250, 0.5);
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .users-table th, 
        .theme-dark .history-table th, 
        .theme-dark .prizes-table th, 
        .theme-dark .leaderboard-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }
        
        .users-table tr:hover, .history-table tr:hover, .prizes-table tr:hover, .leaderboard-table tr:hover {
            background: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .users-table tr:hover, 
        .theme-dark .history-table tr:hover, 
        .theme-dark .prizes-table tr:hover, 
        .theme-dark .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .action-btn {
            padding: 6px 12px;
            margin-right: 5px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        /* 更醒目的成就解锁通知 */
        .achievement-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px 40px;
            background: linear-gradient(135deg, #ffd700 0%, #ff9500 100%);
            color: #000;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 0 50px rgba(255, 215, 0, 0.5);
            display: none;
            z-index: 9999;
            animation: achievementPopup 0.6s ease-out, achievementFloat 3s ease-in-out 0.6s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 3px solid #fff;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .achievement-notification.unlocked {
            display: block;
        }
        
        .achievement-notification h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #000;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .achievement-notification p {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
        }
        
        .achievement-notification .reward {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            margin-top: 10px;
        }
        
        .achievement-notification-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ff0000;
            animation: achievementIconSpin 1s ease-in-out 1.5s;
        }
        
        @keyframes achievementPopup {
            0% {
                transform: translate(-50%, -50%) scale(0.1);
                opacity: 0;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes achievementFloat {
            0% {
                transform: translate(-50%, -50%);
            }
            25% {
                transform: translate(-50%, -55%);
            }
            50% {
                transform: translate(-50%, -50%);
            }
            75% {
                transform: translate(-50%, -52%);
            }
            100% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        
        @keyframes achievementIconSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.3);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .modal-content {
            background: var(--card-bg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .modal-header h3 {
            color: var(--dark);
            font-size: 1.5rem;
        }
        
        .theme-dark .modal-header h3 {
            color: var(--text-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--dark);
        }
        
        .theme-dark .close-btn:hover {
            color: var(--text-color);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            transition: background-color 0.2s;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .history-item:hover {
            background-color: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .history-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-points {
            font-weight: bold;
        }
        
        .points-positive {
            color: var(--success);
        }
        
        .points-negative {
            color: var(--danger);
        }
        
        .barcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
        }
        
        .theme-dark .barcode-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .barcode-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: white;
        }
        
        .barcode-placeholder {
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .theme-dark .barcode-placeholder {
            color: #ccc;
        }
        
        .scan-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .theme-dark #scanner-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .scan-line {
            width: 80%;
            height: 2px;
            background: var(--primary);
            position: relative;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: -50%; }
            100% { top: 150%; }
        }
        
        .scan-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-barcode {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }
        
        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* 玻璃水滴型登录选项按钮 */
        .login-option-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .login-option-btn {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .login-option-btn.active {
            background: rgba(37, 117, 252, 0.3);
            color: white;
            border-color: rgba(37, 117, 252, 0.5);
        }
        
        .login-option-btn:hover {
            background: rgba(37, 117, 252, 0.2);
            transform: translateY(-2px);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .data-management {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-management .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .stat-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .stat-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .theme-dark .stat-label {
            color: #ccc;
        }
        
        /* 优化选项框样式 - 更圆滑、半透明 */
        .reason-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }
        
        .theme-dark .reason-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .reason-select:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .reason-select:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .reason-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: inherit;
        }
        
        .theme-dark .reason-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-tier {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .tier-king {
            background-color: #ffd900;
            color: #000;
        }
        
        .tier-diamond {
            background-color: #9035F8;
            color: white;
        }
        
        .tier-platinum {
            background-color: #75c8ff;
            color: #000;
        }
        
        .tier-gold {
            background-color: #ff8904;
            color: white;
        }
        
        .tier-silver {
            background-color: #5fecfc;
            color: #000;
        }
        
        .tier-bronze {
            background-color: brown;
            color: white;
        }
        
        /* 排行榜样式 - 前三名更醒目 */
        .leaderboard-container {
            display: flex;
            gap: 25px;
            margin-top: 20px;
        }
        
        .leaderboard-table-container {
            flex: 2;
        }
        
        .leaderboard-table tr.top-three {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-left: 4px solid #ffd700;
        }
        
        .leaderboard-table tr:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.15) 100%);
            border-left: 4px solid #ffd700;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(192, 192, 192, 0.15) 100%);
            border-left: 4px solid #c0c0c0;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(205, 127, 50, 0.15) 100%);
            border-left: 4px solid #cd7f32;
            font-weight: bold;
        }
        
        .theme-dark .leaderboard-table tr:nth-child(1),
        .theme-dark .leaderboard-table tr:nth-child(2),
        .theme-dark .leaderboard-table tr:nth-child(3) {
            color: white;
        }
        
        .pie-chart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .pie-chart-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .pie-chart {
            width: 250px;
            height: 250px;
            position: relative;
        }
        
        .pie-chart canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* 成就系统样式 */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .achievement-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .achievement-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(50%);
        }
        
        .achievement-card.unlocked {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }
        
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .achievement-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 32px;
            color: white;
            transition: transform 0.3s ease;
        }
        
        .achievement-card:hover .achievement-icon {
            transform: scale(1.1) rotate(10deg);
        }
        
        .achievement-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .theme-dark .achievement-name {
            color: var(--text-color);
        }
        
        .achievement-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .theme-dark .achievement-description {
            color: #ccc;
        }
        
        .achievement-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .achievement-unlocked {
            background: var(--success);
            color: white;
        }
        
        .achievement-locked {
            background: #95a5a6;
            color: white;
        }
        
        .achievement-progress {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .achievement-progress-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .theme-dark .achievement-progress-text {
            color: #ccc;
        }
        
        .achievement-reward {
            margin-top: 10px;
            color: var(--warning);
            font-weight: 600;
        }
        
        /* 动画定义 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes achievementUnlock {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 0 30px rgba(46, 204, 113, 0.8); }
            100% { transform: scale(1); }
        }
        
        /* 新增的颜色设定 */
        #activeUsers,
        #activeUsers + .stat-label {
            color: #ffd900; /* 王者用户 */
        }

        #activeUser4,
        #activeUser4 + .stat-label {
            color: #9035F8; /* 钻石用户 */
        }

        #activeUser3,
        #activeUser3 + .stat-label {
            color: #75c8ff; /* 铂金用户 */
        }

        #activeUser2,
        #activeUser2 + .stat-label {
            color: #ff8904; /* 黄金用户 */
        }

        #activeUser1,
        #activeUser1 + .stat-label {
            color: #5fecfc; /* 白银用户 */
        }

        #activeUser0,
        #activeUser0 + .stat-label {
            color: brown; /* 青铜用户 */
        }
        
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* 徽章样式 */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .login-section {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .prizes-grid {
                grid-template-columns: 1fr;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .users-table, .history-table, .prizes-table, .leaderboard-table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .login-options {
                flex-direction: column;
            }
            
            .data-management {
                flex-direction: column;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-container {
                flex-direction: column;
            }
            
            .pie-chart {
                width: 200px;
                height: 200px;
            }
            
            .achievement-notification {
                padding: 20px 25px;
            }
            
            .achievement-notification h3 {
                font-size: 1.5rem;
            }
            
            .achievement-notification p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h3>加載中...</h3>
            <p>正在初始化系統</p>
        </div>
    </div>
    
    <!-- 成就解锁通知 -->
    <div class="achievement-notification" id="achievementNotification">
        <div class="achievement-notification-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <h3>成就解鎖！</h3>
        <p id="achievementNotificationName">成就名稱</p>
        <p id="achievementNotificationDesc">成就描述</p>
        <div class="reward" id="achievementNotificationReward">獎勵: +0積分</div>
    </div>
    
    <!-- 落叶动画元素 -->
    <div id="leaves-container"></div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <h1>明馬二樓宿舍積分兌換系統</h1>
            <p>明愛馬鞍山中學二樓宿舍專用</p>
        </div>
        
        <!-- 登陸區域 -->
        <div class="login-section" id="loginSection">
            <!-- 用戶登錄 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user"></i>
                    <h2>用戶登錄</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="userCodeLoginBtn">用戶編號登陸</div>
                    <div class="login-option-btn" id="userBarcodeLoginBtn">QRcode登陸</div>
                </div>
                
                <div id="userCodeLoginForm">
                    <div class="form-group">
                        <label for="userIdInput">用戶編號</label>
                        <input type="text" id="userIdInput" class="form-control" placeholder="輸入用戶編號">
                    </div>
                    <button class="btn btn-block" id="userLoginBtn">用戶登錄</button>
                </div>
                
                <div id="userBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="userBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
                
                <div class="user-info" style="display: none;" id="userInfo">
                    <div>
                        <h3 id="userName">张三</h3>
                        <p>用户编号: <span id="userId">U1001</span></p>
                    </div>
                    <div class="points" id="userPoints">1500</div>
                </div>
            </div>
            
            <!-- 管理员登录 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user-shield"></i>
                    <h2>管理员登录</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="adminCodeLoginBtn">管理員編號登陸</div>
                    <div class="login-option-btn" id="adminBarcodeLoginBtn">管理員QRcode登陸</div>
                </div>
                
                <div id="adminCodeLoginForm">
                    <div class="form-group">
                        <label for="adminId">管理員編號</label>
                        <input type="text" id="adminId" class="form-control" placeholder="輸入管理員編號">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">管理員密碼</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="請輸入管理員密碼">
                    </div>
                    
                    <button class="btn btn-block" id="adminLoginBtn">管理員登陸</button>
                </div>
                
                <div id="adminBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="adminBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户仪表盘 -->
        <div class="dashboard card" id="userDashboard">
            <div class="card-header">
                <i class="fas fa-gift"></i>
                <h2>積分兌換中心</h2>
            </div>
            
            <div class="user-info">
                <div>
                    <h3 id="dashboardUserName">张三</h3>
                    <p>用戶編號: <span id="dashboardUserId">U1001</span></p>
                    <p>QRcode編碼: <span id="dashboardUserBarcode">BARCODE001</span></p>
                    <p>段位: <span id="dashboardUserTier">青銅</span></p>
                </div>
                <div>
                    <div class="points" id="dashboardUserPoints">1500</div>
                    <div style="text-align: right;">累積積分: <span id="dashboardUserTotalPoints">2500</span></div>
                </div>
            </div>
            
            <div class="user-barcode">
                <h4>我的QRcode</h4>
                <div id="userBarcodeDisplay"></div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="prizes">獎品兌換</div>
                <div class="tab" data-tab="history">積分歷史</div>
                <div class="tab" data-tab="leaderboard">排行榜</div>
                <div class="tab" data-tab="achievements">成就系統</div>
            </div>
            
            <div class="tab-content active" id="prizes-tab">
                <h3 style="margin-bottom: 15px;">可用獎品</h3>
                <div class="prizes-grid" id="prizesGrid">
                    <!-- 奖品将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <h3 style="margin-bottom: 15px;">積分歷史紀錄</h3>
                <div id="userHistoryContent">
                    <!-- 用户积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="userLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="tierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="pieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="achievements-tab">
                <h3 style="margin-bottom: 15px;">成就系統</h3>
                <div class="user-stats" style="margin-bottom: 25px;">
                    <div class="stat-card">
                        <div class="stat-value" id="achievementUnlocked">0</div>
                        <div class="stat-label">已解鎖成就</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementTotal">0</div>
                        <div class="stat-label">總成就數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementProgress">0%</div>
                        <div class="stat-label">成就進度</div>
                    </div>
                </div>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- 成就将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="userLogoutBtn">退出登陸</button>
        </div>
        
        <!-- 管理员仪表盘 -->
        <div class="dashboard card" id="adminDashboard">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <h2>積分管理系統</h2>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="users">用戶管理</div>
                <div class="tab" data-tab="prizes-admin">獎品管理</div>
                <div class="tab" data-tab="history-admin">積分歷史</div>
                <div class="tab" data-tab="leaderboard-admin">排行榜</div>
                <div class="tab" data-tab="system-admin">系統管理</div>
            </div>
            
            <div class="tab-content active" id="users-tab">
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">總積分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">👑👑👑王者用戶🏅️🏅️🏅️</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser4">0</div>
                        <div class="stat-label">💎鑽石用戶💎</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser3">0</div>
                        <div class="stat-label">💍鉑金用戶💍</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser2">0</div>
                        <div class="stat-label">✨黃金用戶✨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser1">0</div>
                        <div class="stat-label">🥈白銀用戶🥈</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser0">0</div>
                        <div class="stat-label">.🔥青銅用戶🔥.</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchUser" class="form-control" placeholder="輸入用戶編號·姓名或QRcode編碼">
                    <button class="btn" id="searchUserBtn">搜索</button>
                    <button class="btn btn-secondary" id="clearSearchBtn">清除</button>
                </div>
                
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="pointsChange">積分變更</label>
                        <input type="number" id="pointsChange" class="form-control" placeholder="輸入積分變更值">
                    </div>
                    <div class="form-group">
                        <label for="pointsReason">變更原因</label>
                        <select id="pointsReason" class="reason-select">
                            <option value="">-- 選擇原因 --</option>
                            <option value="任務獎勵">任務獎勵</option>
                            <option value="活動獎勵">活動獎勵</option>
                            <option value="挑戰獎勵">挑戰獎勵</option>
                            <option value="閱讀獎勵">閱讀獎勵</option>
                            <option value="管理員調整">管理員調整</option>
                            <option value="其他">其他</option>
                        </select>
                        <input type="text" id="customReason" class="reason-input" placeholder="輸入其他原因" style="display: none;">
                    </div>
                    <button class="btn" id="updatePointsBtn" style="align-self: flex-end;">更新積分</button>
                    <button class="btn btn-success" id="addUserBtn" style="align-self: flex-end;">添加用戶</button>
                    <button class="btn btn-info" id="exportUsersBtn" style="align-self: flex-end;">導出用戶</button>
                </div>
                
                <h3>用戶列表</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>用戶編號</th>
                            <th>姓名</th>
                            <th>QRcode編碼</th>
                            <th>當前積分</th>
                            <th>累積積分</th>
                            <th>段位</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- 用户数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="prizes-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="prizeName">獎品名稱</label>
                        <input type="text" id="prizeName" class="form-control" placeholder="輸入獎品名稱">
                    </div>
                    <div class="form-group">
                        <label for="prizePoints">所需積分</label>
                        <input type="number" id="prizePoints" class="form-control" placeholder="輸入所需積分" min="1">
                    </div>
                    <div class="form-group">
                        <label for="prizeIcon">圖標</label>
                        <input type="text" id="prizeIcon" class="form-control" placeholder="輸入FontAwesome圖標名稱" value="fa-gift">
                    </div>
                    <button class="btn btn-success" id="addPrizeBtn" style="align-self: flex-end;">添加獎品</button>
                    <button class="btn btn-info" id="exportPrizesBtn" style="align-self: flex-end;">導出獎品</button>
                </div>
                
                <h3>獎品列表</h3>
                <table class="prizes-table">
                    <thead>
                        <tr>
                            <th>獎品ID</th>
                            <th>獎品名稱</th>
                            <th>所需積分</th>
                            <th>圖標</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="prizesTableBody">
                        <!-- 奖品数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="history-admin-tab">
                <div class="search-box">
                    <input type="text" id="searchHistoryUser" class="form-control" placeholder="輸入用戶編號、姓名或QRcode編碼">
                    <button class="btn" id="searchHistoryBtn">搜索歷史紀錄</button>
                    <button class="btn btn-secondary" id="clearHistorySearchBtn">清除</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="exportHistoryBtn">導出歷史紀錄</button>
                    <button class="btn btn-warning" id="clearHistoryBtn">清空歷史紀錄</button>
                </div>
                
                <h3>積分歷史紀錄</h3>
                <div id="adminHistoryContent">
                    <!-- 管理员查看的积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-admin-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="adminLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="adminTierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="adminPieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="system-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="currentPassword">當前密碼</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="輸入當前密碼">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密碼</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="輸入新密碼">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">確認新密碼</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="再次輸入新密碼">
                    </div>
                    <button class="btn btn-warning" id="changePasswordBtn" style="align-self: flex-end;">修改密碼</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="importDataBtn">導入歷史數據</button>
                    <button class="btn btn-success" id="exportDataBtn">導出所有數據</button>
                    <button class="btn btn-danger" id="resetDataBtn">重置所有數據</button>
                </div>
                
                <div class="form-group">
                    <label for="dataFile">選擇數據文件 (JSON格式)</label>
                    <input type="file" id="dataFile" class="form-control" accept=".json">
                </div>
                
                <h3>系统信息</h3>
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="systemUsers">0</div>
                        <div class="stat-label">用戶數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemPrizes">0</div>
                        <div class="stat-label">獎品數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemHistory">0</div>
                        <div class="stat-label">歷史紀錄</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemAdmins">0</div>
                        <div class="stat-label">管理員數量</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="adminLogoutBtn">退出登陸</button>
        </div>
    </div>
    
    <!-- 添加用户模态框 -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新用戶</h3>
                <button class="close-btn" id="closeAddUserModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newUserName">用户姓名</label>
                <input type="text" id="newUserName" class="form-control" placeholder="請輸入用户姓名">
            </div>
            <div class="form-group">
                <label for="newUserId">用户編號</label>
                <input type="text" id="newUserId" class="form-control" placeholder="請輸入用户編號">
            </div>
            <div class="form-group">
                <label for="newUserPoints">初始積分</label>
                <input type="number" id="newUserPoints" class="form-control" value="0" min="0">
            </div>
            <div class="form-group">
                <label>生成的QRcode編碼: <span id="generatedBarcodeCode">BARCODE001</span></label>
            </div>
            <div class="barcode-container" id="newUserBarcode"></div>
            <button class="btn btn-success btn-block" id="confirmAddUser">確認添加用户</button>
        </div>
    </div>
    
    <!-- 编辑奖品模态框 -->
    <div class="modal" id="editPrizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯獎品</h3>
                <button class="close-btn" id="closeEditPrizeModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editPrizeName">獎品名稱</label>
                <input type="text" id="editPrizeName" class="form-control" placeholder="請輸入獎品名稱">
            </div>
            <div class="form-group">
                <label for="editPrizePoints">所需積分</label>
                <input type="number" id="editPrizePoints" class="form-control" placeholder="請輸入所需積分" min="1">
            </div>
            <div class="form-group">
                <label for="editPrizeIcon">圖標類名</label>
                <input type="text" id="editPrizeIcon" class="form-control" placeholder="輸入FontAwesome圖標類名">
            </div>
            <input type="hidden" id="editPrizeId">
            <button class="btn btn-success btn-block" id="confirmEditPrize">确认修改</button>
        </div>
    </div>
    
    <!-- 条形码扫描模态框 -->
    <div class="modal" id="barcodeScannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>掃描QRcode</h3>
                <button class="close-btn" id="closeScannerModal">&times;</button>
            </div>
            <div class="scan-area">
                <div id="scanner-container">
                    <!-- 摄像头预览将在这里显示 -->
                </div>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div class="scan-controls">
                <button class="btn" id="startScannerBtn">開始掃描</button>
                <button class="btn btn-danger" id="stopScannerBtn" style="display: none;">停止掃描</button>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>掃描結果: <span id="scanResult">等待掃描...</span></label>
            </div>
            <button class="btn btn-success btn-block" id="confirmScanBtn" style="display: none;">確認此QRcode編碼正確？</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // 创建落叶效果
        function createLeaves() {
            const leavesContainer = document.getElementById('leaves-container');
            const leafCount = 15; // 落叶数量
            
            for (let i = 0; i < leafCount; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                
                // 随机位置
                const left = Math.random() * 100;
                leaf.style.left = left + 'vw';
                
                // 随机大小
                const size = 15 + Math.random() * 20;
                leaf.style.width = size + 'px';
                leaf.style.height = size + 'px';
                
                // 随机动画延迟和持续时间
                const delay = Math.random() * 10;
                const duration = 5 + Math.random() * 10;
                leaf.style.animationDelay = delay + 's';
                leaf.style.animationDuration = duration + 's';
                
                leavesContainer.appendChild(leaf);
            }
        }
        
        // 用户数据存储
        let users = JSON.parse(localStorage.getItem('barcodePointsUsers')) || [
            { 
                id: 'U1001', 
                name: '张三', 
                barcodeCode: 'USER001', 
                points: 1500, 
                totalPoints: 2500,
                tier: '鉑金',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅', '大佬帶帶我'],
                achievementData: {}
            },
            { 
                id: 'U1002', 
                name: '李四', 
                barcodeCode: 'USER002', 
                points: 800, 
                totalPoints: 1200,
                tier: '黃金',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅'],
                achievementData: {}
            },
            { 
                id: 'U1003', 
                name: '王五', 
                barcodeCode: 'USER003', 
                points: 2200, 
                totalPoints: 3200,
                tier: '鑽石',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅', '中等貴族✨', '大佬帶帶我'],
                achievementData: {}
            },
            { 
                id: 'wwlwcf002', 
                name: '管理员', 
                barcodeCode: 'wwlwcf002', 
                points: 0, 
                totalPoints: 0,
                tier: '',
                isAdmin: true,
                achievements: [],
                achievementData: {}
            }
        ];
        
        // 奖品数据存储
        let prizes = JSON.parse(localStorage.getItem('barcodePointsPrizes')) || [
            { id: 'P001', name: '咖啡券', points: 200, icon: 'fa-mug-hot' },
            { id: 'P002', name: '电影票', points: 500, icon: 'fa-film' },
            { id: 'P003', name: '蓝牙耳机', points: 1500, icon: 'fa-headphones' },
            { id: 'P004', name: '智能手表', points: 3000, icon: 'fa-clock' },
            { id: 'P005', name: '平板电脑', points: 5000, icon: 'fa-tablet-alt' },
            { id: 'P006', name: '购物卡', points: 1000, icon: 'fa-shopping-bag' }
        ];
        
        // 积分历史记录存储
        let pointsHistory = JSON.parse(localStorage.getItem('barcodePointsHistory')) || [
            { userId: 'U1001', timestamp: new Date('2023-10-01 09:30:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-05 14:20:00').getTime(), pointsChange: -200, reason: '兑换咖啡券' },
            { userId: 'U1001', timestamp: new Date('2023-10-10 11:15:00').getTime(), pointsChange: 500, reason: '活动奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-15 15:40:00').getTime(), pointsChange: 800, reason: '管理员调整' },
            { userId: 'U1002', timestamp: new Date('2023-10-02 10:45:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1002', timestamp: new Date('2023-10-07 16:30:00').getTime(), pointsChange: 300, reason: '完成任务' },
            { userId: 'U1003', timestamp: new Date('2023-10-03 08:20:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-08 13:10:00').getTime(), pointsChange: 1000, reason: '推荐用户奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-12 17:25:00').getTime(), pointsChange: 400, reason: '活动奖励' }
        ];
        
        // 修改后的成就系统
        const achievements = [
            { 
                id: 'new_user', 
                name: '新手求帶！😭', 
                description: '積分達到100分', 
                icon: 'fa-baby', 
                reward: '+20積分',
                condition: (user, data) => user.totalPoints >= 100,
                progress: (user, data) => Math.min(100, (user.totalPoints / 100) * 100)
            },
            { 
                id: 'points_collector_1', 
                name: '低等貴族🫅', 
                description: '累積積分達到500點', 
                icon: 'fa-crown', 
                reward: '+100積分',
                condition: (user, data) => user.totalPoints >= 500,
                progress: (user, data) => Math.min(100, (user.totalPoints / 500) * 100)
            },
            { 
                id: 'points_collector_2', 
                name: '中等貴族✨', 
                description: '累積積分達到1200點', 
                icon: 'fa-gem', 
                reward: '+200積分',
                condition: (user, data) => user.totalPoints >= 1200,
                progress: (user, data) => Math.min(100, (user.totalPoints / 1200) * 100)
            },
            { 
                id: 'points_collector_3', 
                name: '💎高等貴族💎', 
                description: '累積積分達到2000點', 
                icon: 'fa-diamond', 
                reward: '+300積分',
                condition: (user, data) => user.totalPoints >= 2000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 2000) * 100)
            },
            { 
                id: 'points_collector_4', 
                name: '👑全服之王👑', 
                description: '累積積分達到3000點',
                icon: 'fa-trophy', 
                reward: '+500積分',
                condition: (user, data) => user.totalPoints >= 3000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 3000) * 100)
            },
            { 
                id: 'tier_master', 
                name: '大佬帶帶我', 
                description: '達到鉑金段位', 
                icon: 'fa-star', 
                reward: '+100積分',
                condition: (user, data) => user.tier === '鉑金' || user.tier === '鑽石' || user.tier === '王者',
                progress: (user, data) => {
                    const tiers = ['青銅', '白銀', '黃金', '鉑金', '鑽石', '王者'];
                    const currentIndex = tiers.indexOf(user.tier);
                    return Math.min(100, ((currentIndex + 1) / 4) * 100);
                }
            },
            { 
                id: 'exchange_expert', 
                name: '兄弟手頭有點緊啊～', 
                description: '成功兌換5次獎品', 
                icon: 'fa-gift', 
                reward: '+100積分',
                condition: (user, data) => {
                    if (!data || !data.exchangeCount) return false;
                    return data.exchangeCount >= 5;
                },
                progress: (user, data) => {
                    const exchangeCount = data && data.exchangeCount ? data.exchangeCount : 0;
                    return Math.min(100, (exchangeCount / 5) * 100);
                },
                getData: (user) => {
                    const exchangeCount = pointsHistory.filter(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    ).length;
                    return { exchangeCount };
                }
            },
            { 
                id: 'activity_king', 
                name: '活躍之王🤭', 
                description: '每個月有加過積分', // 修改为每个月有加过积分
                icon: 'fa-fire', 
                reward: '+25積分', // 修改为25分
                condition: (user, data) => {
                    if (!data || !data.recentMonthPoints) return false;
                    return data.recentMonthPoints;
                },
                progress: (user, data) => {
                    const recentMonthPoints = data && data.recentMonthPoints ? data.recentMonthPoints : false;
                    return recentMonthPoints ? 100 : 0;
                },
                getData: (user) => {
                    const userHistory = pointsHistory
                        .filter(h => h.userId === user.id && h.pointsChange > 0)
                        .sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (userHistory.length === 0) return { recentMonthPoints: false };
                    
                    // 获取最近30天内的记录
                    const thirtyDaysAgo = new Date().getTime() - (30 * 24 * 60 * 60 * 1000);
                    const recentMonthPoints = userHistory.some(h => h.timestamp >= thirtyDaysAgo);
                    
                    return { recentMonthPoints };
                }
            },
            { 
                id: 'first_exchange', 
                name: '首次兌換', 
                description: '第一次兌換獎品', 
                icon: 'fa-shopping-cart', 
                reward: '+25積分',
                condition: (user, data) => {
                    if (!data || !data.hasExchanged) return false;
                    return data.hasExchanged;
                },
                progress: (user, data) => {
                    const hasExchanged = data && data.hasExchanged ? data.hasExchanged : false;
                    return hasExchanged ? 100 : 0;
                },
                getData: (user) => {
                    const hasExchanged = pointsHistory.some(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    );
                    return { hasExchanged };
                }
            }
        ];
        
        // 段位划分标准（基于累积积分）
        const tierThresholds = [
            { name: '青銅', min: 0, max: 299, color: 'brown' },
            { name: '白銀', min: 300, max: 599, color: '#5fecfc' },
            { name: '黃金', min: 600, max: 899, color: '#ff8904' },
            { name: '鉑金', min: 900, max: 1199, color: '#75c8ff' },
            { name: '鑽石', min: 1200, max: 1499, color: '#9035F8' },
            { name: '王者', min: 1500, max: Infinity, color: '#ffd900' }
        ];
        
        // 计算用户段位
        function calculateUserTier(totalPoints) {
            for (const tier of tierThresholds) {
                if (totalPoints >= tier.min && totalPoints <= tier.max) {
                    return tier.name;
                }
            }
            return '青銅';
        }
        
        // 获取段位对应的CSS类名
        function getTierClass(tierName) {
            switch(tierName) {
                case '王者': return 'tier-king';
                case '鑽石': return 'tier-diamond';
                case '鉑金': return 'tier-platinum';
                case '黃金': return 'tier-gold';
                case '白銀': return 'tier-silver';
                case '青銅': return 'tier-bronze';
                default: return 'tier-bronze';
            }
        }
        
        // 获取段位对应的颜色
        function getTierColor(tierName) {
            for (const tier of tierThresholds) {
                if (tier.name === tierName) {
                    return tier.color;
                }
            }
            return 'brown';
        }
        
        // 管理员密码
        const adminPassword = 'admin123';
        
        // DOM元素
        const pageLoader = document.getElementById('pageLoader');
        const loginSection = document.getElementById('loginSection');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const userBarcodeScan = document.getElementById('userBarcodeScan');
        const adminBarcodeScan = document.getElementById('adminBarcodeScan');
        const userLoginBtn = document.getElementById('userLoginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const userLogoutBtn = document.getElementById('userLogoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const prizesGrid = document.getElementById('prizesGrid');
        const usersTableBody = document.getElementById('usersTableBody');
        const prizesTableBody = document.getElementById('prizesTableBody');
        const updatePointsBtn = document.getElementById('updatePointsBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const closeAddUserModal = document.getElementById('closeAddUserModal');
        const confirmAddUser = document.getElementById('confirmAddUser');
        const generatedBarcodeCode = document.getElementById('generatedBarcodeCode');
        const newUserBarcode = document.getElementById('newUserBarcode');
        const addPrizeBtn = document.getElementById('addPrizeBtn');
        const editPrizeModal = document.getElementById('editPrizeModal');
        const closeEditPrizeModal = document.getElementById('closeEditPrizeModal');
        const confirmEditPrize = document.getElementById('confirmEditPrize');
        const searchHistoryBtn = document.getElementById('searchHistoryBtn');
        const barcodeScannerModal = document.getElementById('barcodeScannerModal');
        const closeScannerModal = document.getElementById('closeScannerModal');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scanResult = document.getElementById('scanResult');
        const confirmScanBtn = document.getElementById('confirmScanBtn');
        const userIdInput = document.getElementById('userIdInput');
        const userBarcodeDisplay = document.getElementById('userBarcodeDisplay');
        const notification = document.getElementById('notification');
        const achievementNotification = document.getElementById('achievementNotification');
        const achievementNotificationName = document.getElementById('achievementNotificationName');
        const achievementNotificationDesc = document.getElementById('achievementNotificationDesc');
        const achievementNotificationReward = document.getElementById('achievementNotificationReward');
        const userLeaderboardBody = document.getElementById('userLeaderboardBody');
        const adminLeaderboardBody = document.getElementById('adminLeaderboardBody');
        const tierPieChart = document.getElementById('tierPieChart');
        const adminTierPieChart = document.getElementById('adminTierPieChart');
        const pieLegend = document.getElementById('pieLegend');
        const adminPieLegend = document.getElementById('adminPieLegend');
        const themeToggle = document.getElementById('themeToggle');
        const achievementsGrid = document.getElementById('achievementsGrid');
        
        // 登录选项切换
        const userCodeLoginBtn = document.getElementById('userCodeLoginBtn');
        const userBarcodeLoginBtn = document.getElementById('userBarcodeLoginBtn');
        const userCodeLoginForm = document.getElementById('userCodeLoginForm');
        const userBarcodeLoginForm = document.getElementById('userBarcodeLoginForm');
        
        const adminCodeLoginBtn = document.getElementById('adminCodeLoginBtn');
        const adminBarcodeLoginBtn = document.getElementById('adminBarcodeLoginBtn');
        const adminCodeLoginForm = document.getElementById('adminCodeLoginForm');
        const adminBarcodeLoginForm = document.getElementById('adminBarcodeLoginForm');
        
        // 新增功能元素
        const searchUserBtn = document.getElementById('searchUserBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const exportUsersBtn = document.getElementById('exportUsersBtn');
        const exportPrizesBtn = document.getElementById('exportPrizesBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearHistorySearchBtn = document.getElementById('clearHistorySearchBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const dataFile = document.getElementById('dataFile');
        const pointsReason = document.getElementById('pointsReason');
        const customReason = document.getElementById('customReason');
        
        // 当前登录的用户和管理员
        let currentUser = null;
        let currentAdmin = false;
        let scannerActive = false;
        let scannedBarcode = '';
        let scannerType = '';
        let pieChartAnimations = {};
        let achievementNotificationTimeout = null;
        
        // 修复条形码生成函数
        function generateBarcode(code, container) {
            container.innerHTML = '';
            
            if (!code || code.trim() === '') {
                container.innerHTML = '<div class="barcode-placeholder">条形码编码为空</div>';
                return;
            }
            
            try {
                // 创建canvas元素
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                
                // 使用JsBarcode生成条形码
                JsBarcode(canvas, code, {
                    format: "CODE128",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontOptions: "bold",
                    fontSize: 16,
                    textMargin: 10,
                    margin: 10,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
                
                console.log('QRcode生成成功:', code);
            } catch (error) {
                console.error('QRcode生成失敗:', error);
                container.innerHTML = '<div class="barcode-placeholder">QRcode生成失敗: ' + error.message + '</div>';
            }
        }

        // 显示成就解锁通知
        function showAchievementNotification(achievement) {
            achievementNotificationName.textContent = achievement.name;
            achievementNotificationDesc.textContent = achievement.description;
            achievementNotificationReward.textContent = `獎勵: ${achievement.reward}`;
            
            // 设置图标
            const iconElement = achievementNotification.querySelector('.achievement-notification-icon i');
            iconElement.className = `fas ${achievement.icon}`;
            
            // 显示通知
            achievementNotification.classList.add('unlocked');
            
            // 播放声音（如果有的话）
            playAchievementSound();
            
            // 4秒后自动隐藏
            if (achievementNotificationTimeout) {
                clearTimeout(achievementNotificationTimeout);
            }
            
            achievementNotificationTimeout = setTimeout(() => {
                achievementNotification.classList.remove('unlocked');
            }, 4000);
        }
        
        // 播放成就解锁声音
        function playAchievementSound() {
            // 这里可以添加音效，如果需要的话
            // 例如：new Audio('achievement.mp3').play();
        }

        // 初始化页面
        function initPage() {
            // 隐藏加载动画
            setTimeout(() => {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 500);
            }, 1500); // 保持初始化时间
            
            // 创建落叶效果
            createLeaves();
            
            // 保存初始数据到localStorage
            saveDataToStorage();
            
            // 只渲染必要的组件，延迟渲染其他组件
            renderPrizes();
            renderUsersTable();
            renderPrizesTable();
            setupTabs();
            setupLoginOptions();
            updateSystemStats();
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 检查是否已保存主题偏好
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('theme-dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // 积分变更原因选择事件
            pointsReason.addEventListener('change', function() {
                if (this.value === '其他') {
                    customReason.style.display = 'block';
                } else {
                    customReason.style.display = 'none';
                    customReason.value = '';
                }
            });
            
            // 用户登录按钮事件
            userLoginBtn.addEventListener('click', function() {
                const userId = userIdInput.value;
                if (userId) {
                    loginWithUserId(userId);
                } else {
                    showNotification('請輸入用戶編號', 'error');
                }
            });
            
            // 用户条形码扫描事件
            userBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('user');
            });
            
            // 管理员条形码扫描事件
            adminBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('admin');
            });
            
            // 管理员登录按钮事件
            adminLoginBtn.addEventListener('click', function() {
                const adminId = document.getElementById('adminId').value;
                const password = document.getElementById('adminPassword').value;
                
                if (adminId && password) {
                    loginAdminWithCredentials(adminId, password);
                } else {
                    showNotification('請輸入管理員編號和密碼', 'error');
                }
            });
            
            // 用户退出登录
            userLogoutBtn.addEventListener('click', function() {
                currentUser = null;
                showLoginSection();
                showNotification('已登出用戶登錄', 'info');
            });
            
            // 管理员退出登录
            adminLogoutBtn.addEventListener('click', function() {
                // 询问是否要下载备份
                if (confirm('是否要下載最新的系統文件？')) {
                    exportAllData();
                }
                currentAdmin = false;
                document.getElementById('adminId').value = '';
                document.getElementById('adminPassword').value = '';
                showLoginSection();
                showNotification('已登出管理員登陸', 'info');
            });
            
            // 更新积分按钮事件 - 添加成功提示
            updatePointsBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                const pointsChange = parseInt(document.getElementById('pointsChange').value);
                let reason = pointsReason.value;
                
                if (reason === '其他') {
                    reason = customReason.value;
                }
                
                if (!searchTerm || isNaN(pointsChange)) {
                    showNotification('請輸入有效的變更值和用戶編號', 'error');
                    return;
                }
                
                if (!reason) {
                    showNotification('請選擇或輸入變更原因', 'error');
                    return;
                }
                
                const user = users.find(u => 
                    u.id === searchTerm || 
                    u.name === searchTerm || 
                    u.barcodeCode === searchTerm
                );
                
                if (user) {
                    user.points += pointsChange;
                    if (user.points < 0) user.points = 0;
                    
                    // 如果是增加积分，同时增加累积积分
                    if (pointsChange > 0) {
                        user.totalPoints += pointsChange;
                    }
                    
                    // 更新段位
                    user.tier = calculateUserTier(user.totalPoints);
                    
                    // 检查成就
                    checkAchievements(user);
                    
                    // 记录积分变更历史
                    pointsHistory.push({
                        userId: user.id,
                        timestamp: new Date().getTime(),
                        pointsChange: pointsChange,
                        reason: reason
                    });
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    renderUsersTable();
                    updateSystemStats();
                    document.getElementById('pointsChange').value = '';
                    pointsReason.value = '';
                    customReason.value = '';
                    customReason.style.display = 'none';
                    
                    // 添加成功提示
                    showNotification(`成功更新 ${user.name} 的積分！變更: ${pointsChange > 0 ? '+' : ''}${pointsChange}`, 'success');
                } else {
                    showNotification('未找到該用戶', 'error');
                }
            });
            
            // 添加用户按钮事件
            addUserBtn.addEventListener('click', function() {
                // 生成随机条形码编码
                const newBarcodeCode = generateBarcodeCode();
                generatedBarcodeCode.textContent = newBarcodeCode;
                
                // 生成条形码 - 添加延迟确保DOM更新
                setTimeout(() => {
                    generateBarcode(newBarcodeCode, newUserBarcode);
                }, 100);
                
                // 显示模态框
                addUserModal.style.display = 'flex';
            });
            
            // 关闭添加用户模态框
            closeAddUserModal.addEventListener('click', function() {
                addUserModal.style.display = 'none';
            });
            
            // 确认添加用户
            confirmAddUser.addEventListener('click', function() {
                const userName = document.getElementById('newUserName').value;
                const userId = document.getElementById('newUserId').value;
                const userPoints = parseInt(document.getElementById('newUserPoints').value) || 0;
                const barcodeCode = generatedBarcodeCode.textContent;
                
                if (!userName || !userId) {
                    showNotification('請輸入用戶姓名或編號', 'error');
                    return;
                }
                
                // 检查用户编号是否已存在
                if (users.find(u => u.id === userId)) {
                    showNotification('用戶編號已存在，請使用其他編號', 'error');
                    return;
                }
                
                // 计算段位
                const userTier = calculateUserTier(userPoints);
                
                // 添加新用户
                const newUser = {
                    id: userId,
                    name: userName,
                    barcodeCode: barcodeCode,
                    points: userPoints,
                    totalPoints: userPoints, // 初始累积积分等于当前积分
                    tier: userTier, // 初始段位
                    isAdmin: false,
                    achievements: [], // 初始成就
                    achievementData: {} // 初始成就数据
                };
                
                // 检查初始成就
                checkAchievements(newUser);
                
                users.push(newUser);
                
                // 记录初始积分历史
                if (userPoints > 0) {
                    pointsHistory.push({
                        userId: userId,
                        timestamp: new Date().getTime(),
                        pointsChange: userPoints,
                        reason: '初始積分'
                    });
                }
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderUsersTable();
                updateSystemStats();
                
                // 关闭模态框并重置表单
                addUserModal.style.display = 'none';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserId').value = '';
                document.getElementById('newUserPoints').value = '0';
                
                showNotification(`成功添加用户 ${userName}，条形码编码: ${barcodeCode}`, 'success');
            });
            
            // 添加奖品按钮事件
            addPrizeBtn.addEventListener('click', function() {
                const prizeName = document.getElementById('prizeName').value;
                const prizePoints = parseInt(document.getElementById('prizePoints').value);
                const prizeIcon = document.getElementById('prizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的獎品信息', 'error');
                    return;
                }
                
                // 生成奖品ID
                const prizeId = generatePrizeId();
                
                // 添加新奖品
                prizes.push({
                    id: prizeId,
                    name: prizeName,
                    points: prizePoints,
                    icon: prizeIcon
                });
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                // 重置表单
                document.getElementById('prizeName').value = '';
                document.getElementById('prizePoints').value = '';
                document.getElementById('prizeIcon').value = 'fa-gift';
                
                showNotification(`成功添加獎品 ${prizeName}`, 'success');
            });
            
            // 关闭编辑奖品模态框
            closeEditPrizeModal.addEventListener('click', function() {
                editPrizeModal.style.display = 'none';
            });
            
            // 确认编辑奖品
            confirmEditPrize.addEventListener('click', function() {
                const prizeId = document.getElementById('editPrizeId').value;
                const prizeName = document.getElementById('editPrizeName').value;
                const prizePoints = parseInt(document.getElementById('editPrizePoints').value);
                const prizeIcon = document.getElementById('editPrizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的奖品信息', 'error');
                    return;
                }
                
                // 更新奖品信息
                const prize = prizes.find(p => p.id === prizeId);
                if (prize) {
                    prize.name = prizeName;
                    prize.points = prizePoints;
                    prize.icon = prizeIcon;
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    // 更新界面
                    renderPrizesTable();
                    renderPrizes();
                    
                    // 关闭模态框
                    editPrizeModal.style.display = 'none';
                    
                    showNotification(`成功更新獎品 ${prizeName}`, 'success');
                }
            });
            
            // 搜索历史记录按钮事件
            searchHistoryBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchHistoryUser').value;
                renderAdminHistory(searchTerm);
            });
            
            // 条形码扫描模态框事件
            closeScannerModal.addEventListener('click', function() {
                closeBarcodeScanner();
            });
            
            startScannerBtn.addEventListener('click', function() {
                startBarcodeScanner();
            });
            
            stopScannerBtn.addEventListener('click', function() {
                stopBarcodeScanner();
            });
            
            confirmScanBtn.addEventListener('click', function() {
                if (scannedBarcode) {
                    if (scannerType === 'user') {
                        loginWithBarcode(scannedBarcode);
                    } else if (scannerType === 'admin') {
                        loginAdminWithBarcode(scannedBarcode);
                    }
                    closeBarcodeScanner();
                }
            });
            
            // 新增功能事件
            searchUserBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                renderUsersTable(searchTerm);
            });
            
            clearSearchBtn.addEventListener('click', function() {
                document.getElementById('searchUser').value = '';
                renderUsersTable();
            });
            
            exportUsersBtn.addEventListener('click', function() {
                exportUsersData();
            });
            
            exportPrizesBtn.addEventListener('click', function() {
                exportPrizesData();
            });
            
            exportHistoryBtn.addEventListener('click', function() {
                exportHistoryData();
            });
            
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有積分歷史紀錄吗？此操作不可恢復！')) {
                    pointsHistory = [];
                    saveDataToStorage();
                    renderAdminHistory();
                    updateSystemStats();
                    showNotification('歷史紀錄已清空', 'success');
                }
            });
            
            clearHistorySearchBtn.addEventListener('click', function() {
                document.getElementById('searchHistoryUser').value = '';
                renderAdminHistory();
            });
            
            changePasswordBtn.addEventListener('click', function() {
                changeAdminPassword();
            });
            
            importDataBtn.addEventListener('click', function() {
                dataFile.click();
            });
            
            exportDataBtn.addEventListener('click', function() {
                exportAllData();
            });
            
            resetDataBtn.addEventListener('click', function() {
                resetSystemData();
            });
            
            dataFile.addEventListener('change', function(e) {
                importData(e);
            });
        }
        
        // 主题切换
        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            if (document.body.classList.contains('theme-dark')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // 设置登录选项切换
        function setupLoginOptions() {
            // 用户登录选项
            userCodeLoginBtn.addEventListener('click', function() {
                userCodeLoginBtn.classList.add('active');
                userBarcodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'block';
                userBarcodeLoginForm.style.display = 'none';
            });
            
            userBarcodeLoginBtn.addEventListener('click', function() {
                userBarcodeLoginBtn.classList.add('active');
                userCodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'none';
                userBarcodeLoginForm.style.display = 'block';
            });
            
            // 管理员登录选项
            adminCodeLoginBtn.addEventListener('click', function() {
                adminCodeLoginBtn.classList.add('active');
                adminBarcodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'block';
                adminBarcodeLoginForm.style.display = 'none';
            });
            
            adminBarcodeLoginBtn.addEventListener('click', function() {
                adminBarcodeLoginBtn.classList.add('active');
                adminCodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'none';
                adminBarcodeLoginForm.style.display = 'block';
            });
        }
        
        // 设置选项卡切换
        function setupTabs() {
            // 用户界面选项卡
            const userTabs = document.querySelectorAll('#userDashboard .tab');
            userTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    userTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#userDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history') {
                        renderUserHistory();
                    } else if (tabId === 'leaderboard') {
                        renderUserLeaderboard();
                        renderTierPieChartWithAnimation(tierPieChart, pieLegend);
                    } else if (tabId === 'achievements') {
                        renderAchievements();
                    }
                });
            });
            
            // 管理员界面选项卡
            const adminTabs = document.querySelectorAll('#adminDashboard .tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    adminTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#adminDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history-admin') {
                        renderAdminHistory();
                    } else if (tabId === 'leaderboard-admin') {
                        renderAdminLeaderboard();
                        renderTierPieChartWithAnimation(adminTierPieChart, adminPieLegend);
                    } else if (tabId === 'system-admin') {
                        updateSystemStats();
                    }
                });
            });
        }
        
        // 使用用户编号登录
        function loginWithUserId(userId) {
            const user = users.find(u => u.id === userId && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('用户編號錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用条形码登录
        function loginWithBarcode(barcode) {
            const user = users.find(u => u.barcodeCode === barcode && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('QRcode錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用管理员凭据登录
        function loginAdminWithCredentials(adminId, password) {
            if (password === adminPassword) {
                const adminUser = users.find(u => u.id === adminId && u.isAdmin);
                if (adminUser) {
                    currentAdmin = true;
                    showAdminDashboard();
                    showNotification('管理員登陸成功！', 'success');
                } else {
                    showNotification('管理員編號錯誤！', 'error');
                }
            } else {
                showNotification('密碼錯誤，請重試！', 'error');
            }
        }
        
        // 使用管理员条形码登录
        function loginAdminWithBarcode(barcode) {
            const adminUser = users.find(u => u.barcodeCode === barcode && u.isAdmin);
            if (adminUser) {
                currentAdmin = true;
                showAdminDashboard();
                showNotification('管理員登錄成功！', 'success');
            } else {
                showNotification('管理員QRcode錯誤！', 'error');
            }
        }
        
        // 打开条形码扫描器
        function openBarcodeScanner(type) {
            scannerType = type;
            barcodeScannerModal.style.display = 'flex';
            scanResult.textContent = '等待掃描...';
            confirmScanBtn.style.display = 'none';
            scannedBarcode = '';
        }
        
        // 关闭条形码扫描器
        function closeBarcodeScanner() {
            barcodeScannerModal.style.display = 'none';
            stopBarcodeScanner();
        }
        
        // 开始条形码扫描
        function startBarcodeScanner() {
            if (scannerActive) return;
            
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.innerHTML = '';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerContainer,
                    constraints: {
                        width: 480,
                        height: 320,
                        facingMode: "environment" // 使用后置攝像頭
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showNotification('無法啟動攝像頭: ' + err, 'error');
                    return;
                }
                Quagga.start();
                scannerActive = true;
                startScannerBtn.style.display = 'none';
                stopScannerBtn.style.display = 'inline-block';
            });
            
            Quagga.onDetected(function(result) {
                if (result && result.codeResult) {
                    scannedBarcode = result.codeResult.code;
                    scanResult.textContent = scannedBarcode;
                    confirmScanBtn.style.display = 'block';
                    showNotification('監測到QRcode: ' + scannedBarcode, 'success');
                    
                    // 自动停止扫描
                    stopBarcodeScanner();
                }
            });
        }
        
        // 停止条形码扫描
        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                startScannerBtn.style.display = 'inline-block';
                stopScannerBtn.style.display = 'none';
            }
        }
        
        // 显示登录区域
        function showLoginSection() {
            loginSection.style.display = 'flex';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            userIdInput.value = '';
        }
        
        // 显示用户仪表盘
        function showUserDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'block';
            adminDashboard.style.display = 'none';
            
            // 更新用户信息
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            document.getElementById('dashboardUserId').textContent = currentUser.id;
            document.getElementById('dashboardUserBarcode').textContent = currentUser.barcodeCode;
            document.getElementById('dashboardUserPoints').textContent = currentUser.points;
            document.getElementById('dashboardUserTotalPoints').textContent = currentUser.totalPoints;
            document.getElementById('dashboardUserTier').textContent = currentUser.tier;
            document.getElementById('dashboardUserTier').className = 'user-tier ' + getTierClass(currentUser.tier);
            
            // 生成用户条形码 - 添加延迟
            setTimeout(() => {
                generateBarcode(currentUser.barcodeCode, userBarcodeDisplay);
            }, 100);
            
            // 重新渲染奖品列表
            renderPrizes();
            
            // 更新成就统计
            updateAchievementStats();
        }
        
        // 显示管理员仪表盘
        function showAdminDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'block';
        }
        
        // 渲染奖品列表（用户界面）
        function renderPrizes() {
            prizesGrid.innerHTML = '';
            
            prizes.forEach(prize => {
                const prizeCard = document.createElement('div');
                prizeCard.className = 'prize-card';
                
                const canAfford = currentUser && currentUser.points >= prize.points;
                
                prizeCard.innerHTML = `
                    <div class="prize-image">
                        <i class="fas ${prize.icon}"></i>
                    </div>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-points">${prize.points} 积分</div>
                    <button class="btn ${canAfford ? '' : 'disabled'}" 
                            ${canAfford ? '' : 'disabled'}
                            onclick="redeemPrize('${prize.id}')">
                        ${canAfford ? '立即兌換' : '積分不足'}
                    </button>
                `;
                
                prizesGrid.appendChild(prizeCard);
            });
        }
        
        // 兑换奖品
        function redeemPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            
            if (currentUser.points >= prize.points) {
                currentUser.points -= prize.points;
                
                // 记录积分变更历史
                pointsHistory.push({
                    userId: currentUser.id,
                    timestamp: new Date().getTime(),
                    pointsChange: -prize.points,
                    reason: `兌換獎品：${prize.name}`
                });
                
                // 检查成就
                checkAchievements(currentUser);
                
                // 保存数据
                saveDataToStorage();
                
                document.getElementById('dashboardUserPoints').textContent = currentUser.points;
                renderPrizes();
                showNotification(`成功兑换 ${prize.name}！`, 'success');
                
                // 如果用户在成就页面，刷新成就显示
                if (document.getElementById('achievements-tab').classList.contains('active')) {
                    renderAchievements();
                    updateAchievementStats();
                }
            } else {
                showNotification('積分不足，无法兑换該獎品', 'error');
            }
        }
        
        // 渲染用户表格 - 移除批量操作相关代码
        function renderUsersTable(searchTerm = '') {
            usersTableBody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = users.filter(user => 
                    user.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.barcodeCode.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.barcodeCode}</td>
                    <td>${user.points}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="selectUser('${user.id}')">选择</button>
                        ${!user.isAdmin ? 
                            `<button class="action-btn" style="background: #f39c12;" onclick="promoteUser('${user.id}')">升级为管理員</button>` : 
                            ''
                        }
                        <button class="action-btn" style="background: #e74c3c;" onclick="deleteUser('${user.id}')">移除人員</button>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            updateUserStats();
        }
        
        // 渲染奖品表格（管理员界面）
        function renderPrizesTable() {
            prizesTableBody.innerHTML = '';
            
            prizes.forEach(prize => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${prize.id}</td>
                    <td>${prize.name}</td>
                    <td>${prize.points}</td>
                    <td><i class="fas ${prize.icon}"></i> ${prize.icon}</td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="editPrize('${prize.id}')">编辑</button>
                        <button class="action-btn" style="background: #e74c3c;" onclick="deletePrize('${prize.id}')">移除人員</button>
                    </td>
                `;
                
                prizesTableBody.appendChild(row);
            });
        }
        
        // 渲染用户积分历史
        function renderUserHistory() {
            const userHistoryContent = document.getElementById('userHistoryContent');
            userHistoryContent.innerHTML = '';
            
            // 获取当前用户的历史记录
            const userHistory = pointsHistory
                .filter(record => record.userId === currentUser.id)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (userHistory.length === 0) {
                userHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            userHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                userHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染管理员查看的积分历史
        function renderAdminHistory(searchTerm = '') {
            const adminHistoryContent = document.getElementById('adminHistoryContent');
            adminHistoryContent.innerHTML = '';
            
            let filteredHistory = pointsHistory;
            
            // 如果提供了搜索条件，过滤历史记录
            if (searchTerm) {
                // 查找匹配的用户
                const matchedUsers = users.filter(u => 
                    u.id.includes(searchTerm) || 
                    u.name.includes(searchTerm) || 
                    u.barcodeCode.includes(searchTerm)
                );
                
                const matchedUserIds = matchedUsers.map(u => u.id);
                filteredHistory = pointsHistory.filter(record => 
                    matchedUserIds.includes(record.userId)
                );
            }
            
            // 按时间排序
            filteredHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredHistory.length === 0) {
                adminHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const user = users.find(u => u.id === record.userId);
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div><strong>${user ? user.name : '未知用户'} (${record.userId})</strong></div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                adminHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染用户排行榜 - 前三名更醒目
        function renderUserLeaderboard() {
            userLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                userLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                userLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染管理员排行榜 - 前三名更醒目
        function renderAdminLeaderboard() {
            adminLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                adminLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                adminLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染成就系统 - 已解锁的成就放在前面
        function renderAchievements() {
            achievementsGrid.innerHTML = '';
            
            if (!currentUser) return;
            
            // 检查并更新用户成就
            checkAchievements(currentUser);
            
            // 将成就分为已解锁和未解锁两组
            const unlockedAchievements = [];
            const lockedAchievements = [];
            
            achievements.forEach(achievement => {
                // 获取成就数据
                const achievementData = achievement.getData ? achievement.getData(currentUser) : {};
                
                // 检查是否已解锁
                const isUnlocked = achievement.condition(currentUser, achievementData);
                const progress = achievement.progress ? achievement.progress(currentUser, achievementData) : (isUnlocked ? 100 : 0);
                
                const achievementObj = {
                    achievement: achievement,
                    isUnlocked: isUnlocked,
                    progress: progress,
                    data: achievementData
                };
                
                if (isUnlocked) {
                    unlockedAchievements.push(achievementObj);
                } else {
                    lockedAchievements.push(achievementObj);
                }
            });
            
            // 先渲染已解锁的成就
            unlockedAchievements.forEach(({ achievement, isUnlocked, progress, data }) => {
                createAchievementCard(achievement, isUnlocked, progress, data);
            });
            
            // 再渲染未解锁的成就
            lockedAchievements.forEach(({ achievement, isUnlocked, progress, data }) => {
                createAchievementCard(achievement, isUnlocked, progress, data);
            });
            
            // 更新成就统计
            updateAchievementStats();
        }
        
        // 创建成就卡片
        function createAchievementCard(achievement, isUnlocked, progress, data) {
            const achievementCard = document.createElement('div');
            achievementCard.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
            
            achievementCard.innerHTML = `
                <div class="achievement-icon">
                    <i class="fas ${achievement.icon}"></i>
                </div>
                <div class="achievement-name">${achievement.name}</div>
                <div class="achievement-description">${achievement.description}</div>
                <div class="achievement-reward">獎勵: ${achievement.reward}</div>
                
                ${!isUnlocked ? `
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="achievement-progress-text">${progress.toFixed(0)}% 完成</div>
                ` : ''}
                
                <div class="achievement-status ${isUnlocked ? 'achievement-unlocked' : 'achievement-locked'}">
                    ${isUnlocked ? '已解鎖' : '未解鎖'}
                </div>
            `;
            
            // 添加解锁动画效果
            if (isUnlocked && !currentUser.achievementData[achievement.id]) {
                achievementCard.style.animation = 'achievementUnlock 0.5s ease';
                currentUser.achievementData[achievement.id] = true;
                saveDataToStorage();
            }
            
            achievementsGrid.appendChild(achievementCard);
        }
        
        // 更新成就统计
        function updateAchievementStats() {
            if (!currentUser) return;
            
            const unlockedCount = achievements.filter(achievement => {
                const achievementData = achievement.getData ? achievement.getData(currentUser) : {};
                return achievement.condition(currentUser, achievementData);
            }).length;
            
            const totalCount = achievements.length;
            const progressPercentage = totalCount > 0 ? Math.round((unlockedCount / totalCount) * 100) : 0;
            
            document.getElementById('achievementUnlocked').textContent = unlockedCount;
            document.getElementById('achievementTotal').textContent = totalCount;
            document.getElementById('achievementProgress').textContent = `${progressPercentage}%`;
        }
        
        // 检查用户成就
        function checkAchievements(user) {
            let newAchievements = [];
            
            achievements.forEach(achievement => {
                const achievementData = achievement.getData ? achievement.getData(user) : {};
                const isUnlocked = achievement.condition(user, achievementData);
                
                if (isUnlocked && !user.achievements.includes(achievement.name)) {
                    user.achievements.push(achievement.name);
                    newAchievements.push(achievement);
                    
                    // 给予成就奖励
                    if (achievement.reward) {
                        const match = achievement.reward.match(/\+(\d+)/);
                        if (match) {
                            const rewardPoints = parseInt(match[1]);
                            user.points += rewardPoints;
                            user.totalPoints += rewardPoints;
                            
                            // 记录奖励
                            pointsHistory.push({
                                userId: user.id,
                                timestamp: new Date().getTime(),
                                pointsChange: rewardPoints,
                                reason: `成就獎勵: ${achievement.name}`
                            });
                            
                            // 更新段位
                            user.tier = calculateUserTier(user.totalPoints);
                        }
                    }
                }
            });
            
            // 如果有新成就，显示通知
            if (newAchievements.length > 0) {
                // 保存数据
                saveDataToStorage();
                
                // 如果当前用户是成就获得者，显示通知
                if (currentUser && currentUser.id === user.id) {
                    // 显示第一个新成就的通知
                    showAchievementNotification(newAchievements[0]);
                    
                    // 如果有多个新成就，稍后显示下一个
                    if (newAchievements.length > 1) {
                        setTimeout(() => {
                            showAchievementNotification(newAchievements[1]);
                        }, 4500);
                    }
                    
                    // 如果用户在成就页面，刷新显示
                    if (document.getElementById('achievements-tab').classList.contains('active')) {
                        renderAchievements();
                        updateAchievementStats();
                    }
                }
            }
            
            return newAchievements;
        }
        
        // 渲染段位饼图 - 带动画效果，更圆润
        function renderTierPieChartWithAnimation(canvasElement, legendElement) {
            // 如果已有动画在进行，取消它
            if (pieChartAnimations[canvasElement.id]) {
                cancelAnimationFrame(pieChartAnimations[canvasElement.id]);
                delete pieChartAnimations[canvasElement.id];
            }
            
            // 统计各段位用户数量
            const tierCounts = {};
            tierThresholds.forEach(tier => {
                tierCounts[tier.name] = 0;
            });
            
            users.filter(u => !u.isAdmin).forEach(user => {
                tierCounts[user.tier]++;
            });
            
            // 过滤掉数量为0的段位
            const filteredTiers = tierThresholds.filter(tier => tierCounts[tier.name] > 0);
            
            // 计算总数
            const totalUsers = users.filter(u => !u.isAdmin).length;
            
            // 生成图例
            legendElement.innerHTML = '';
            filteredTiers.forEach(tier => {
                const percentage = totalUsers > 0 ? ((tierCounts[tier.name] / totalUsers) * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${tier.color};"></div>
                    <span>${tier.name}: ${tierCounts[tier.name]}人 (${percentage}%)</span>
                `;
                legendElement.appendChild(legendItem);
            });
            
            const ctx = canvasElement.getContext('2d');
            const width = canvasElement.width;
            const height = canvasElement.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 * 0.8;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 如果没有数据，显示提示
            if (totalUsers === 0) {
                ctx.fillStyle = '#ccc';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', centerX, centerY);
                return;
            }
            
            // 计算每个扇形的起始和结束角度
            let startAngle = -Math.PI / 2; // 从12点钟方向开始
            const slices = filteredTiers.map(tier => {
                const sliceAngle = (2 * Math.PI * tierCounts[tier.name]) / totalUsers;
                const slice = {
                    tier: tier,
                    startAngle: startAngle,
                    endAngle: startAngle + sliceAngle,
                    color: tier.color
                };
                startAngle += sliceAngle;
                return slice;
            });
            
            // 动画参数
            const duration = 1500; // 动画持续1500毫秒
            let startTime = null;
            
            // 动画函数
            function animate(currentTime) {
                if (!startTime) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1); // 0到1
                
                // 当前角度从0到2PI
                const currentAngle = progress * 2 * Math.PI;
                
                // 清除画布
                ctx.clearRect(0, 0, width, height);
                
                // 绘制每个扇形
                slices.forEach(slice => {
                    // 如果当前角度大于这个扇形的起始角度，则绘制
                    if (currentAngle > slice.startAngle + Math.PI / 2) {
                        const start = slice.startAngle;
                        const end = Math.min(currentAngle - Math.PI / 2, slice.endAngle);
                        
                        if (end > start) {
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            ctx.arc(centerX, centerY, radius, start, end);
                            ctx.closePath();
                            ctx.fillStyle = slice.color;
                            ctx.fill();
                            
                            // 绘制分隔线
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                });
                
                // 如果动画未完成，继续
                if (progress < 1) {
                    pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
                } else {
                    // 动画完成，绘制中心圆和文字
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('段位分布', centerX, centerY - 8);
                    ctx.font = '14px Arial';
                    ctx.fillText(`${totalUsers}人`, centerX, centerY + 10);
                    
                    // 动画完成，清除动画ID
                    delete pieChartAnimations[canvasElement.id];
                }
            }
            
            // 启动动画
            pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
        }
        
        // 选择用户
        function selectUser(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('searchUser').value = user.id;
        }
        
        // 升级用户为管理员
        function promoteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.isAdmin = true;
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification(`已将 ${user.name} 升級為管理員`, 'success');
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？此操作不可撤銷。')) {
                users = users.filter(u => u.id !== userId);
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification('用户已删除', 'success');
            }
        }
        
        // 编辑奖品
        function editPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            if (prize) {
                document.getElementById('editPrizeId').value = prize.id;
                document.getElementById('editPrizeName').value = prize.name;
                document.getElementById('editPrizePoints').value = prize.points;
                document.getElementById('editPrizeIcon').value = prize.icon;
                
                editPrizeModal.style.display = 'flex';
            }
        }
        
        // 删除奖品
        function deletePrize(prizeId) {
            if (confirm('确定要删除这个獎品吗？此操作不可撤銷。')) {
                prizes = prizes.filter(p => p.id !== prizeId);
                
                // 保存数据
                saveDataToStorage();
                
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                showNotification('獎品已删除', 'success');
            }
        }
        
        // 更新用户统计信息 - 使用累积积分
        function updateUserStats() {
            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalPoints = users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0);
            
            // 使用累积积分统计各段位用户数量
            const activeUsers = users.filter(u => !u.isAdmin && u.totalPoints >= 1500).length;
            const activeUser4 = users.filter(u => !u.isAdmin && u.totalPoints >= 1200 && u.totalPoints < 1500).length;
            const activeUser3 = users.filter(u => !u.isAdmin && u.totalPoints >= 900 && u.totalPoints < 1200).length;
            const activeUser2 = users.filter(u => !u.isAdmin && u.totalPoints >= 600 && u.totalPoints < 900).length;
            const activeUser1 = users.filter(u => !u.isAdmin && u.totalPoints >= 300 && u.totalPoints < 600).length;
            const activeUser0 = users.filter(u => !u.isAdmin && u.totalPoints < 300).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('activeUser4').textContent = activeUser4;
            document.getElementById('activeUser3').textContent = activeUser3;
            document.getElementById('activeUser2').textContent = activeUser2;
            document.getElementById('activeUser1').textContent = activeUser1;
            document.getElementById('activeUser0').textContent = activeUser0;
        }
        
        // 更新系统统计信息
        function updateSystemStats() {
            document.getElementById('systemUsers').textContent = users.filter(u => !u.isAdmin).length;
            document.getElementById('systemPrizes').textContent = prizes.length;
            document.getElementById('systemHistory').textContent = pointsHistory.length;
            document.getElementById('systemAdmins').textContent = users.filter(u => u.isAdmin).length;
            
            updateUserStats();
        }
        
        // 导出用户数据
        function exportUsersData() {
            const dataStr = JSON.stringify(users.filter(u => !u.isAdmin), null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('用户數據導出成功', 'success');
        }
        
        // 导出奖品数据
        function exportPrizesData() {
            const dataStr = JSON.stringify(prizes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'prizes_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('獎品數據導出成功', 'success');
        }
        
        // 导出历史数据
        function exportHistoryData() {
            const dataStr = JSON.stringify(pointsHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'history_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('歷史數據導出成功', 'success');
        }
        
        // 导出所有数据
        function exportAllData() {
            const allData = {
                users: users,
                prizes: prizes,
                history: pointsHistory,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'barcode_system_backup.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('系統數據備份成功', 'success');
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.users && Array.isArray(importedData.users)) {
                        users = importedData.users;
                        
                        // 确保导入的用户数据有累积积分和段位字段
                        users.forEach(user => {
                            if (user.totalPoints === undefined) {
                                user.totalPoints = user.points || 0;
                            }
                            if (user.tier === undefined) {
                                user.tier = calculateUserTier(user.totalPoints);
                            }
                            if (user.achievements === undefined) {
                                user.achievements = [];
                            }
                            if (user.achievementData === undefined) {
                                user.achievementData = {};
                            }
                            
                            // 检查成就
                            checkAchievements(user);
                        });
                    }
                    
                    if (importedData.prizes && Array.isArray(importedData.prizes)) {
                        prizes = importedData.prizes;
                    }
                    
                    if (importedData.history && Array.isArray(importedData.history)) {
                        pointsHistory = importedData.history;
                    }
                    
                    saveDataToStorage();
                    renderUsersTable();
                    renderPrizesTable();
                    renderPrizes();
                    updateSystemStats();
                    
                    showNotification('數據導入成功', 'success');
                } catch (error) {
                    showNotification('數據導入失败：文件格式錯誤', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入
            event.target.value = '';
        }
        
        // 修改管理员密码
        function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('請填寫所有密碼字段', 'error');
                return;
            }
            
            if (currentPassword !== adminPassword) {
                showNotification('當前密碼錯誤', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('新密碼和确认密碼不匹配', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('新密码长度至少6位', 'error');
                return;
            }
            
            // 在实际应用中，这里应该将新密码保存到安全的地方
            // 由于这是前端演示，我们无法真正修改硬编码的密码
            // 但可以保存到localStorage作为演示
            localStorage.setItem('adminNewPassword', newPassword);
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('密码修改需到代碼層尋找*****', 'success');
        }
        
        // 重置系统数据
        function resetSystemData() {
            if (confirm('确定要重置所有系統數據吗？此操作将删除所有用户、獎品和歷史紀錄，且不可恢复！')) {
                users = [
                    { 
                        id: 'wwlwcf002', 
                        name: '管理员', 
                        barcodeCode: 'wwlwcf002', 
                        points: 0, 
                        totalPoints: 0,
                        tier: '',
                        isAdmin: true,
                        achievements: [],
                        achievementData: {}
                    }
                ];
                prizes = [];
                pointsHistory = [];
                
                saveDataToStorage();
                renderUsersTable();
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                showNotification('系統數據已重置', 'success');
            }
        }
        
        // 生成随机用户ID
        function generateUserId() {
            const prefix = 'U';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机条形码编码
        function generateBarcodeCode() {
            const prefix = 'USER';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机奖品ID
        function generatePrizeId() {
            const prefix = 'P';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 保存数据到本地存储
        function saveDataToStorage() {
            localStorage.setItem('barcodePointsUsers', JSON.stringify(users));
            localStorage.setItem('barcodePointsPrizes', JSON.stringify(prizes));
            localStorage.setItem('barcodePointsHistory', JSON.stringify(pointsHistory));
        }
        
        // 显示通知
        function showNotification(message, type) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = '#2ecc71';
            } else if (type === 'error') {
                notification.style.background = '#e74c3c';
            } else {
                notification.style.background = '#3498db';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 确保JsBarcode库已加载
        function checkBarcodeLibrary() {
            if (typeof JsBarcode === 'undefined') {
                console.error('JsBarcode库未正确加载');
                // 尝试重新加载
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js';
                script.onload = function() {
                    console.log('JsBarcode库重新加载成功');
                    initPage();
                };
                document.head.appendChild(script);
            } else {
                console.log('JsBarcode库已加载');
                initPage();
            }
        }

        // 在页面加载时检查
        window.addEventListener('load', function() {
            checkBarcodeLibrary();
        });
    </script>
</body>
</html>            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background: linear-gradient(135deg, #a6d1ff 0%, #c2e9fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: #333;
        }
        
        body.theme-dark {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-color);
        }
        
        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .loader-content {
            text-align: center;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(37, 117, 252, 0.3);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 落叶动画效果 */
        .leaf {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ffd700;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            opacity: 0.7;
            animation: falling linear infinite;
            z-index: 0;
        }
        
        @keyframes falling {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* 玻璃水滴型卡片设计 */
        .card {
            background: var(--glass-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .card {
            background: var(--card-bg);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.5) 0%, rgba(106, 17, 203, 0.5) 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .card-header i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .card:hover .card-header i {
            transform: scale(1.1);
        }
        
        .card-header h2 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .theme-dark .card-header h2 {
            color: var(--text-color);
        }
        
        .login-section {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .login-card {
            flex: 1;
            min-width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .form-group label {
            color: #ccc;
        }
        
        /* 玻璃水滴型输入框 */
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
        }
        
        .theme-dark .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }
        
        .form-control:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .form-control:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 层次感按钮设计 */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:hover::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #1a68e8 0%, #5a0fb5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 117, 252, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(37, 117, 252, 0.4);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, #219955 100%);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d35400 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400 0%, #ba4a00 100%);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7a7d 100%);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }
        
        .barcode-scan {
            text-align: center;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .barcode-scan:hover {
            border-color: rgba(37, 117, 252, 0.7);
            background: rgba(37, 117, 252, 0.1);
        }
        
        .barcode-scan i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        
        .barcode-scan:hover i {
            transform: scale(1.1);
        }
        
        .barcode-scan p {
            color: #666;
            font-size: 16px;
        }
        
        .theme-dark .barcode-scan p {
            color: #ccc;
        }
        
        .dashboard {
            display: none;
        }
        
        .user-info {
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.7) 0%, rgba(106, 17, 203, 0.7) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .user-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .points {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: var(--dark);
        }
        
        .theme-dark .tab {
            color: var(--text-color);
        }
        
        .tab.active {
            border-bottom: 3px solid rgba(37, 117, 252, 0.7);
            color: var(--primary);
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .prize-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .prize-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .prize-image {
            width: 100%;
            height: 150px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .theme-dark .prize-image {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover .prize-image {
            transform: scale(1.05);
        }
        
        .prize-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .prize-points {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .admin-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .users-table, .history-table, .prizes-table, .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th, .users-table td,
        .history-table th, .history-table td,
        .prizes-table th, .prizes-table td,
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        
        .users-table th, .history-table th, .prizes-table th, .leaderboard-table th {
            background: rgba(248, 249, 250, 0.5);
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .users-table th, 
        .theme-dark .history-table th, 
        .theme-dark .prizes-table th, 
        .theme-dark .leaderboard-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }
        
        .users-table tr:hover, .history-table tr:hover, .prizes-table tr:hover, .leaderboard-table tr:hover {
            background: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .users-table tr:hover, 
        .theme-dark .history-table tr:hover, 
        .theme-dark .prizes-table tr:hover, 
        .theme-dark .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .action-btn {
            padding: 6px 12px;
            margin-right: 5px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        /* 更醒目的成就解锁通知 */
        .achievement-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px 40px;
            background: linear-gradient(135deg, #ffd700 0%, #ff9500 100%);
            color: #000;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 0 50px rgba(255, 215, 0, 0.5);
            display: none;
            z-index: 9999;
            animation: achievementPopup 0.6s ease-out, achievementFloat 3s ease-in-out 0.6s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 3px solid #fff;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .achievement-notification.unlocked {
            display: block;
        }
        
        .achievement-notification h3 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #000;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .achievement-notification p {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
        }
        
        .achievement-notification .reward {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            margin-top: 10px;
        }
        
        .achievement-notification-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ff0000;
            animation: achievementIconSpin 1s ease-in-out 1.5s;
        }
        
        @keyframes achievementPopup {
            0% {
                transform: translate(-50%, -50%) scale(0.1);
                opacity: 0;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes achievementFloat {
            0% {
                transform: translate(-50%, -50%);
            }
            25% {
                transform: translate(-50%, -55%);
            }
            50% {
                transform: translate(-50%, -50%);
            }
            75% {
                transform: translate(-50%, -52%);
            }
            100% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        
        @keyframes achievementIconSpin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.3);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .modal-content {
            background: var(--card-bg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .modal-header h3 {
            color: var(--dark);
            font-size: 1.5rem;
        }
        
        .theme-dark .modal-header h3 {
            color: var(--text-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--dark);
        }
        
        .theme-dark .close-btn:hover {
            color: var(--text-color);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            transition: background-color 0.2s;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .history-item:hover {
            background-color: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .history-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-points {
            font-weight: bold;
        }
        
        .points-positive {
            color: var(--success);
        }
        
        .points-negative {
            color: var(--danger);
        }
        
        .barcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
        }
        
        .theme-dark .barcode-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .barcode-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: white;
        }
        
        .barcode-placeholder {
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .theme-dark .barcode-placeholder {
            color: #ccc;
        }
        
        .scan-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .theme-dark #scanner-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .scan-line {
            width: 80%;
            height: 2px;
            background: var(--primary);
            position: relative;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: -50%; }
            100% { top: 150%; }
        }
        
        .scan-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-barcode {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }
        
        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* 玻璃水滴型登录选项按钮 */
        .login-option-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .login-option-btn {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .login-option-btn.active {
            background: rgba(37, 117, 252, 0.3);
            color: white;
            border-color: rgba(37, 117, 252, 0.5);
        }
        
        .login-option-btn:hover {
            background: rgba(37, 117, 252, 0.2);
            transform: translateY(-2px);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .data-management {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-management .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .stat-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .stat-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .theme-dark .stat-label {
            color: #ccc;
        }
        
        /* 优化选项框样式 - 更圆滑、半透明 */
        .reason-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }
        
        .theme-dark .reason-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .reason-select:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .reason-select:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .reason-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: inherit;
        }
        
        .theme-dark .reason-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-tier {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .tier-king {
            background-color: #ffd900;
            color: #000;
        }
        
        .tier-diamond {
            background-color: #9035F8;
            color: white;
        }
        
        .tier-platinum {
            background-color: #75c8ff;
            color: #000;
        }
        
        .tier-gold {
            background-color: #ff8904;
            color: white;
        }
        
        .tier-silver {
            background-color: #5fecfc;
            color: #000;
        }
        
        .tier-bronze {
            background-color: brown;
            color: white;
        }
        
        /* 排行榜样式 - 前三名更醒目 */
        .leaderboard-container {
            display: flex;
            gap: 25px;
            margin-top: 20px;
        }
        
        .leaderboard-table-container {
            flex: 2;
        }
        
        .leaderboard-table tr.top-three {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-left: 4px solid #ffd700;
        }
        
        .leaderboard-table tr:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.15) 100%);
            border-left: 4px solid #ffd700;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(192, 192, 192, 0.15) 100%);
            border-left: 4px solid #c0c0c0;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(205, 127, 50, 0.15) 100%);
            border-left: 4px solid #cd7f32;
            font-weight: bold;
        }
        
        .theme-dark .leaderboard-table tr:nth-child(1),
        .theme-dark .leaderboard-table tr:nth-child(2),
        .theme-dark .leaderboard-table tr:nth-child(3) {
            color: white;
        }
        
        .pie-chart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .pie-chart-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .pie-chart {
            width: 250px;
            height: 250px;
            position: relative;
        }
        
        .pie-chart canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* 成就系统样式 */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .achievement-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .achievement-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(50%);
        }
        
        .achievement-card.unlocked {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }
        
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .achievement-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 32px;
            color: white;
            transition: transform 0.3s ease;
        }
        
        .achievement-card:hover .achievement-icon {
            transform: scale(1.1) rotate(10deg);
        }
        
        .achievement-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .theme-dark .achievement-name {
            color: var(--text-color);
        }
        
        .achievement-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .theme-dark .achievement-description {
            color: #ccc;
        }
        
        .achievement-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .achievement-unlocked {
            background: var(--success);
            color: white;
        }
        
        .achievement-locked {
            background: #95a5a6;
            color: white;
        }
        
        .achievement-progress {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .achievement-progress-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .theme-dark .achievement-progress-text {
            color: #ccc;
        }
        
        .achievement-reward {
            margin-top: 10px;
            color: var(--warning);
            font-weight: 600;
        }
        
        /* 动画定义 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes achievementUnlock {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 0 30px rgba(46, 204, 113, 0.8); }
            100% { transform: scale(1); }
        }
        
        /* 新增的颜色设定 */
        #activeUsers,
        #activeUsers + .stat-label {
            color: #ffd900; /* 王者用户 */
        }

        #activeUser4,
        #activeUser4 + .stat-label {
            color: #9035F8; /* 钻石用户 */
        }

        #activeUser3,
        #activeUser3 + .stat-label {
            color: #75c8ff; /* 铂金用户 */
        }

        #activeUser2,
        #activeUser2 + .stat-label {
            color: #ff8904; /* 黄金用户 */
        }

        #activeUser1,
        #activeUser1 + .stat-label {
            color: #5fecfc; /* 白银用户 */
        }

        #activeUser0,
        #activeUser0 + .stat-label {
            color: brown; /* 青铜用户 */
        }
        
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* 徽章样式 */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .login-section {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .prizes-grid {
                grid-template-columns: 1fr;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .users-table, .history-table, .prizes-table, .leaderboard-table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .login-options {
                flex-direction: column;
            }
            
            .data-management {
                flex-direction: column;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-container {
                flex-direction: column;
            }
            
            .pie-chart {
                width: 200px;
                height: 200px;
            }
            
            .achievement-notification {
                padding: 20px 25px;
            }
            
            .achievement-notification h3 {
                font-size: 1.5rem;
            }
            
            .achievement-notification p {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h3>加載中...</h3>
            <p>正在初始化系統</p>
        </div>
    </div>
    
    <!-- 成就解锁通知 -->
    <div class="achievement-notification" id="achievementNotification">
        <div class="achievement-notification-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <h3>成就解鎖！</h3>
        <p id="achievementNotificationName">成就名稱</p>
        <p id="achievementNotificationDesc">成就描述</p>
        <div class="reward" id="achievementNotificationReward">獎勵: +0積分</div>
    </div>
    
    <!-- 落叶动画元素 -->
    <div id="leaves-container"></div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <h1>明馬二樓宿舍積分兌換系統</h1>
            <p>明愛馬鞍山中學二樓宿舍專用</p>
        </div>
        
        <!-- 登陸區域 -->
        <div class="login-section" id="loginSection">
            <!-- 用戶登錄 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user"></i>
                    <h2>用戶登錄</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="userCodeLoginBtn">用戶編號登陸</div>
                    <div class="login-option-btn" id="userBarcodeLoginBtn">QRcode登陸</div>
                </div>
                
                <div id="userCodeLoginForm">
                    <div class="form-group">
                        <label for="userIdInput">用戶編號</label>
                        <input type="text" id="userIdInput" class="form-control" placeholder="輸入用戶編號">
                    </div>
                    <button class="btn btn-block" id="userLoginBtn">用戶登錄</button>
                </div>
                
                <div id="userBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="userBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
                
                <div class="user-info" style="display: none;" id="userInfo">
                    <div>
                        <h3 id="userName">张三</h3>
                        <p>用户编号: <span id="userId">U1001</span></p>
                    </div>
                    <div class="points" id="userPoints">1500</div>
                </div>
            </div>
            
            <!-- 管理员登录 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user-shield"></i>
                    <h2>管理员登录</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="adminCodeLoginBtn">管理員編號登陸</div>
                    <div class="login-option-btn" id="adminBarcodeLoginBtn">管理員QRcode登陸</div>
                </div>
                
                <div id="adminCodeLoginForm">
                    <div class="form-group">
                        <label for="adminId">管理員編號</label>
                        <input type="text" id="adminId" class="form-control" placeholder="輸入管理員編號">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">管理員密碼</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="請輸入管理員密碼">
                    </div>
                    
                    <button class="btn btn-block" id="adminLoginBtn">管理員登陸</button>
                </div>
                
                <div id="adminBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="adminBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户仪表盘 -->
        <div class="dashboard card" id="userDashboard">
            <div class="card-header">
                <i class="fas fa-gift"></i>
                <h2>積分兌換中心</h2>
            </div>
            
            <div class="user-info">
                <div>
                    <h3 id="dashboardUserName">张三</h3>
                    <p>用戶編號: <span id="dashboardUserId">U1001</span></p>
                    <p>QRcode編碼: <span id="dashboardUserBarcode">BARCODE001</span></p>
                    <p>段位: <span id="dashboardUserTier">青銅</span></p>
                </div>
                <div>
                    <div class="points" id="dashboardUserPoints">1500</div>
                    <div style="text-align: right;">累積積分: <span id="dashboardUserTotalPoints">2500</span></div>
                </div>
            </div>
            
            <div class="user-barcode">
                <h4>我的QRcode</h4>
                <div id="userBarcodeDisplay"></div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="prizes">獎品兌換</div>
                <div class="tab" data-tab="history">積分歷史</div>
                <div class="tab" data-tab="leaderboard">排行榜</div>
                <div class="tab" data-tab="achievements">成就系統</div>
            </div>
            
            <div class="tab-content active" id="prizes-tab">
                <h3 style="margin-bottom: 15px;">可用獎品</h3>
                <div class="prizes-grid" id="prizesGrid">
                    <!-- 奖品将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <h3 style="margin-bottom: 15px;">積分歷史紀錄</h3>
                <div id="userHistoryContent">
                    <!-- 用户积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="userLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="tierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="pieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="achievements-tab">
                <h3 style="margin-bottom: 15px;">成就系統</h3>
                <div class="user-stats" style="margin-bottom: 25px;">
                    <div class="stat-card">
                        <div class="stat-value" id="achievementUnlocked">0</div>
                        <div class="stat-label">已解鎖成就</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementTotal">0</div>
                        <div class="stat-label">總成就數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="achievementProgress">0%</div>
                        <div class="stat-label">成就進度</div>
                    </div>
                </div>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- 成就将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="userLogoutBtn">退出登陸</button>
        </div>
        
        <!-- 管理员仪表盘 -->
        <div class="dashboard card" id="adminDashboard">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <h2>積分管理系統</h2>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="users">用戶管理</div>
                <div class="tab" data-tab="prizes-admin">獎品管理</div>
                <div class="tab" data-tab="history-admin">積分歷史</div>
                <div class="tab" data-tab="leaderboard-admin">排行榜</div>
                <div class="tab" data-tab="system-admin">系統管理</div>
            </div>
            
            <div class="tab-content active" id="users-tab">
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">總積分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">👑👑👑王者用戶🏅️🏅️🏅️</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser4">0</div>
                        <div class="stat-label">💎鑽石用戶💎</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser3">0</div>
                        <div class="stat-label">💍鉑金用戶💍</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser2">0</div>
                        <div class="stat-label">✨黃金用戶✨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser1">0</div>
                        <div class="stat-label">🥈白銀用戶🥈</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser0">0</div>
                        <div class="stat-label">.🔥青銅用戶🔥.</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchUser" class="form-control" placeholder="輸入用戶編號·姓名或QRcode編碼">
                    <button class="btn" id="searchUserBtn">搜索</button>
                    <button class="btn btn-secondary" id="clearSearchBtn">清除</button>
                </div>
                
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="pointsChange">積分變更</label>
                        <input type="number" id="pointsChange" class="form-control" placeholder="輸入積分變更值">
                    </div>
                    <div class="form-group">
                        <label for="pointsReason">變更原因</label>
                        <select id="pointsReason" class="reason-select">
                            <option value="">-- 選擇原因 --</option>
                            <option value="任務獎勵">任務獎勵</option>
                            <option value="活動獎勵">活動獎勵</option>
                            <option value="挑戰獎勵">挑戰獎勵</option>
                            <option value="閱讀獎勵">閱讀獎勵</option>
                            <option value="管理員調整">管理員調整</option>
                            <option value="其他">其他</option>
                        </select>
                        <input type="text" id="customReason" class="reason-input" placeholder="輸入其他原因" style="display: none;">
                    </div>
                    <button class="btn" id="updatePointsBtn" style="align-self: flex-end;">更新積分</button>
                    <button class="btn btn-success" id="addUserBtn" style="align-self: flex-end;">添加用戶</button>
                    <button class="btn btn-info" id="exportUsersBtn" style="align-self: flex-end;">導出用戶</button>
                </div>
                
                <h3>用戶列表</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>用戶編號</th>
                            <th>姓名</th>
                            <th>QRcode編碼</th>
                            <th>當前積分</th>
                            <th>累積積分</th>
                            <th>段位</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- 用户数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="prizes-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="prizeName">獎品名稱</label>
                        <input type="text" id="prizeName" class="form-control" placeholder="輸入獎品名稱">
                    </div>
                    <div class="form-group">
                        <label for="prizePoints">所需積分</label>
                        <input type="number" id="prizePoints" class="form-control" placeholder="輸入所需積分" min="1">
                    </div>
                    <div class="form-group">
                        <label for="prizeIcon">圖標</label>
                        <input type="text" id="prizeIcon" class="form-control" placeholder="輸入FontAwesome圖標名稱" value="fa-gift">
                    </div>
                    <button class="btn btn-success" id="addPrizeBtn" style="align-self: flex-end;">添加獎品</button>
                    <button class="btn btn-info" id="exportPrizesBtn" style="align-self: flex-end;">導出獎品</button>
                </div>
                
                <h3>獎品列表</h3>
                <table class="prizes-table">
                    <thead>
                        <tr>
                            <th>獎品ID</th>
                            <th>獎品名稱</th>
                            <th>所需積分</th>
                            <th>圖標</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="prizesTableBody">
                        <!-- 奖品数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="history-admin-tab">
                <div class="search-box">
                    <input type="text" id="searchHistoryUser" class="form-control" placeholder="輸入用戶編號、姓名或QRcode編碼">
                    <button class="btn" id="searchHistoryBtn">搜索歷史紀錄</button>
                    <button class="btn btn-secondary" id="clearHistorySearchBtn">清除</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="exportHistoryBtn">導出歷史紀錄</button>
                    <button class="btn btn-warning" id="clearHistoryBtn">清空歷史紀錄</button>
                </div>
                
                <h3>積分歷史紀錄</h3>
                <div id="adminHistoryContent">
                    <!-- 管理员查看的积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-admin-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="adminLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="adminTierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="adminPieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="system-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="currentPassword">當前密碼</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="輸入當前密碼">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密碼</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="輸入新密碼">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">確認新密碼</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="再次輸入新密碼">
                    </div>
                    <button class="btn btn-warning" id="changePasswordBtn" style="align-self: flex-end;">修改密碼</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="importDataBtn">導入歷史數據</button>
                    <button class="btn btn-success" id="exportDataBtn">導出所有數據</button>
                    <button class="btn btn-danger" id="resetDataBtn">重置所有數據</button>
                </div>
                
                <div class="form-group">
                    <label for="dataFile">選擇數據文件 (JSON格式)</label>
                    <input type="file" id="dataFile" class="form-control" accept=".json">
                </div>
                
                <h3>系统信息</h3>
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="systemUsers">0</div>
                        <div class="stat-label">用戶數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemPrizes">0</div>
                        <div class="stat-label">獎品數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemHistory">0</div>
                        <div class="stat-label">歷史紀錄</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemAdmins">0</div>
                        <div class="stat-label">管理員數量</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="adminLogoutBtn">退出登陸</button>
        </div>
    </div>
    
    <!-- 添加用户模态框 -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新用戶</h3>
                <button class="close-btn" id="closeAddUserModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newUserName">用户姓名</label>
                <input type="text" id="newUserName" class="form-control" placeholder="請輸入用户姓名">
            </div>
            <div class="form-group">
                <label for="newUserId">用户編號</label>
                <input type="text" id="newUserId" class="form-control" placeholder="請輸入用户編號">
            </div>
            <div class="form-group">
                <label for="newUserPoints">初始積分</label>
                <input type="number" id="newUserPoints" class="form-control" value="0" min="0">
            </div>
            <div class="form-group">
                <label>生成的QRcode編碼: <span id="generatedBarcodeCode">BARCODE001</span></label>
            </div>
            <div class="barcode-container" id="newUserBarcode"></div>
            <button class="btn btn-success btn-block" id="confirmAddUser">確認添加用户</button>
        </div>
    </div>
    
    <!-- 编辑奖品模态框 -->
    <div class="modal" id="editPrizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯獎品</h3>
                <button class="close-btn" id="closeEditPrizeModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editPrizeName">獎品名稱</label>
                <input type="text" id="editPrizeName" class="form-control" placeholder="請輸入獎品名稱">
            </div>
            <div class="form-group">
                <label for="editPrizePoints">所需積分</label>
                <input type="number" id="editPrizePoints" class="form-control" placeholder="請輸入所需積分" min="1">
            </div>
            <div class="form-group">
                <label for="editPrizeIcon">圖標類名</label>
                <input type="text" id="editPrizeIcon" class="form-control" placeholder="輸入FontAwesome圖標類名">
            </div>
            <input type="hidden" id="editPrizeId">
            <button class="btn btn-success btn-block" id="confirmEditPrize">确认修改</button>
        </div>
    </div>
    
    <!-- 条形码扫描模态框 -->
    <div class="modal" id="barcodeScannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>掃描QRcode</h3>
                <button class="close-btn" id="closeScannerModal">&times;</button>
            </div>
            <div class="scan-area">
                <div id="scanner-container">
                    <!-- 摄像头预览将在这里显示 -->
                </div>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div class="scan-controls">
                <button class="btn" id="startScannerBtn">開始掃描</button>
                <button class="btn btn-danger" id="stopScannerBtn" style="display: none;">停止掃描</button>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>掃描結果: <span id="scanResult">等待掃描...</span></label>
            </div>
            <button class="btn btn-success btn-block" id="confirmScanBtn" style="display: none;">確認此QRcode編碼正確？</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // 创建落叶效果
        function createLeaves() {
            const leavesContainer = document.getElementById('leaves-container');
            const leafCount = 15; // 落叶数量
            
            for (let i = 0; i < leafCount; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                
                // 随机位置
                const left = Math.random() * 100;
                leaf.style.left = left + 'vw';
                
                // 随机大小
                const size = 15 + Math.random() * 20;
                leaf.style.width = size + 'px';
                leaf.style.height = size + 'px';
                
                // 随机动画延迟和持续时间
                const delay = Math.random() * 10;
                const duration = 5 + Math.random() * 10;
                leaf.style.animationDelay = delay + 's';
                leaf.style.animationDuration = duration + 's';
                
                leavesContainer.appendChild(leaf);
            }
        }
        
        // 用户数据存储
        let users = JSON.parse(localStorage.getItem('barcodePointsUsers')) || [
            { 
                id: 'U1001', 
                name: '张三', 
                barcodeCode: 'USER001', 
                points: 1500, 
                totalPoints: 2500,
                tier: '鉑金',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅', '大佬帶帶我'],
                achievementData: {}
            },
            { 
                id: 'U1002', 
                name: '李四', 
                barcodeCode: 'USER002', 
                points: 800, 
                totalPoints: 1200,
                tier: '黃金',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅'],
                achievementData: {}
            },
            { 
                id: 'U1003', 
                name: '王五', 
                barcodeCode: 'USER003', 
                points: 2200, 
                totalPoints: 3200,
                tier: '鑽石',
                isAdmin: false,
                achievements: ['新手求帶！😭', '低等貴族🫅', '中等貴族✨', '大佬帶帶我'],
                achievementData: {}
            },
            { 
                id: 'wwlwcf002', 
                name: '管理员', 
                barcodeCode: 'wwlwcf002', 
                points: 0, 
                totalPoints: 0,
                tier: '',
                isAdmin: true,
                achievements: [],
                achievementData: {}
            }
        ];
        
        // 奖品数据存储
        let prizes = JSON.parse(localStorage.getItem('barcodePointsPrizes')) || [
            { id: 'P001', name: '咖啡券', points: 200, icon: 'fa-mug-hot' },
            { id: 'P002', name: '电影票', points: 500, icon: 'fa-film' },
            { id: 'P003', name: '蓝牙耳机', points: 1500, icon: 'fa-headphones' },
            { id: 'P004', name: '智能手表', points: 3000, icon: 'fa-clock' },
            { id: 'P005', name: '平板电脑', points: 5000, icon: 'fa-tablet-alt' },
            { id: 'P006', name: '购物卡', points: 1000, icon: 'fa-shopping-bag' }
        ];
        
        // 积分历史记录存储
        let pointsHistory = JSON.parse(localStorage.getItem('barcodePointsHistory')) || [
            { userId: 'U1001', timestamp: new Date('2023-10-01 09:30:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-05 14:20:00').getTime(), pointsChange: -200, reason: '兑换咖啡券' },
            { userId: 'U1001', timestamp: new Date('2023-10-10 11:15:00').getTime(), pointsChange: 500, reason: '活动奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-15 15:40:00').getTime(), pointsChange: 800, reason: '管理员调整' },
            { userId: 'U1002', timestamp: new Date('2023-10-02 10:45:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1002', timestamp: new Date('2023-10-07 16:30:00').getTime(), pointsChange: 300, reason: '完成任务' },
            { userId: 'U1003', timestamp: new Date('2023-10-03 08:20:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-08 13:10:00').getTime(), pointsChange: 1000, reason: '推荐用户奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-12 17:25:00').getTime(), pointsChange: 400, reason: '活动奖励' }
        ];
        
        // 修改后的成就系统
        const achievements = [
            { 
                id: 'new_user', 
                name: '新手求帶！😭', 
                description: '積分達到100分', 
                icon: 'fa-baby', 
                reward: '+20積分',
                condition: (user, data) => user.totalPoints >= 100,
                progress: (user, data) => Math.min(100, (user.totalPoints / 100) * 100)
            },
            { 
                id: 'points_collector_1', 
                name: '低等貴族🫅', 
                description: '累積積分達到500點', 
                icon: 'fa-crown', 
                reward: '+100積分',
                condition: (user, data) => user.totalPoints >= 500,
                progress: (user, data) => Math.min(100, (user.totalPoints / 500) * 100)
            },
            { 
                id: 'points_collector_2', 
                name: '中等貴族✨', 
                description: '累積積分達到1200點', 
                icon: 'fa-gem', 
                reward: '+200積分',
                condition: (user, data) => user.totalPoints >= 1200,
                progress: (user, data) => Math.min(100, (user.totalPoints / 1200) * 100)
            },
            { 
                id: 'points_collector_3', 
                name: '💎高等貴族💎', 
                description: '累積積分達到2000點', 
                icon: 'fa-diamond', 
                reward: '+300積分',
                condition: (user, data) => user.totalPoints >= 2000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 2000) * 100)
            },
            { 
                id: 'points_collector_4', 
                name: '👑全服之王👑', 
                description: '累積積分達到3000點',
                icon: 'fa-trophy', 
                reward: '+500積分',
                condition: (user, data) => user.totalPoints >= 3000,
                progress: (user, data) => Math.min(100, (user.totalPoints / 3000) * 100)
            },
            { 
                id: 'tier_master', 
                name: '大佬帶帶我', 
                description: '達到鉑金段位', 
                icon: 'fa-star', 
                reward: '+100積分',
                condition: (user, data) => user.tier === '鉑金' || user.tier === '鑽石' || user.tier === '王者',
                progress: (user, data) => {
                    const tiers = ['青銅', '白銀', '黃金', '鉑金', '鑽石', '王者'];
                    const currentIndex = tiers.indexOf(user.tier);
                    return Math.min(100, ((currentIndex + 1) / 4) * 100);
                }
            },
            { 
                id: 'exchange_expert', 
                name: '兄弟手頭有點緊啊～', 
                description: '成功兌換5次獎品', 
                icon: 'fa-gift', 
                reward: '+100積分',
                condition: (user, data) => {
                    if (!data || !data.exchangeCount) return false;
                    return data.exchangeCount >= 5;
                },
                progress: (user, data) => {
                    const exchangeCount = data && data.exchangeCount ? data.exchangeCount : 0;
                    return Math.min(100, (exchangeCount / 5) * 100);
                },
                getData: (user) => {
                    const exchangeCount = pointsHistory.filter(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    ).length;
                    return { exchangeCount };
                }
            },
            { 
                id: 'activity_king', 
                name: '活躍之王🤭', 
                description: '每個月有加過積分', // 修改为每个月有加过积分
                icon: 'fa-fire', 
                reward: '+25積分', // 修改为25分
                condition: (user, data) => {
                    if (!data || !data.recentMonthPoints) return false;
                    return data.recentMonthPoints;
                },
                progress: (user, data) => {
                    const recentMonthPoints = data && data.recentMonthPoints ? data.recentMonthPoints : false;
                    return recentMonthPoints ? 100 : 0;
                },
                getData: (user) => {
                    const userHistory = pointsHistory
                        .filter(h => h.userId === user.id && h.pointsChange > 0)
                        .sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (userHistory.length === 0) return { recentMonthPoints: false };
                    
                    // 获取最近30天内的记录
                    const thirtyDaysAgo = new Date().getTime() - (30 * 24 * 60 * 60 * 1000);
                    const recentMonthPoints = userHistory.some(h => h.timestamp >= thirtyDaysAgo);
                    
                    return { recentMonthPoints };
                }
            },
            { 
                id: 'first_exchange', 
                name: '首次兌換', 
                description: '第一次兌換獎品', 
                icon: 'fa-shopping-cart', 
                reward: '+25積分',
                condition: (user, data) => {
                    if (!data || !data.hasExchanged) return false;
                    return data.hasExchanged;
                },
                progress: (user, data) => {
                    const hasExchanged = data && data.hasExchanged ? data.hasExchanged : false;
                    return hasExchanged ? 100 : 0;
                },
                getData: (user) => {
                    const hasExchanged = pointsHistory.some(h => 
                        h.userId === user.id && h.pointsChange < 0 && h.reason.includes('兌換獎品')
                    );
                    return { hasExchanged };
                }
            }
        ];
        
        // 段位划分标准（基于累积积分）
        const tierThresholds = [
            { name: '青銅', min: 0, max: 299, color: 'brown' },
            { name: '白銀', min: 300, max: 599, color: '#5fecfc' },
            { name: '黃金', min: 600, max: 899, color: '#ff8904' },
            { name: '鉑金', min: 900, max: 1199, color: '#75c8ff' },
            { name: '鑽石', min: 1200, max: 1499, color: '#9035F8' },
            { name: '王者', min: 1500, max: Infinity, color: '#ffd900' }
        ];
        
        // 计算用户段位
        function calculateUserTier(totalPoints) {
            for (const tier of tierThresholds) {
                if (totalPoints >= tier.min && totalPoints <= tier.max) {
                    return tier.name;
                }
            }
            return '青銅';
        }
        
        // 获取段位对应的CSS类名
        function getTierClass(tierName) {
            switch(tierName) {
                case '王者': return 'tier-king';
                case '鑽石': return 'tier-diamond';
                case '鉑金': return 'tier-platinum';
                case '黃金': return 'tier-gold';
                case '白銀': return 'tier-silver';
                case '青銅': return 'tier-bronze';
                default: return 'tier-bronze';
            }
        }
        
        // 获取段位对应的颜色
        function getTierColor(tierName) {
            for (const tier of tierThresholds) {
                if (tier.name === tierName) {
                    return tier.color;
                }
            }
            return 'brown';
        }
        
        // 管理员密码
        const adminPassword = 'admin123';
        
        // DOM元素
        const pageLoader = document.getElementById('pageLoader');
        const loginSection = document.getElementById('loginSection');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const userBarcodeScan = document.getElementById('userBarcodeScan');
        const adminBarcodeScan = document.getElementById('adminBarcodeScan');
        const userLoginBtn = document.getElementById('userLoginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const userLogoutBtn = document.getElementById('userLogoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const prizesGrid = document.getElementById('prizesGrid');
        const usersTableBody = document.getElementById('usersTableBody');
        const prizesTableBody = document.getElementById('prizesTableBody');
        const updatePointsBtn = document.getElementById('updatePointsBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const closeAddUserModal = document.getElementById('closeAddUserModal');
        const confirmAddUser = document.getElementById('confirmAddUser');
        const generatedBarcodeCode = document.getElementById('generatedBarcodeCode');
        const newUserBarcode = document.getElementById('newUserBarcode');
        const addPrizeBtn = document.getElementById('addPrizeBtn');
        const editPrizeModal = document.getElementById('editPrizeModal');
        const closeEditPrizeModal = document.getElementById('closeEditPrizeModal');
        const confirmEditPrize = document.getElementById('confirmEditPrize');
        const searchHistoryBtn = document.getElementById('searchHistoryBtn');
        const barcodeScannerModal = document.getElementById('barcodeScannerModal');
        const closeScannerModal = document.getElementById('closeScannerModal');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scanResult = document.getElementById('scanResult');
        const confirmScanBtn = document.getElementById('confirmScanBtn');
        const userIdInput = document.getElementById('userIdInput');
        const userBarcodeDisplay = document.getElementById('userBarcodeDisplay');
        const notification = document.getElementById('notification');
        const achievementNotification = document.getElementById('achievementNotification');
        const achievementNotificationName = document.getElementById('achievementNotificationName');
        const achievementNotificationDesc = document.getElementById('achievementNotificationDesc');
        const achievementNotificationReward = document.getElementById('achievementNotificationReward');
        const userLeaderboardBody = document.getElementById('userLeaderboardBody');
        const adminLeaderboardBody = document.getElementById('adminLeaderboardBody');
        const tierPieChart = document.getElementById('tierPieChart');
        const adminTierPieChart = document.getElementById('adminTierPieChart');
        const pieLegend = document.getElementById('pieLegend');
        const adminPieLegend = document.getElementById('adminPieLegend');
        const themeToggle = document.getElementById('themeToggle');
        const achievementsGrid = document.getElementById('achievementsGrid');
        
        // 登录选项切换
        const userCodeLoginBtn = document.getElementById('userCodeLoginBtn');
        const userBarcodeLoginBtn = document.getElementById('userBarcodeLoginBtn');
        const userCodeLoginForm = document.getElementById('userCodeLoginForm');
        const userBarcodeLoginForm = document.getElementById('userBarcodeLoginForm');
        
        const adminCodeLoginBtn = document.getElementById('adminCodeLoginBtn');
        const adminBarcodeLoginBtn = document.getElementById('adminBarcodeLoginBtn');
        const adminCodeLoginForm = document.getElementById('adminCodeLoginForm');
        const adminBarcodeLoginForm = document.getElementById('adminBarcodeLoginForm');
        
        // 新增功能元素
        const searchUserBtn = document.getElementById('searchUserBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const exportUsersBtn = document.getElementById('exportUsersBtn');
        const exportPrizesBtn = document.getElementById('exportPrizesBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearHistorySearchBtn = document.getElementById('clearHistorySearchBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const dataFile = document.getElementById('dataFile');
        const pointsReason = document.getElementById('pointsReason');
        const customReason = document.getElementById('customReason');
        
        // 当前登录的用户和管理员
        let currentUser = null;
        let currentAdmin = false;
        let scannerActive = false;
        let scannedBarcode = '';
        let scannerType = '';
        let pieChartAnimations = {};
        let achievementNotificationTimeout = null;
        
        // 修复条形码生成函数
        function generateBarcode(code, container) {
            container.innerHTML = '';
            
            if (!code || code.trim() === '') {
                container.innerHTML = '<div class="barcode-placeholder">条形码编码为空</div>';
                return;
            }
            
            try {
                // 创建canvas元素
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                
                // 使用JsBarcode生成条形码
                JsBarcode(canvas, code, {
                    format: "CODE128",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontOptions: "bold",
                    fontSize: 16,
                    textMargin: 10,
                    margin: 10,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
                
                console.log('QRcode生成成功:', code);
            } catch (error) {
                console.error('QRcode生成失敗:', error);
                container.innerHTML = '<div class="barcode-placeholder">QRcode生成失敗: ' + error.message + '</div>';
            }
        }

        // 显示成就解锁通知
        function showAchievementNotification(achievement) {
            achievementNotificationName.textContent = achievement.name;
            achievementNotificationDesc.textContent = achievement.description;
            achievementNotificationReward.textContent = `獎勵: ${achievement.reward}`;
            
            // 设置图标
            const iconElement = achievementNotification.querySelector('.achievement-notification-icon i');
            iconElement.className = `fas ${achievement.icon}`;
            
            // 显示通知
            achievementNotification.classList.add('unlocked');
            
            // 播放声音（如果有的话）
            playAchievementSound();
            
            // 4秒后自动隐藏
            if (achievementNotificationTimeout) {
                clearTimeout(achievementNotificationTimeout);
            }
            
            achievementNotificationTimeout = setTimeout(() => {
                achievementNotification.classList.remove('unlocked');
            }, 4000);
        }
        
        // 播放成就解锁声音
        function playAchievementSound() {
            // 这里可以添加音效，如果需要的话
            // 例如：new Audio('achievement.mp3').play();
        }

        // 初始化页面
        function initPage() {
            // 隐藏加载动画
            setTimeout(() => {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 500);
            }, 1500); // 保持初始化时间
            
            // 创建落叶效果
            createLeaves();
            
            // 保存初始数据到localStorage
            saveDataToStorage();
            
            // 只渲染必要的组件，延迟渲染其他组件
            renderPrizes();
            renderUsersTable();
            renderPrizesTable();
            setupTabs();
            setupLoginOptions();
            updateSystemStats();
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 检查是否已保存主题偏好
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('theme-dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // 积分变更原因选择事件
            pointsReason.addEventListener('change', function() {
                if (this.value === '其他') {
                    customReason.style.display = 'block';
                } else {
                    customReason.style.display = 'none';
                    customReason.value = '';
                }
            });
            
            // 用户登录按钮事件
            userLoginBtn.addEventListener('click', function() {
                const userId = userIdInput.value;
                if (userId) {
                    loginWithUserId(userId);
                } else {
                    showNotification('請輸入用戶編號', 'error');
                }
            });
            
            // 用户条形码扫描事件
            userBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('user');
            });
            
            // 管理员条形码扫描事件
            adminBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('admin');
            });
            
            // 管理员登录按钮事件
            adminLoginBtn.addEventListener('click', function() {
                const adminId = document.getElementById('adminId').value;
                const password = document.getElementById('adminPassword').value;
                
                if (adminId && password) {
                    loginAdminWithCredentials(adminId, password);
                } else {
                    showNotification('請輸入管理員編號和密碼', 'error');
                }
            });
            
            // 用户退出登录
            userLogoutBtn.addEventListener('click', function() {
                currentUser = null;
                showLoginSection();
                showNotification('已登出用戶登錄', 'info');
            });
            
            // 管理员退出登录
            adminLogoutBtn.addEventListener('click', function() {
                // 询问是否要下载备份
                if (confirm('是否要下載最新的系統文件？')) {
                    exportAllData();
                }
                currentAdmin = false;
                document.getElementById('adminId').value = '';
                document.getElementById('adminPassword').value = '';
                showLoginSection();
                showNotification('已登出管理員登陸', 'info');
            });
            
            // 更新积分按钮事件 - 添加成功提示
            updatePointsBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                const pointsChange = parseInt(document.getElementById('pointsChange').value);
                let reason = pointsReason.value;
                
                if (reason === '其他') {
                    reason = customReason.value;
                }
                
                if (!searchTerm || isNaN(pointsChange)) {
                    showNotification('請輸入有效的變更值和用戶編號', 'error');
                    return;
                }
                
                if (!reason) {
                    showNotification('請選擇或輸入變更原因', 'error');
                    return;
                }
                
                const user = users.find(u => 
                    u.id === searchTerm || 
                    u.name === searchTerm || 
                    u.barcodeCode === searchTerm
                );
                
                if (user) {
                    user.points += pointsChange;
                    if (user.points < 0) user.points = 0;
                    
                    // 如果是增加积分，同时增加累积积分
                    if (pointsChange > 0) {
                        user.totalPoints += pointsChange;
                    }
                    
                    // 更新段位
                    user.tier = calculateUserTier(user.totalPoints);
                    
                    // 检查成就
                    checkAchievements(user);
                    
                    // 记录积分变更历史
                    pointsHistory.push({
                        userId: user.id,
                        timestamp: new Date().getTime(),
                        pointsChange: pointsChange,
                        reason: reason
                    });
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    renderUsersTable();
                    updateSystemStats();
                    document.getElementById('pointsChange').value = '';
                    pointsReason.value = '';
                    customReason.value = '';
                    customReason.style.display = 'none';
                    
                    // 添加成功提示
                    showNotification(`成功更新 ${user.name} 的積分！變更: ${pointsChange > 0 ? '+' : ''}${pointsChange}`, 'success');
                } else {
                    showNotification('未找到該用戶', 'error');
                }
            });
            
            // 添加用户按钮事件
            addUserBtn.addEventListener('click', function() {
                // 生成随机条形码编码
                const newBarcodeCode = generateBarcodeCode();
                generatedBarcodeCode.textContent = newBarcodeCode;
                
                // 生成条形码 - 添加延迟确保DOM更新
                setTimeout(() => {
                    generateBarcode(newBarcodeCode, newUserBarcode);
                }, 100);
                
                // 显示模态框
                addUserModal.style.display = 'flex';
            });
            
            // 关闭添加用户模态框
            closeAddUserModal.addEventListener('click', function() {
                addUserModal.style.display = 'none';
            });
            
            // 确认添加用户
            confirmAddUser.addEventListener('click', function() {
                const userName = document.getElementById('newUserName').value;
                const userId = document.getElementById('newUserId').value;
                const userPoints = parseInt(document.getElementById('newUserPoints').value) || 0;
                const barcodeCode = generatedBarcodeCode.textContent;
                
                if (!userName || !userId) {
                    showNotification('請輸入用戶姓名或編號', 'error');
                    return;
                }
                
                // 检查用户编号是否已存在
                if (users.find(u => u.id === userId)) {
                    showNotification('用戶編號已存在，請使用其他編號', 'error');
                    return;
                }
                
                // 计算段位
                const userTier = calculateUserTier(userPoints);
                
                // 添加新用户
                const newUser = {
                    id: userId,
                    name: userName,
                    barcodeCode: barcodeCode,
                    points: userPoints,
                    totalPoints: userPoints, // 初始累积积分等于当前积分
                    tier: userTier, // 初始段位
                    isAdmin: false,
                    achievements: [], // 初始成就
                    achievementData: {} // 初始成就数据
                };
                
                // 检查初始成就
                checkAchievements(newUser);
                
                users.push(newUser);
                
                // 记录初始积分历史
                if (userPoints > 0) {
                    pointsHistory.push({
                        userId: userId,
                        timestamp: new Date().getTime(),
                        pointsChange: userPoints,
                        reason: '初始積分'
                    });
                }
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderUsersTable();
                updateSystemStats();
                
                // 关闭模态框并重置表单
                addUserModal.style.display = 'none';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserId').value = '';
                document.getElementById('newUserPoints').value = '0';
                
                showNotification(`成功添加用户 ${userName}，条形码编码: ${barcodeCode}`, 'success');
            });
            
            // 添加奖品按钮事件
            addPrizeBtn.addEventListener('click', function() {
                const prizeName = document.getElementById('prizeName').value;
                const prizePoints = parseInt(document.getElementById('prizePoints').value);
                const prizeIcon = document.getElementById('prizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的獎品信息', 'error');
                    return;
                }
                
                // 生成奖品ID
                const prizeId = generatePrizeId();
                
                // 添加新奖品
                prizes.push({
                    id: prizeId,
                    name: prizeName,
                    points: prizePoints,
                    icon: prizeIcon
                });
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                // 重置表单
                document.getElementById('prizeName').value = '';
                document.getElementById('prizePoints').value = '';
                document.getElementById('prizeIcon').value = 'fa-gift';
                
                showNotification(`成功添加獎品 ${prizeName}`, 'success');
            });
            
            // 关闭编辑奖品模态框
            closeEditPrizeModal.addEventListener('click', function() {
                editPrizeModal.style.display = 'none';
            });
            
            // 确认编辑奖品
            confirmEditPrize.addEventListener('click', function() {
                const prizeId = document.getElementById('editPrizeId').value;
                const prizeName = document.getElementById('editPrizeName').value;
                const prizePoints = parseInt(document.getElementById('editPrizePoints').value);
                const prizeIcon = document.getElementById('editPrizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的奖品信息', 'error');
                    return;
                }
                
                // 更新奖品信息
                const prize = prizes.find(p => p.id === prizeId);
                if (prize) {
                    prize.name = prizeName;
                    prize.points = prizePoints;
                    prize.icon = prizeIcon;
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    // 更新界面
                    renderPrizesTable();
                    renderPrizes();
                    
                    // 关闭模态框
                    editPrizeModal.style.display = 'none';
                    
                    showNotification(`成功更新獎品 ${prizeName}`, 'success');
                }
            });
            
            // 搜索历史记录按钮事件
            searchHistoryBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchHistoryUser').value;
                renderAdminHistory(searchTerm);
            });
            
            // 条形码扫描模态框事件
            closeScannerModal.addEventListener('click', function() {
                closeBarcodeScanner();
            });
            
            startScannerBtn.addEventListener('click', function() {
                startBarcodeScanner();
            });
            
            stopScannerBtn.addEventListener('click', function() {
                stopBarcodeScanner();
            });
            
            confirmScanBtn.addEventListener('click', function() {
                if (scannedBarcode) {
                    if (scannerType === 'user') {
                        loginWithBarcode(scannedBarcode);
                    } else if (scannerType === 'admin') {
                        loginAdminWithBarcode(scannedBarcode);
                    }
                    closeBarcodeScanner();
                }
            });
            
            // 新增功能事件
            searchUserBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                renderUsersTable(searchTerm);
            });
            
            clearSearchBtn.addEventListener('click', function() {
                document.getElementById('searchUser').value = '';
                renderUsersTable();
            });
            
            exportUsersBtn.addEventListener('click', function() {
                exportUsersData();
            });
            
            exportPrizesBtn.addEventListener('click', function() {
                exportPrizesData();
            });
            
            exportHistoryBtn.addEventListener('click', function() {
                exportHistoryData();
            });
            
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有積分歷史紀錄吗？此操作不可恢復！')) {
                    pointsHistory = [];
                    saveDataToStorage();
                    renderAdminHistory();
                    updateSystemStats();
                    showNotification('歷史紀錄已清空', 'success');
                }
            });
            
            clearHistorySearchBtn.addEventListener('click', function() {
                document.getElementById('searchHistoryUser').value = '';
                renderAdminHistory();
            });
            
            changePasswordBtn.addEventListener('click', function() {
                changeAdminPassword();
            });
            
            importDataBtn.addEventListener('click', function() {
                dataFile.click();
            });
            
            exportDataBtn.addEventListener('click', function() {
                exportAllData();
            });
            
            resetDataBtn.addEventListener('click', function() {
                resetSystemData();
            });
            
            dataFile.addEventListener('change', function(e) {
                importData(e);
            });
        }
        
        // 主题切换
        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            if (document.body.classList.contains('theme-dark')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // 设置登录选项切换
        function setupLoginOptions() {
            // 用户登录选项
            userCodeLoginBtn.addEventListener('click', function() {
                userCodeLoginBtn.classList.add('active');
                userBarcodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'block';
                userBarcodeLoginForm.style.display = 'none';
            });
            
            userBarcodeLoginBtn.addEventListener('click', function() {
                userBarcodeLoginBtn.classList.add('active');
                userCodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'none';
                userBarcodeLoginForm.style.display = 'block';
            });
            
            // 管理员登录选项
            adminCodeLoginBtn.addEventListener('click', function() {
                adminCodeLoginBtn.classList.add('active');
                adminBarcodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'block';
                adminBarcodeLoginForm.style.display = 'none';
            });
            
            adminBarcodeLoginBtn.addEventListener('click', function() {
                adminBarcodeLoginBtn.classList.add('active');
                adminCodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'none';
                adminBarcodeLoginForm.style.display = 'block';
            });
        }
        
        // 设置选项卡切换
        function setupTabs() {
            // 用户界面选项卡
            const userTabs = document.querySelectorAll('#userDashboard .tab');
            userTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    userTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#userDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history') {
                        renderUserHistory();
                    } else if (tabId === 'leaderboard') {
                        renderUserLeaderboard();
                        renderTierPieChartWithAnimation(tierPieChart, pieLegend);
                    } else if (tabId === 'achievements') {
                        renderAchievements();
                    }
                });
            });
            
            // 管理员界面选项卡
            const adminTabs = document.querySelectorAll('#adminDashboard .tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    adminTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#adminDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history-admin') {
                        renderAdminHistory();
                    } else if (tabId === 'leaderboard-admin') {
                        renderAdminLeaderboard();
                        renderTierPieChartWithAnimation(adminTierPieChart, adminPieLegend);
                    } else if (tabId === 'system-admin') {
                        updateSystemStats();
                    }
                });
            });
        }
        
        // 使用用户编号登录
        function loginWithUserId(userId) {
            const user = users.find(u => u.id === userId && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('用户編號錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用条形码登录
        function loginWithBarcode(barcode) {
            const user = users.find(u => u.barcodeCode === barcode && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('QRcode錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用管理员凭据登录
        function loginAdminWithCredentials(adminId, password) {
            if (password === adminPassword) {
                const adminUser = users.find(u => u.id === adminId && u.isAdmin);
                if (adminUser) {
                    currentAdmin = true;
                    showAdminDashboard();
                    showNotification('管理員登陸成功！', 'success');
                } else {
                    showNotification('管理員編號錯誤！', 'error');
                }
            } else {
                showNotification('密碼錯誤，請重試！', 'error');
            }
        }
        
        // 使用管理员条形码登录
        function loginAdminWithBarcode(barcode) {
            const adminUser = users.find(u => u.barcodeCode === barcode && u.isAdmin);
            if (adminUser) {
                currentAdmin = true;
                showAdminDashboard();
                showNotification('管理員登錄成功！', 'success');
            } else {
                showNotification('管理員QRcode錯誤！', 'error');
            }
        }
        
        // 打开条形码扫描器
        function openBarcodeScanner(type) {
            scannerType = type;
            barcodeScannerModal.style.display = 'flex';
            scanResult.textContent = '等待掃描...';
            confirmScanBtn.style.display = 'none';
            scannedBarcode = '';
        }
        
        // 关闭条形码扫描器
        function closeBarcodeScanner() {
            barcodeScannerModal.style.display = 'none';
            stopBarcodeScanner();
        }
        
        // 开始条形码扫描
        function startBarcodeScanner() {
            if (scannerActive) return;
            
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.innerHTML = '';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerContainer,
                    constraints: {
                        width: 480,
                        height: 320,
                        facingMode: "environment" // 使用后置攝像頭
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showNotification('無法啟動攝像頭: ' + err, 'error');
                    return;
                }
                Quagga.start();
                scannerActive = true;
                startScannerBtn.style.display = 'none';
                stopScannerBtn.style.display = 'inline-block';
            });
            
            Quagga.onDetected(function(result) {
                if (result && result.codeResult) {
                    scannedBarcode = result.codeResult.code;
                    scanResult.textContent = scannedBarcode;
                    confirmScanBtn.style.display = 'block';
                    showNotification('監測到QRcode: ' + scannedBarcode, 'success');
                    
                    // 自动停止扫描
                    stopBarcodeScanner();
                }
            });
        }
        
        // 停止条形码扫描
        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                startScannerBtn.style.display = 'inline-block';
                stopScannerBtn.style.display = 'none';
            }
        }
        
        // 显示登录区域
        function showLoginSection() {
            loginSection.style.display = 'flex';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            userIdInput.value = '';
        }
        
        // 显示用户仪表盘
        function showUserDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'block';
            adminDashboard.style.display = 'none';
            
            // 更新用户信息
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            document.getElementById('dashboardUserId').textContent = currentUser.id;
            document.getElementById('dashboardUserBarcode').textContent = currentUser.barcodeCode;
            document.getElementById('dashboardUserPoints').textContent = currentUser.points;
            document.getElementById('dashboardUserTotalPoints').textContent = currentUser.totalPoints;
            document.getElementById('dashboardUserTier').textContent = currentUser.tier;
            document.getElementById('dashboardUserTier').className = 'user-tier ' + getTierClass(currentUser.tier);
            
            // 生成用户条形码 - 添加延迟
            setTimeout(() => {
                generateBarcode(currentUser.barcodeCode, userBarcodeDisplay);
            }, 100);
            
            // 重新渲染奖品列表
            renderPrizes();
            
            // 更新成就统计
            updateAchievementStats();
        }
        
        // 显示管理员仪表盘
        function showAdminDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'block';
        }
        
        // 渲染奖品列表（用户界面）
        function renderPrizes() {
            prizesGrid.innerHTML = '';
            
            prizes.forEach(prize => {
                const prizeCard = document.createElement('div');
                prizeCard.className = 'prize-card';
                
                const canAfford = currentUser && currentUser.points >= prize.points;
                
                prizeCard.innerHTML = `
                    <div class="prize-image">
                        <i class="fas ${prize.icon}"></i>
                    </div>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-points">${prize.points} 积分</div>
                    <button class="btn ${canAfford ? '' : 'disabled'}" 
                            ${canAfford ? '' : 'disabled'}
                            onclick="redeemPrize('${prize.id}')">
                        ${canAfford ? '立即兌換' : '積分不足'}
                    </button>
                `;
                
                prizesGrid.appendChild(prizeCard);
            });
        }
        
        // 兑换奖品
        function redeemPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            
            if (currentUser.points >= prize.points) {
                currentUser.points -= prize.points;
                
                // 记录积分变更历史
                pointsHistory.push({
                    userId: currentUser.id,
                    timestamp: new Date().getTime(),
                    pointsChange: -prize.points,
                    reason: `兌換獎品：${prize.name}`
                });
                
                // 检查成就
                checkAchievements(currentUser);
                
                // 保存数据
                saveDataToStorage();
                
                document.getElementById('dashboardUserPoints').textContent = currentUser.points;
                renderPrizes();
                showNotification(`成功兑换 ${prize.name}！`, 'success');
                
                // 如果用户在成就页面，刷新成就显示
                if (document.getElementById('achievements-tab').classList.contains('active')) {
                    renderAchievements();
                    updateAchievementStats();
                }
            } else {
                showNotification('積分不足，无法兑换該獎品', 'error');
            }
        }
        
        // 渲染用户表格 - 移除批量操作相关代码
        function renderUsersTable(searchTerm = '') {
            usersTableBody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = users.filter(user => 
                    user.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.barcodeCode.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.barcodeCode}</td>
                    <td>${user.points}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="selectUser('${user.id}')">选择</button>
                        ${!user.isAdmin ? 
                            `<button class="action-btn" style="background: #f39c12;" onclick="promoteUser('${user.id}')">升级为管理員</button>` : 
                            ''
                        }
                        <button class="action-btn" style="background: #e74c3c;" onclick="deleteUser('${user.id}')">移除人員</button>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            updateUserStats();
        }
        
        // 渲染奖品表格（管理员界面）
        function renderPrizesTable() {
            prizesTableBody.innerHTML = '';
            
            prizes.forEach(prize => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${prize.id}</td>
                    <td>${prize.name}</td>
                    <td>${prize.points}</td>
                    <td><i class="fas ${prize.icon}"></i> ${prize.icon}</td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="editPrize('${prize.id}')">编辑</button>
                        <button class="action-btn" style="background: #e74c3c;" onclick="deletePrize('${prize.id}')">移除人員</button>
                    </td>
                `;
                
                prizesTableBody.appendChild(row);
            });
        }
        
        // 渲染用户积分历史
        function renderUserHistory() {
            const userHistoryContent = document.getElementById('userHistoryContent');
            userHistoryContent.innerHTML = '';
            
            // 获取当前用户的历史记录
            const userHistory = pointsHistory
                .filter(record => record.userId === currentUser.id)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (userHistory.length === 0) {
                userHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            userHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                userHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染管理员查看的积分历史
        function renderAdminHistory(searchTerm = '') {
            const adminHistoryContent = document.getElementById('adminHistoryContent');
            adminHistoryContent.innerHTML = '';
            
            let filteredHistory = pointsHistory;
            
            // 如果提供了搜索条件，过滤历史记录
            if (searchTerm) {
                // 查找匹配的用户
                const matchedUsers = users.filter(u => 
                    u.id.includes(searchTerm) || 
                    u.name.includes(searchTerm) || 
                    u.barcodeCode.includes(searchTerm)
                );
                
                const matchedUserIds = matchedUsers.map(u => u.id);
                filteredHistory = pointsHistory.filter(record => 
                    matchedUserIds.includes(record.userId)
                );
            }
            
            // 按时间排序
            filteredHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredHistory.length === 0) {
                adminHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const user = users.find(u => u.id === record.userId);
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div><strong>${user ? user.name : '未知用户'} (${record.userId})</strong></div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                adminHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染用户排行榜 - 前三名更醒目
        function renderUserLeaderboard() {
            userLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                userLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                userLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染管理员排行榜 - 前三名更醒目
        function renderAdminLeaderboard() {
            adminLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                adminLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                adminLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染成就系统 - 已解锁的成就放在前面
        function renderAchievements() {
            achievementsGrid.innerHTML = '';
            
            if (!currentUser) return;
            
            // 检查并更新用户成就
            checkAchievements(currentUser);
            
            // 将成就分为已解锁和未解锁两组
            const unlockedAchievements = [];
            const lockedAchievements = [];
            
            achievements.forEach(achievement => {
                // 获取成就数据
                const achievementData = achievement.getData ? achievement.getData(currentUser) : {};
                
                // 检查是否已解锁
                const isUnlocked = achievement.condition(currentUser, achievementData);
                const progress = achievement.progress ? achievement.progress(currentUser, achievementData) : (isUnlocked ? 100 : 0);
                
                const achievementObj = {
                    achievement: achievement,
                    isUnlocked: isUnlocked,
                    progress: progress,
                    data: achievementData
                };
                
                if (isUnlocked) {
                    unlockedAchievements.push(achievementObj);
                } else {
                    lockedAchievements.push(achievementObj);
                }
            });
            
            // 先渲染已解锁的成就
            unlockedAchievements.forEach(({ achievement, isUnlocked, progress, data }) => {
                createAchievementCard(achievement, isUnlocked, progress, data);
            });
            
            // 再渲染未解锁的成就
            lockedAchievements.forEach(({ achievement, isUnlocked, progress, data }) => {
                createAchievementCard(achievement, isUnlocked, progress, data);
            });
            
            // 更新成就统计
            updateAchievementStats();
        }
        
        // 创建成就卡片
        function createAchievementCard(achievement, isUnlocked, progress, data) {
            const achievementCard = document.createElement('div');
            achievementCard.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
            
            achievementCard.innerHTML = `
                <div class="achievement-icon">
                    <i class="fas ${achievement.icon}"></i>
                </div>
                <div class="achievement-name">${achievement.name}</div>
                <div class="achievement-description">${achievement.description}</div>
                <div class="achievement-reward">獎勵: ${achievement.reward}</div>
                
                ${!isUnlocked ? `
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="achievement-progress-text">${progress.toFixed(0)}% 完成</div>
                ` : ''}
                
                <div class="achievement-status ${isUnlocked ? 'achievement-unlocked' : 'achievement-locked'}">
                    ${isUnlocked ? '已解鎖' : '未解鎖'}
                </div>
            `;
            
            // 添加解锁动画效果
            if (isUnlocked && !currentUser.achievementData[achievement.id]) {
                achievementCard.style.animation = 'achievementUnlock 0.5s ease';
                currentUser.achievementData[achievement.id] = true;
                saveDataToStorage();
            }
            
            achievementsGrid.appendChild(achievementCard);
        }
        
        // 更新成就统计
        function updateAchievementStats() {
            if (!currentUser) return;
            
            const unlockedCount = achievements.filter(achievement => {
                const achievementData = achievement.getData ? achievement.getData(currentUser) : {};
                return achievement.condition(currentUser, achievementData);
            }).length;
            
            const totalCount = achievements.length;
            const progressPercentage = totalCount > 0 ? Math.round((unlockedCount / totalCount) * 100) : 0;
            
            document.getElementById('achievementUnlocked').textContent = unlockedCount;
            document.getElementById('achievementTotal').textContent = totalCount;
            document.getElementById('achievementProgress').textContent = `${progressPercentage}%`;
        }
        
        // 检查用户成就
        function checkAchievements(user) {
            let newAchievements = [];
            
            achievements.forEach(achievement => {
                const achievementData = achievement.getData ? achievement.getData(user) : {};
                const isUnlocked = achievement.condition(user, achievementData);
                
                if (isUnlocked && !user.achievements.includes(achievement.name)) {
                    user.achievements.push(achievement.name);
                    newAchievements.push(achievement);
                    
                    // 给予成就奖励
                    if (achievement.reward) {
                        const match = achievement.reward.match(/\+(\d+)/);
                        if (match) {
                            const rewardPoints = parseInt(match[1]);
                            user.points += rewardPoints;
                            user.totalPoints += rewardPoints;
                            
                            // 记录奖励
                            pointsHistory.push({
                                userId: user.id,
                                timestamp: new Date().getTime(),
                                pointsChange: rewardPoints,
                                reason: `成就獎勵: ${achievement.name}`
                            });
                            
                            // 更新段位
                            user.tier = calculateUserTier(user.totalPoints);
                        }
                    }
                }
            });
            
            // 如果有新成就，显示通知
            if (newAchievements.length > 0) {
                // 保存数据
                saveDataToStorage();
                
                // 如果当前用户是成就获得者，显示通知
                if (currentUser && currentUser.id === user.id) {
                    // 显示第一个新成就的通知
                    showAchievementNotification(newAchievements[0]);
                    
                    // 如果有多个新成就，稍后显示下一个
                    if (newAchievements.length > 1) {
                        setTimeout(() => {
                            showAchievementNotification(newAchievements[1]);
                        }, 4500);
                    }
                    
                    // 如果用户在成就页面，刷新显示
                    if (document.getElementById('achievements-tab').classList.contains('active')) {
                        renderAchievements();
                        updateAchievementStats();
                    }
                }
            }
            
            return newAchievements;
        }
        
        // 渲染段位饼图 - 带动画效果，更圆润
        function renderTierPieChartWithAnimation(canvasElement, legendElement) {
            // 如果已有动画在进行，取消它
            if (pieChartAnimations[canvasElement.id]) {
                cancelAnimationFrame(pieChartAnimations[canvasElement.id]);
                delete pieChartAnimations[canvasElement.id];
            }
            
            // 统计各段位用户数量
            const tierCounts = {};
            tierThresholds.forEach(tier => {
                tierCounts[tier.name] = 0;
            });
            
            users.filter(u => !u.isAdmin).forEach(user => {
                tierCounts[user.tier]++;
            });
            
            // 过滤掉数量为0的段位
            const filteredTiers = tierThresholds.filter(tier => tierCounts[tier.name] > 0);
            
            // 计算总数
            const totalUsers = users.filter(u => !u.isAdmin).length;
            
            // 生成图例
            legendElement.innerHTML = '';
            filteredTiers.forEach(tier => {
                const percentage = totalUsers > 0 ? ((tierCounts[tier.name] / totalUsers) * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${tier.color};"></div>
                    <span>${tier.name}: ${tierCounts[tier.name]}人 (${percentage}%)</span>
                `;
                legendElement.appendChild(legendItem);
            });
            
            const ctx = canvasElement.getContext('2d');
            const width = canvasElement.width;
            const height = canvasElement.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 * 0.8;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 如果没有数据，显示提示
            if (totalUsers === 0) {
                ctx.fillStyle = '#ccc';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', centerX, centerY);
                return;
            }
            
            // 计算每个扇形的起始和结束角度
            let startAngle = -Math.PI / 2; // 从12点钟方向开始
            const slices = filteredTiers.map(tier => {
                const sliceAngle = (2 * Math.PI * tierCounts[tier.name]) / totalUsers;
                const slice = {
                    tier: tier,
                    startAngle: startAngle,
                    endAngle: startAngle + sliceAngle,
                    color: tier.color
                };
                startAngle += sliceAngle;
                return slice;
            });
            
            // 动画参数
            const duration = 1500; // 动画持续1500毫秒
            let startTime = null;
            
            // 动画函数
            function animate(currentTime) {
                if (!startTime) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1); // 0到1
                
                // 当前角度从0到2PI
                const currentAngle = progress * 2 * Math.PI;
                
                // 清除画布
                ctx.clearRect(0, 0, width, height);
                
                // 绘制每个扇形
                slices.forEach(slice => {
                    // 如果当前角度大于这个扇形的起始角度，则绘制
                    if (currentAngle > slice.startAngle + Math.PI / 2) {
                        const start = slice.startAngle;
                        const end = Math.min(currentAngle - Math.PI / 2, slice.endAngle);
                        
                        if (end > start) {
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            ctx.arc(centerX, centerY, radius, start, end);
                            ctx.closePath();
                            ctx.fillStyle = slice.color;
                            ctx.fill();
                            
                            // 绘制分隔线
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                });
                
                // 如果动画未完成，继续
                if (progress < 1) {
                    pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
                } else {
                    // 动画完成，绘制中心圆和文字
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('段位分布', centerX, centerY - 8);
                    ctx.font = '14px Arial';
                    ctx.fillText(`${totalUsers}人`, centerX, centerY + 10);
                    
                    // 动画完成，清除动画ID
                    delete pieChartAnimations[canvasElement.id];
                }
            }
            
            // 启动动画
            pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
        }
        
        // 选择用户
        function selectUser(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('searchUser').value = user.id;
        }
        
        // 升级用户为管理员
        function promoteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.isAdmin = true;
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification(`已将 ${user.name} 升級為管理員`, 'success');
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？此操作不可撤銷。')) {
                users = users.filter(u => u.id !== userId);
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification('用户已删除', 'success');
            }
        }
        
        // 编辑奖品
        function editPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            if (prize) {
                document.getElementById('editPrizeId').value = prize.id;
                document.getElementById('editPrizeName').value = prize.name;
                document.getElementById('editPrizePoints').value = prize.points;
                document.getElementById('editPrizeIcon').value = prize.icon;
                
                editPrizeModal.style.display = 'flex';
            }
        }
        
        // 删除奖品
        function deletePrize(prizeId) {
            if (confirm('确定要删除这个獎品吗？此操作不可撤銷。')) {
                prizes = prizes.filter(p => p.id !== prizeId);
                
                // 保存数据
                saveDataToStorage();
                
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                showNotification('獎品已删除', 'success');
            }
        }
        
        // 更新用户统计信息 - 使用累积积分
        function updateUserStats() {
            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalPoints = users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0);
            
            // 使用累积积分统计各段位用户数量
            const activeUsers = users.filter(u => !u.isAdmin && u.totalPoints >= 1500).length;
            const activeUser4 = users.filter(u => !u.isAdmin && u.totalPoints >= 1200 && u.totalPoints < 1500).length;
            const activeUser3 = users.filter(u => !u.isAdmin && u.totalPoints >= 900 && u.totalPoints < 1200).length;
            const activeUser2 = users.filter(u => !u.isAdmin && u.totalPoints >= 600 && u.totalPoints < 900).length;
            const activeUser1 = users.filter(u => !u.isAdmin && u.totalPoints >= 300 && u.totalPoints < 600).length;
            const activeUser0 = users.filter(u => !u.isAdmin && u.totalPoints < 300).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('activeUser4').textContent = activeUser4;
            document.getElementById('activeUser3').textContent = activeUser3;
            document.getElementById('activeUser2').textContent = activeUser2;
            document.getElementById('activeUser1').textContent = activeUser1;
            document.getElementById('activeUser0').textContent = activeUser0;
        }
        
        // 更新系统统计信息
        function updateSystemStats() {
            document.getElementById('systemUsers').textContent = users.filter(u => !u.isAdmin).length;
            document.getElementById('systemPrizes').textContent = prizes.length;
            document.getElementById('systemHistory').textContent = pointsHistory.length;
            document.getElementById('systemAdmins').textContent = users.filter(u => u.isAdmin).length;
            
            updateUserStats();
        }
        
        // 导出用户数据
        function exportUsersData() {
            const dataStr = JSON.stringify(users.filter(u => !u.isAdmin), null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('用户數據導出成功', 'success');
        }
        
        // 导出奖品数据
        function exportPrizesData() {
            const dataStr = JSON.stringify(prizes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'prizes_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('獎品數據導出成功', 'success');
        }
        
        // 导出历史数据
        function exportHistoryData() {
            const dataStr = JSON.stringify(pointsHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'history_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('歷史數據導出成功', 'success');
        }
        
        // 导出所有数据
        function exportAllData() {
            const allData = {
                users: users,
                prizes: prizes,
                history: pointsHistory,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'barcode_system_backup.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('系統數據備份成功', 'success');
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.users && Array.isArray(importedData.users)) {
                        users = importedData.users;
                        
                        // 确保导入的用户数据有累积积分和段位字段
                        users.forEach(user => {
                            if (user.totalPoints === undefined) {
                                user.totalPoints = user.points || 0;
                            }
                            if (user.tier === undefined) {
                                user.tier = calculateUserTier(user.totalPoints);
                            }
                            if (user.achievements === undefined) {
                                user.achievements = [];
                            }
                            if (user.achievementData === undefined) {
                                user.achievementData = {};
                            }
                            
                            // 检查成就
                            checkAchievements(user);
                        });
                    }
                    
                    if (importedData.prizes && Array.isArray(importedData.prizes)) {
                        prizes = importedData.prizes;
                    }
                    
                    if (importedData.history && Array.isArray(importedData.history)) {
                        pointsHistory = importedData.history;
                    }
                    
                    saveDataToStorage();
                    renderUsersTable();
                    renderPrizesTable();
                    renderPrizes();
                    updateSystemStats();
                    
                    showNotification('數據導入成功', 'success');
                } catch (error) {
                    showNotification('數據導入失败：文件格式錯誤', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入
            event.target.value = '';
        }
        
        // 修改管理员密码
        function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('請填寫所有密碼字段', 'error');
                return;
            }
            
            if (currentPassword !== adminPassword) {
                showNotification('當前密碼錯誤', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('新密碼和确认密碼不匹配', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('新密码长度至少6位', 'error');
                return;
            }
            
            // 在实际应用中，这里应该将新密码保存到安全的地方
            // 由于这是前端演示，我们无法真正修改硬编码的密码
            // 但可以保存到localStorage作为演示
            localStorage.setItem('adminNewPassword', newPassword);
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('密码修改需到代碼層尋找*****', 'success');
        }
        
        // 重置系统数据
        function resetSystemData() {
            if (confirm('确定要重置所有系統數據吗？此操作将删除所有用户、獎品和歷史紀錄，且不可恢复！')) {
                users = [
                    { 
                        id: 'wwlwcf002', 
                        name: '管理员', 
                        barcodeCode: 'wwlwcf002', 
                        points: 0, 
                        totalPoints: 0,
                        tier: '',
                        isAdmin: true,
                        achievements: [],
                        achievementData: {}
                    }
                ];
                prizes = [];
                pointsHistory = [];
                
                saveDataToStorage();
                renderUsersTable();
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                showNotification('系統數據已重置', 'success');
            }
        }
        
        // 生成随机用户ID
        function generateUserId() {
            const prefix = 'U';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机条形码编码
        function generateBarcodeCode() {
            const prefix = 'USER';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机奖品ID
        function generatePrizeId() {
            const prefix = 'P';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 保存数据到本地存储
        function saveDataToStorage() {
            localStorage.setItem('barcodePointsUsers', JSON.stringify(users));
            localStorage.setItem('barcodePointsPrizes', JSON.stringify(prizes));
            localStorage.setItem('barcodePointsHistory', JSON.stringify(pointsHistory));
        }
        
        // 显示通知
        function showNotification(message, type) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = '#2ecc71';
            } else if (type === 'error') {
                notification.style.background = '#e74c3c';
            } else {
                notification.style.background = '#3498db';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 确保JsBarcode库已加载
        function checkBarcodeLibrary() {
            if (typeof JsBarcode === 'undefined') {
                console.error('JsBarcode库未正确加载');
                // 尝试重新加载
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js';
                script.onload = function() {
                    console.log('JsBarcode库重新加载成功');
                    initPage();
                };
                document.head.appendChild(script);
            } else {
                console.log('JsBarcode库已加载');
                initPage();
            }
        }

        // 在页面加载时检查
        window.addEventListener('load', function() {
            checkBarcodeLibrary();
        });
    </script>
</body>
</html>            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background: linear-gradient(135deg, #a6d1ff 0%, #c2e9fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: #333;
        }
        
        body.theme-dark {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-color);
        }
        
        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .loader-content {
            text-align: center;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(37, 117, 252, 0.3);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 落叶动画效果 */
        .leaf {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ffd700;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            opacity: 0.7;
            animation: falling linear infinite;
            z-index: 0;
        }
        
        @keyframes falling {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* 玻璃水滴型卡片设计 */
        .card {
            background: var(--glass-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .card {
            background: var(--card-bg);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.5) 0%, rgba(106, 17, 203, 0.5) 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .card-header i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .card:hover .card-header i {
            transform: scale(1.1);
        }
        
        .card-header h2 {
            color: var(--dark);
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .theme-dark .card-header h2 {
            color: var(--text-color);
        }
        
        .login-section {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .login-card {
            flex: 1;
            min-width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .form-group label {
            color: #ccc;
        }
        
        /* 玻璃水滴型输入框 */
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
        }
        
        .theme-dark .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }
        
        .form-control:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .form-control:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 层次感按钮设计 */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:hover::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #1a68e8 0%, #5a0fb5 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 117, 252, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(37, 117, 252, 0.4);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, #219955 100%);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d35400 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400 0%, #ba4a00 100%);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7a7d 100%);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }
        
        .barcode-scan {
            text-align: center;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .barcode-scan:hover {
            border-color: rgba(37, 117, 252, 0.7);
            background: rgba(37, 117, 252, 0.1);
        }
        
        .barcode-scan i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        
        .barcode-scan:hover i {
            transform: scale(1.1);
        }
        
        .barcode-scan p {
            color: #666;
            font-size: 16px;
        }
        
        .theme-dark .barcode-scan p {
            color: #ccc;
        }
        
        .dashboard {
            display: none;
        }
        
        .user-info {
            background: linear-gradient(135deg, rgba(37, 117, 252, 0.7) 0%, rgba(106, 17, 203, 0.7) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .user-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .points {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: var(--dark);
        }
        
        .theme-dark .tab {
            color: var(--text-color);
        }
        
        .tab.active {
            border-bottom: 3px solid rgba(37, 117, 252, 0.7);
            color: var(--primary);
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-card {
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .prize-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .prize-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .prize-image {
            width: 100%;
            height: 150px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .theme-dark .prize-image {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .prize-card:hover .prize-image {
            transform: scale(1.05);
        }
        
        .prize-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .prize-points {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .admin-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .users-table, .history-table, .prizes-table, .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table th, .users-table td,
        .history-table th, .history-table td,
        .prizes-table th, .prizes-table td,
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        
        .users-table th, .history-table th, .prizes-table th, .leaderboard-table th {
            background: rgba(248, 249, 250, 0.5);
            font-weight: 600;
            color: #555;
        }
        
        .theme-dark .users-table th, 
        .theme-dark .history-table th, 
        .theme-dark .prizes-table th, 
        .theme-dark .leaderboard-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }
        
        .users-table tr:hover, .history-table tr:hover, .prizes-table tr:hover, .leaderboard-table tr:hover {
            background: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .users-table tr:hover, 
        .theme-dark .history-table tr:hover, 
        .theme-dark .prizes-table tr:hover, 
        .theme-dark .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .action-btn {
            padding: 6px 12px;
            margin-right: 5px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .modal-content {
            background: var(--card-bg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .modal-header h3 {
            color: var(--dark);
            font-size: 1.5rem;
        }
        
        .theme-dark .modal-header h3 {
            color: var(--text-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--dark);
        }
        
        .theme-dark .close-btn:hover {
            color: var(--text-color);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            transition: background-color 0.2s;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .history-item:hover {
            background-color: rgba(248, 249, 250, 0.3);
        }
        
        .theme-dark .history-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-points {
            font-weight: bold;
        }
        
        .points-positive {
            color: var(--success);
        }
        
        .points-negative {
            color: var(--danger);
        }
        
        .barcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
        }
        
        .theme-dark .barcode-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .barcode-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: white;
        }
        
        .barcode-placeholder {
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .theme-dark .barcode-placeholder {
            color: #ccc;
        }
        
        .scan-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #scanner-container {
            width: 100%;
            height: 300px;
            background: rgba(245, 245, 245, 0.5);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .theme-dark #scanner-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .scan-line {
            width: 80%;
            height: 2px;
            background: var(--primary);
            position: relative;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: -50%; }
            100% { top: 150%; }
        }
        
        .scan-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .user-barcode {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }
        
        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        /* 玻璃水滴型登录选项按钮 */
        .login-option-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .login-option-btn {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .login-option-btn.active {
            background: rgba(37, 117, 252, 0.3);
            color: white;
            border-color: rgba(37, 117, 252, 0.5);
        }
        
        .login-option-btn:hover {
            background: rgba(37, 117, 252, 0.2);
            transform: translateY(-2px);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .data-management {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .data-management .btn {
            flex: 1;
            min-width: 150px;
        }
        
        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        
        .theme-dark .stat-card {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .theme-dark .stat-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .theme-dark .stat-label {
            color: #ccc;
        }
        
        /* 优化选项框样式 - 更圆滑、半透明 */
        .reason-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            color: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }
        
        .theme-dark .reason-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .reason-select:focus {
            border-color: rgba(37, 117, 252, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2), inset 0 2px 5px rgba(0, 0, 0, 0.05);
            outline: none;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .theme-dark .reason-select:focus {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .reason-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: inherit;
        }
        
        .theme-dark .reason-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-tier {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .tier-king {
            background-color: #ffd900;
            color: #000;
        }
        
        .tier-diamond {
            background-color: #9035F8;
            color: white;
        }
        
        .tier-platinum {
            background-color: #75c8ff;
            color: #000;
        }
        
        .tier-gold {
            background-color: #ff8904;
            color: white;
        }
        
        .tier-silver {
            background-color: #5fecfc;
            color: #000;
        }
        
        .tier-bronze {
            background-color: brown;
            color: white;
        }
        
        /* 排行榜样式 - 前三名更醒目 */
        .leaderboard-container {
            display: flex;
            gap: 25px;
            margin-top: 20px;
        }
        
        .leaderboard-table-container {
            flex: 2;
        }
        
        .leaderboard-table tr.top-three {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-left: 4px solid #ffd700;
        }
        
        .leaderboard-table tr:nth-child(1) {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.15) 100%);
            border-left: 4px solid #ffd700;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(2) {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(192, 192, 192, 0.15) 100%);
            border-left: 4px solid #c0c0c0;
            font-weight: bold;
        }
        
        .leaderboard-table tr:nth-child(3) {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(205, 127, 50, 0.15) 100%);
            border-left: 4px solid #cd7f32;
            font-weight: bold;
        }
        
        .theme-dark .leaderboard-table tr:nth-child(1),
        .theme-dark .leaderboard-table tr:nth-child(2),
        .theme-dark .leaderboard-table tr:nth-child(3) {
            color: white;
        }
        
        .pie-chart-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .theme-dark .pie-chart-container {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .pie-chart {
            width: 250px;
            height: 250px;
            position: relative;
        }
        
        .pie-chart canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* 动画定义 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* 新增的颜色设定 */
        #activeUsers,
        #activeUsers + .stat-label {
            color: #ffd900; /* 王者用户 */
        }

        #activeUser4,
        #activeUser4 + .stat-label {
            color: #9035F8; /* 钻石用户 */
        }

        #activeUser3,
        #activeUser3 + .stat-label {
            color: #75c8ff; /* 铂金用户 */
        }

        #activeUser2,
        #activeUser2 + .stat-label {
            color: #ff8904; /* 黄金用户 */
        }

        #activeUser1,
        #activeUser1 + .stat-label {
            color: #5fecfc; /* 白银用户 */
        }

        #activeUser0,
        #activeUser0 + .stat-label {
            color: brown; /* 青铜用户 */
        }
        
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* 徽章样式 */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .login-section {
                flex-direction: column;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .prizes-grid {
                grid-template-columns: 1fr;
            }
            
            .users-table, .history-table, .prizes-table, .leaderboard-table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .login-options {
                flex-direction: column;
            }
            
            .data-management {
                flex-direction: column;
            }
            
            .user-stats {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-container {
                flex-direction: column;
            }
            
            .pie-chart {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h3>加載中...</h3>
            <p>正在初始化系統</p>
        </div>
    </div>
    
    <!-- 落叶动画元素 -->
    <div id="leaves-container"></div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <h1>明馬二樓宿舍積分兌換系統</h1>
            <p>明愛馬鞍山中學二樓宿舍專用</p>
        </div>
        
        <!-- 登陸區域 -->
        <div class="login-section" id="loginSection">
            <!-- 用戶登錄 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user"></i>
                    <h2>用戶登錄</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="userCodeLoginBtn">用戶編號登陸</div>
                    <div class="login-option-btn" id="userBarcodeLoginBtn">QRcode登陸</div>
                </div>
                
                <div id="userCodeLoginForm">
                    <div class="form-group">
                        <label for="userIdInput">用戶編號</label>
                        <input type="text" id="userIdInput" class="form-control" placeholder="輸入用戶編號">
                    </div>
                    <button class="btn btn-block" id="userLoginBtn">用戶登錄</button>
                </div>
                
                <div id="userBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="userBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
                
                <div class="user-info" style="display: none;" id="userInfo">
                    <div>
                        <h3 id="userName">张三</h3>
                        <p>用户编号: <span id="userId">U1001</span></p>
                    </div>
                    <div class="points" id="userPoints">1500</div>
                </div>
            </div>
            
            <!-- 管理员登录 -->
            <div class="card login-card">
                <div class="card-header">
                    <i class="fas fa-user-shield"></i>
                    <h2>管理员登录</h2>
                </div>
                
                <div class="login-options">
                    <div class="login-option-btn active" id="adminCodeLoginBtn">管理員編號登陸</div>
                    <div class="login-option-btn" id="adminBarcodeLoginBtn">管理員QRcode登陸</div>
                </div>
                
                <div id="adminCodeLoginForm">
                    <div class="form-group">
                        <label for="adminId">管理員編號</label>
                        <input type="text" id="adminId" class="form-control" placeholder="輸入管理員編號">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">管理員密碼</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="請輸入管理員密碼">
                    </div>
                    
                    <button class="btn btn-block" id="adminLoginBtn">管理員登陸</button>
                </div>
                
                <div id="adminBarcodeLoginForm" style="display: none;">
                    <div class="barcode-scan" id="adminBarcodeScan">
                        <i class="fas fa-barcode"></i>
                        <p>點擊此處掃描QRcode</p>
                        <p class="small">並將QRcode對準攝像頭</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户仪表盘 -->
        <div class="dashboard card" id="userDashboard">
            <div class="card-header">
                <i class="fas fa-gift"></i>
                <h2>積分兌換中心</h2>
            </div>
            
            <div class="user-info">
                <div>
                    <h3 id="dashboardUserName">张三</h3>
                    <p>用戶編號: <span id="dashboardUserId">U1001</span></p>
                    <p>QRcode編碼: <span id="dashboardUserBarcode">BARCODE001</span></p>
                    <p>段位: <span id="dashboardUserTier">青銅</span></p>
                </div>
                <div>
                    <div class="points" id="dashboardUserPoints">1500</div>
                    <div style="text-align: right;">累積積分: <span id="dashboardUserTotalPoints">2500</span></div>
                </div>
            </div>
            
            <div class="user-barcode">
                <h4>我的QRcode</h4>
                <div id="userBarcodeDisplay"></div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="prizes">獎品兌換</div>
                <div class="tab" data-tab="history">積分歷史</div>
                <div class="tab" data-tab="leaderboard">排行榜</div>
                <div class="tab" data-tab="achievements">成就系統</div>
            </div>
            
            <div class="tab-content active" id="prizes-tab">
                <h3 style="margin-bottom: 15px;">可用獎品</h3>
                <div class="prizes-grid" id="prizesGrid">
                    <!-- 奖品将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <h3 style="margin-bottom: 15px;">積分歷史紀錄</h3>
                <div id="userHistoryContent">
                    <!-- 用户积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="userLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="tierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="pieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="achievements-tab">
                <h3 style="margin-bottom: 15px;">成就系統</h3>
                <div id="achievementsContent">
                    <!-- 成就系统内容将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="userLogoutBtn">退出登陸</button>
        </div>
        
        <!-- 管理员仪表盘 -->
        <div class="dashboard card" id="adminDashboard">
            <div class="card-header">
                <i class="fas fa-cogs"></i>
                <h2>積分管理系統</h2>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="users">用戶管理</div>
                <div class="tab" data-tab="prizes-admin">獎品管理</div>
                <div class="tab" data-tab="history-admin">積分歷史</div>
                <div class="tab" data-tab="leaderboard-admin">排行榜</div>
                <div class="tab" data-tab="system-admin">系統管理</div>
            </div>
            
            <div class="tab-content active" id="users-tab">
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">總積分</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">👑👑👑王者用戶🏅️🏅️🏅️</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser4">0</div>
                        <div class="stat-label">💎鑽石用戶💎</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser3">0</div>
                        <div class="stat-label">💍鉑金用戶💍</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser2">0</div>
                        <div class="stat-label">✨黃金用戶✨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser1">0</div>
                        <div class="stat-label">🥈白銀用戶🥈</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUser0">0</div>
                        <div class="stat-label">.🔥青銅用戶🔥.</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchUser" class="form-control" placeholder="輸入用戶編號·姓名或QRcode編碼">
                    <button class="btn" id="searchUserBtn">搜索</button>
                    <button class="btn btn-secondary" id="clearSearchBtn">清除</button>
                </div>
                
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="pointsChange">積分變更</label>
                        <input type="number" id="pointsChange" class="form-control" placeholder="輸入積分變更值">
                    </div>
                    <div class="form-group">
                        <label for="pointsReason">變更原因</label>
                        <select id="pointsReason" class="reason-select">
                            <option value="">-- 選擇原因 --</option>
                            <option value="任務獎勵">任務獎勵</option>
                            <option value="活動獎勵">活動獎勵</option>
                            <option value="挑戰獎勵">挑戰獎勵</option>
                            <option value="閱讀獎勵">閱讀獎勵</option>
                            <option value="管理員調整">管理員調整</option>
                            <option value="其他">其他</option>
                        </select>
                        <input type="text" id="customReason" class="reason-input" placeholder="輸入其他原因" style="display: none;">
                    </div>
                    <button class="btn" id="updatePointsBtn" style="align-self: flex-end;">更新積分</button>
                    <button class="btn btn-success" id="addUserBtn" style="align-self: flex-end;">添加用戶</button>
                    <button class="btn btn-info" id="exportUsersBtn" style="align-self: flex-end;">導出用戶</button>
                </div>
                
                <h3>用戶列表</h3>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>用戶編號</th>
                            <th>姓名</th>
                            <th>QRcode編碼</th>
                            <th>當前積分</th>
                            <th>累積積分</th>
                            <th>段位</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- 用户数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="prizes-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="prizeName">獎品名稱</label>
                        <input type="text" id="prizeName" class="form-control" placeholder="輸入獎品名稱">
                    </div>
                    <div class="form-group">
                        <label for="prizePoints">所需積分</label>
                        <input type="number" id="prizePoints" class="form-control" placeholder="輸入所需積分" min="1">
                    </div>
                    <div class="form-group">
                        <label for="prizeIcon">圖標</label>
                        <input type="text" id="prizeIcon" class="form-control" placeholder="輸入FontAwesome圖標名稱" value="fa-gift">
                    </div>
                    <button class="btn btn-success" id="addPrizeBtn" style="align-self: flex-end;">添加獎品</button>
                    <button class="btn btn-info" id="exportPrizesBtn" style="align-self: flex-end;">導出獎品</button>
                </div>
                
                <h3>獎品列表</h3>
                <table class="prizes-table">
                    <thead>
                        <tr>
                            <th>獎品ID</th>
                            <th>獎品名稱</th>
                            <th>所需積分</th>
                            <th>圖標</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="prizesTableBody">
                        <!-- 奖品数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="history-admin-tab">
                <div class="search-box">
                    <input type="text" id="searchHistoryUser" class="form-control" placeholder="輸入用戶編號、姓名或QRcode編碼">
                    <button class="btn" id="searchHistoryBtn">搜索歷史紀錄</button>
                    <button class="btn btn-secondary" id="clearHistorySearchBtn">清除</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="exportHistoryBtn">導出歷史紀錄</button>
                    <button class="btn btn-warning" id="clearHistoryBtn">清空歷史紀錄</button>
                </div>
                
                <h3>積分歷史紀錄</h3>
                <div id="adminHistoryContent">
                    <!-- 管理员查看的积分历史将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="tab-content" id="leaderboard-admin-tab">
                <h3 style="margin-bottom: 15px;">歷史積分排行榜</h3>
                <div class="leaderboard-container">
                    <div class="leaderboard-table-container">
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>用戶姓名</th>
                                    <th>用戶編號</th>
                                    <th>累積積分</th>
                                    <th>段位</th>
                                </tr>
                            </thead>
                            <tbody id="adminLeaderboardBody">
                                <!-- 排行榜数据将通过JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pie-chart-container">
                        <h4>段位分布</h4>
                        <div class="pie-chart">
                            <canvas id="adminTierPieChart"></canvas>
                        </div>
                        <div class="pie-legend" id="adminPieLegend">
                            <!-- 图例将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="system-admin-tab">
                <div class="admin-controls">
                    <div class="form-group">
                        <label for="currentPassword">當前密碼</label>
                        <input type="password" id="currentPassword" class="form-control" placeholder="輸入當前密碼">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密碼</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="輸入新密碼">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">確認新密碼</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="再次輸入新密碼">
                    </div>
                    <button class="btn btn-warning" id="changePasswordBtn" style="align-self: flex-end;">修改密碼</button>
                </div>
                
                <div class="data-management">
                    <button class="btn btn-info" id="importDataBtn">導入歷史數據</button>
                    <button class="btn btn-success" id="exportDataBtn">導出所有數據</button>
                    <button class="btn btn-danger" id="resetDataBtn">重置所有數據</button>
                </div>
                
                <div class="form-group">
                    <label for="dataFile">選擇數據文件 (JSON格式)</label>
                    <input type="file" id="dataFile" class="form-control" accept=".json">
                </div>
                
                <h3>系统信息</h3>
                <div class="user-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="systemUsers">0</div>
                        <div class="stat-label">用戶數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemPrizes">0</div>
                        <div class="stat-label">獎品數量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemHistory">0</div>
                        <div class="stat-label">歷史紀錄</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="systemAdmins">0</div>
                        <div class="stat-label">管理員數量</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-block logout-btn" id="adminLogoutBtn">退出登陸</button>
        </div>
    </div>
    
    <!-- 添加用户模态框 -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新用戶</h3>
                <button class="close-btn" id="closeAddUserModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newUserName">用户姓名</label>
                <input type="text" id="newUserName" class="form-control" placeholder="請輸入用户姓名">
            </div>
            <div class="form-group">
                <label for="newUserId">用户編號</label>
                <input type="text" id="newUserId" class="form-control" placeholder="請輸入用户編號">
            </div>
            <div class="form-group">
                <label for="newUserPoints">初始積分</label>
                <input type="number" id="newUserPoints" class="form-control" value="0" min="0">
            </div>
            <div class="form-group">
                <label>生成的QRcode編碼: <span id="generatedBarcodeCode">BARCODE001</span></label>
            </div>
            <div class="barcode-container" id="newUserBarcode"></div>
            <button class="btn btn-success btn-block" id="confirmAddUser">確認添加用户</button>
        </div>
    </div>
    
    <!-- 编辑奖品模态框 -->
    <div class="modal" id="editPrizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯獎品</h3>
                <button class="close-btn" id="closeEditPrizeModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editPrizeName">獎品名稱</label>
                <input type="text" id="editPrizeName" class="form-control" placeholder="請輸入獎品名稱">
            </div>
            <div class="form-group">
                <label for="editPrizePoints">所需積分</label>
                <input type="number" id="editPrizePoints" class="form-control" placeholder="請輸入所需積分" min="1">
            </div>
            <div class="form-group">
                <label for="editPrizeIcon">圖標類名</label>
                <input type="text" id="editPrizeIcon" class="form-control" placeholder="輸入FontAwesome圖標類名">
            </div>
            <input type="hidden" id="editPrizeId">
            <button class="btn btn-success btn-block" id="confirmEditPrize">确认修改</button>
        </div>
    </div>
    
    <!-- 条形码扫描模态框 -->
    <div class="modal" id="barcodeScannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>掃描QRcode</h3>
                <button class="close-btn" id="closeScannerModal">&times;</button>
            </div>
            <div class="scan-area">
                <div id="scanner-container">
                    <!-- 摄像头预览将在这里显示 -->
                </div>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
            </div>
            <div class="scan-controls">
                <button class="btn" id="startScannerBtn">開始掃描</button>
                <button class="btn btn-danger" id="stopScannerBtn" style="display: none;">停止掃描</button>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>掃描結果: <span id="scanResult">等待掃描...</span></label>
            </div>
            <button class="btn btn-success btn-block" id="confirmScanBtn" style="display: none;">確認此QRcode編碼正確？</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // 创建落叶效果
        function createLeaves() {
            const leavesContainer = document.getElementById('leaves-container');
            const leafCount = 15; // 落叶数量
            
            for (let i = 0; i < leafCount; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                
                // 随机位置
                const left = Math.random() * 100;
                leaf.style.left = left + 'vw';
                
                // 随机大小
                const size = 15 + Math.random() * 20;
                leaf.style.width = size + 'px';
                leaf.style.height = size + 'px';
                
                // 随机动画延迟和持续时间
                const delay = Math.random() * 10;
                const duration = 5 + Math.random() * 10;
                leaf.style.animationDelay = delay + 's';
                leaf.style.animationDuration = duration + 's';
                
                leavesContainer.appendChild(leaf);
            }
        }
        
        // 用户数据存储
        let users = JSON.parse(localStorage.getItem('barcodePointsUsers')) || [
            { 
                id: 'U1001', 
                name: '张三', 
                barcodeCode: 'USER001', 
                points: 1500, 
                totalPoints: 2500,
                tier: '鉑金',
                isAdmin: false,
                achievements: ['初來乍到', '積分達人']
            },
            { 
                id: 'U1002', 
                name: '李四', 
                barcodeCode: 'USER002', 
                points: 800, 
                totalPoints: 1200,
                tier: '黃金',
                isAdmin: false,
                achievements: ['初來乍到']
            },
            { 
                id: 'U1003', 
                name: '王五', 
                barcodeCode: 'USER003', 
                points: 2200, 
                totalPoints: 3200,
                tier: '鑽石',
                isAdmin: false,
                achievements: ['初來乍到', '積分達人', '段位高手']
            },
            { 
                id: 'wwlwcf002', 
                name: '管理员', 
                barcodeCode: 'wwlwcf002', 
                points: 0, 
                totalPoints: 0,
                tier: '',
                isAdmin: true,
                achievements: []
            }
        ];
        
        // 奖品数据存储
        let prizes = JSON.parse(localStorage.getItem('barcodePointsPrizes')) || [
            { id: 'P001', name: '咖啡券', points: 200, icon: 'fa-mug-hot' },
            { id: 'P002', name: '电影票', points: 500, icon: 'fa-film' },
            { id: 'P003', name: '蓝牙耳机', points: 1500, icon: 'fa-headphones' },
            { id: 'P004', name: '智能手表', points: 3000, icon: 'fa-clock' },
            { id: 'P005', name: '平板电脑', points: 5000, icon: 'fa-tablet-alt' },
            { id: 'P006', name: '购物卡', points: 1000, icon: 'fa-shopping-bag' }
        ];
        
        // 积分历史记录存储
        let pointsHistory = JSON.parse(localStorage.getItem('barcodePointsHistory')) || [
            { userId: 'U1001', timestamp: new Date('2023-10-01 09:30:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-05 14:20:00').getTime(), pointsChange: -200, reason: '兑换咖啡券' },
            { userId: 'U1001', timestamp: new Date('2023-10-10 11:15:00').getTime(), pointsChange: 500, reason: '活动奖励' },
            { userId: 'U1001', timestamp: new Date('2023-10-15 15:40:00').getTime(), pointsChange: 800, reason: '管理员调整' },
            { userId: 'U1002', timestamp: new Date('2023-10-02 10:45:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1002', timestamp: new Date('2023-10-07 16:30:00').getTime(), pointsChange: 300, reason: '完成任务' },
            { userId: 'U1003', timestamp: new Date('2023-10-03 08:20:00').getTime(), pointsChange: 100, reason: '签到奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-08 13:10:00').getTime(), pointsChange: 1000, reason: '推荐用户奖励' },
            { userId: 'U1003', timestamp: new Date('2023-10-12 17:25:00').getTime(), pointsChange: 400, reason: '活动奖励' }
        ];
        
        // 成就系统
        const achievements = [
            { id: 'new_user', name: '新手求帶！😭', description: '積分達到100分', icon: 'fa-star', condition: (user) => user.totalPoints >= 100 },
            { id: 'points_collector', name: '低等貴族🫅', description: '累積積分達到500點', icon: 'fa-star', condition: (user) => user.totalPoints >= 500 },
            { id: 'tier_master', name: '大佬帶帶我', description: '達到鉑金段位', icon: 'fa-trophy', condition: (user) => user.tier === '鉑金' || user.tier === '鑽石' || user.tier === '王者' },
            { id: 'exchange_expert', name: '兄弟手頭有點緊啊～', description: '成功兌換5次獎品', icon: 'fa-gift', condition: (user) => pointsHistory.filter(h => h.userId === user.id && h.pointsChange < 0).length >= 5 },
            { id: 'points_collector', name: '中等貴族✨', description: '累積積分達1200點', icon: 'fa-star', condition: (user) => user.totalPoints >= 1200 },
            { id: 'points_collector', name: '💎高等貴族💎', description: '累積積分達到2000點', icon: 'fa-star', condition: (user) => user.totalPoints >= 2000 },
            { id: 'points_collector', name: '👑全服之王👑', description: '累積積分達到500點', icon: 'fa-star', condition: (user) => user.totalPoints >= 500 },
            { id: 'activity_king', name: '活躍之王🤭', description: '連續7天獲得積分', icon: 'fa-fire', condition: (user) => {
                // 簡化版：檢查用戶是否有7條不同日期的積分記錄
                const userHistory = pointsHistory.filter(h => h.userId === user.id && h.pointsChange > 0);
                const dates = [...new Set(userHistory.map(h => new Date(h.timestamp).toDateString()))];
                return dates.length >= 7;
            }}
        ];
        
        // 段位划分标准（基于累积积分）
        const tierThresholds = [
            { name: '青銅', min: 0, max: 299, color: 'brown' },
            { name: '白銀', min: 300, max: 599, color: '#5fecfc' },
            { name: '黃金', min: 600, max: 899, color: '#ff8904' },
            { name: '鉑金', min: 900, max: 1199, color: '#75c8ff' },
            { name: '鑽石', min: 1200, max: 1499, color: '#9035F8' },
            { name: '王者', min: 1500, max: Infinity, color: '#ffd900' }
        ];
        
        // 计算用户段位
        function calculateUserTier(totalPoints) {
            for (const tier of tierThresholds) {
                if (totalPoints >= tier.min && totalPoints <= tier.max) {
                    return tier.name;
                }
            }
            return '青銅';
        }
        
        // 获取段位对应的CSS类名
        function getTierClass(tierName) {
            switch(tierName) {
                case '王者': return 'tier-king';
                case '鑽石': return 'tier-diamond';
                case '鉑金': return 'tier-platinum';
                case '黃金': return 'tier-gold';
                case '白銀': return 'tier-silver';
                case '青銅': return 'tier-bronze';
                default: return 'tier-bronze';
            }
        }
        
        // 获取段位对应的颜色
        function getTierColor(tierName) {
            for (const tier of tierThresholds) {
                if (tier.name === tierName) {
                    return tier.color;
                }
            }
            return 'brown';
        }
        
        // 管理员密码
        const adminPassword = 'admin123';
        
        // DOM元素
        const pageLoader = document.getElementById('pageLoader');
        const loginSection = document.getElementById('loginSection');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const userBarcodeScan = document.getElementById('userBarcodeScan');
        const adminBarcodeScan = document.getElementById('adminBarcodeScan');
        const userLoginBtn = document.getElementById('userLoginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const userLogoutBtn = document.getElementById('userLogoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const prizesGrid = document.getElementById('prizesGrid');
        const usersTableBody = document.getElementById('usersTableBody');
        const prizesTableBody = document.getElementById('prizesTableBody');
        const updatePointsBtn = document.getElementById('updatePointsBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const closeAddUserModal = document.getElementById('closeAddUserModal');
        const confirmAddUser = document.getElementById('confirmAddUser');
        const generatedBarcodeCode = document.getElementById('generatedBarcodeCode');
        const newUserBarcode = document.getElementById('newUserBarcode');
        const addPrizeBtn = document.getElementById('addPrizeBtn');
        const editPrizeModal = document.getElementById('editPrizeModal');
        const closeEditPrizeModal = document.getElementById('closeEditPrizeModal');
        const confirmEditPrize = document.getElementById('confirmEditPrize');
        const searchHistoryBtn = document.getElementById('searchHistoryBtn');
        const barcodeScannerModal = document.getElementById('barcodeScannerModal');
        const closeScannerModal = document.getElementById('closeScannerModal');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scanResult = document.getElementById('scanResult');
        const confirmScanBtn = document.getElementById('confirmScanBtn');
        const userIdInput = document.getElementById('userIdInput');
        const userBarcodeDisplay = document.getElementById('userBarcodeDisplay');
        const notification = document.getElementById('notification');
        const userLeaderboardBody = document.getElementById('userLeaderboardBody');
        const adminLeaderboardBody = document.getElementById('adminLeaderboardBody');
        const tierPieChart = document.getElementById('tierPieChart');
        const adminTierPieChart = document.getElementById('adminTierPieChart');
        const pieLegend = document.getElementById('pieLegend');
        const adminPieLegend = document.getElementById('adminPieLegend');
        const themeToggle = document.getElementById('themeToggle');
        
        // 登录选项切换
        const userCodeLoginBtn = document.getElementById('userCodeLoginBtn');
        const userBarcodeLoginBtn = document.getElementById('userBarcodeLoginBtn');
        const userCodeLoginForm = document.getElementById('userCodeLoginForm');
        const userBarcodeLoginForm = document.getElementById('userBarcodeLoginForm');
        
        const adminCodeLoginBtn = document.getElementById('adminCodeLoginBtn');
        const adminBarcodeLoginBtn = document.getElementById('adminBarcodeLoginBtn');
        const adminCodeLoginForm = document.getElementById('adminCodeLoginForm');
        const adminBarcodeLoginForm = document.getElementById('adminBarcodeLoginForm');
        
        // 新增功能元素
        const searchUserBtn = document.getElementById('searchUserBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const exportUsersBtn = document.getElementById('exportUsersBtn');
        const exportPrizesBtn = document.getElementById('exportPrizesBtn');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const clearHistorySearchBtn = document.getElementById('clearHistorySearchBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const dataFile = document.getElementById('dataFile');
        const pointsReason = document.getElementById('pointsReason');
        const customReason = document.getElementById('customReason');
        
        // 当前登录的用户和管理员
        let currentUser = null;
        let currentAdmin = false;
        let scannerActive = false;
        let scannedBarcode = '';
        let scannerType = '';
        let pieChartAnimations = {};
        
        // 修复条形码生成函数
        function generateBarcode(code, container) {
            container.innerHTML = '';
            
            if (!code || code.trim() === '') {
                container.innerHTML = '<div class="barcode-placeholder">条形码编码为空</div>';
                return;
            }
            
            try {
                // 创建canvas元素
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                
                // 使用JsBarcode生成条形码
                JsBarcode(canvas, code, {
                    format: "CODE128",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontOptions: "bold",
                    fontSize: 16,
                    textMargin: 10,
                    margin: 10,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
                
                console.log('QRcode生成成功:', code);
            } catch (error) {
                console.error('QRcode生成失敗:', error);
                container.innerHTML = '<div class="barcode-placeholder">QRcode生成失敗: ' + error.message + '</div>';
            }
        }

        // 初始化页面
        function initPage() {
            // 隐藏加载动画
            setTimeout(() => {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 500);
            }, 1500); // 保持初始化时间
            
            // 创建落叶效果
            createLeaves();
            
            // 保存初始数据到localStorage
            saveDataToStorage();
            
            // 只渲染必要的组件，延迟渲染其他组件
            renderPrizes();
            renderUsersTable();
            renderPrizesTable();
            setupTabs();
            setupLoginOptions();
            updateSystemStats();
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 检查是否已保存主题偏好
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('theme-dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // 积分变更原因选择事件
            pointsReason.addEventListener('change', function() {
                if (this.value === '其他') {
                    customReason.style.display = 'block';
                } else {
                    customReason.style.display = 'none';
                    customReason.value = '';
                }
            });
            
            // 用户登录按钮事件
            userLoginBtn.addEventListener('click', function() {
                const userId = userIdInput.value;
                if (userId) {
                    loginWithUserId(userId);
                } else {
                    showNotification('請輸入用戶編號', 'error');
                }
            });
            
            // 用户条形码扫描事件
            userBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('user');
            });
            
            // 管理员条形码扫描事件
            adminBarcodeScan.addEventListener('click', function() {
                openBarcodeScanner('admin');
            });
            
            // 管理员登录按钮事件
            adminLoginBtn.addEventListener('click', function() {
                const adminId = document.getElementById('adminId').value;
                const password = document.getElementById('adminPassword').value;
                
                if (adminId && password) {
                    loginAdminWithCredentials(adminId, password);
                } else {
                    showNotification('請輸入管理員編號和密碼', 'error');
                }
            });
            
            // 用户退出登录
            userLogoutBtn.addEventListener('click', function() {
                currentUser = null;
                showLoginSection();
                showNotification('已登出用戶登錄', 'info');
            });
            
            // 管理员退出登录
            adminLogoutBtn.addEventListener('click', function() {
                // 询问是否要下载备份
                if (confirm('是否要下載最新的系統文件？')) {
                    exportAllData();
                }
                currentAdmin = false;
                document.getElementById('adminId').value = '';
                document.getElementById('adminPassword').value = '';
                showLoginSection();
                showNotification('已登出管理員登陸', 'info');
            });
            
            // 更新积分按钮事件 - 添加成功提示
            updatePointsBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                const pointsChange = parseInt(document.getElementById('pointsChange').value);
                let reason = pointsReason.value;
                
                if (reason === '其他') {
                    reason = customReason.value;
                }
                
                if (!searchTerm || isNaN(pointsChange)) {
                    showNotification('請輸入有效的變更值和用戶編號', 'error');
                    return;
                }
                
                if (!reason) {
                    showNotification('請選擇或輸入變更原因', 'error');
                    return;
                }
                
                const user = users.find(u => 
                    u.id === searchTerm || 
                    u.name === searchTerm || 
                    u.barcodeCode === searchTerm
                );
                
                if (user) {
                    user.points += pointsChange;
                    if (user.points < 0) user.points = 0;
                    
                    // 如果是增加积分，同时增加累积积分
                    if (pointsChange > 0) {
                        user.totalPoints += pointsChange;
                    }
                    
                    // 更新段位
                    user.tier = calculateUserTier(user.totalPoints);
                    
                    // 检查成就
                    checkAchievements(user);
                    
                    // 记录积分变更历史
                    pointsHistory.push({
                        userId: user.id,
                        timestamp: new Date().getTime(),
                        pointsChange: pointsChange,
                        reason: reason
                    });
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    renderUsersTable();
                    updateSystemStats();
                    document.getElementById('pointsChange').value = '';
                    pointsReason.value = '';
                    customReason.value = '';
                    customReason.style.display = 'none';
                    
                    // 添加成功提示
                    showNotification(`成功更新 ${user.name} 的積分！變更: ${pointsChange > 0 ? '+' : ''}${pointsChange}`, 'success');
                } else {
                    showNotification('未找到該用戶', 'error');
                }
            });
            
            // 添加用户按钮事件
            addUserBtn.addEventListener('click', function() {
                // 生成随机条形码编码
                const newBarcodeCode = generateBarcodeCode();
                generatedBarcodeCode.textContent = newBarcodeCode;
                
                // 生成条形码 - 添加延迟确保DOM更新
                setTimeout(() => {
                    generateBarcode(newBarcodeCode, newUserBarcode);
                }, 100);
                
                // 显示模态框
                addUserModal.style.display = 'flex';
            });
            
            // 关闭添加用户模态框
            closeAddUserModal.addEventListener('click', function() {
                addUserModal.style.display = 'none';
            });
            
            // 确认添加用户
            confirmAddUser.addEventListener('click', function() {
                const userName = document.getElementById('newUserName').value;
                const userId = document.getElementById('newUserId').value;
                const userPoints = parseInt(document.getElementById('newUserPoints').value) || 0;
                const barcodeCode = generatedBarcodeCode.textContent;
                
                if (!userName || !userId) {
                    showNotification('請輸入用戶姓名或編號', 'error');
                    return;
                }
                
                // 检查用户编号是否已存在
                if (users.find(u => u.id === userId)) {
                    showNotification('用戶編號已存在，請使用其他編號', 'error');
                    return;
                }
                
                // 计算段位
                const userTier = calculateUserTier(userPoints);
                
                // 添加新用户
                const newUser = {
                    id: userId,
                    name: userName,
                    barcodeCode: barcodeCode,
                    points: userPoints,
                    totalPoints: userPoints, // 初始累积积分等于当前积分
                    tier: userTier, // 初始段位
                    isAdmin: false,
                    achievements: [] // 初始成就
                };
                
                // 检查初始成就
                checkAchievements(newUser);
                
                users.push(newUser);
                
                // 记录初始积分历史
                if (userPoints > 0) {
                    pointsHistory.push({
                        userId: userId,
                        timestamp: new Date().getTime(),
                        pointsChange: userPoints,
                        reason: '初始積分'
                    });
                }
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderUsersTable();
                updateSystemStats();
                
                // 关闭模态框并重置表单
                addUserModal.style.display = 'none';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserId').value = '';
                document.getElementById('newUserPoints').value = '0';
                
                showNotification(`成功添加用户 ${userName}，条形码编码: ${barcodeCode}`, 'success');
            });
            
            // 添加奖品按钮事件
            addPrizeBtn.addEventListener('click', function() {
                const prizeName = document.getElementById('prizeName').value;
                const prizePoints = parseInt(document.getElementById('prizePoints').value);
                const prizeIcon = document.getElementById('prizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的獎品信息', 'error');
                    return;
                }
                
                // 生成奖品ID
                const prizeId = generatePrizeId();
                
                // 添加新奖品
                prizes.push({
                    id: prizeId,
                    name: prizeName,
                    points: prizePoints,
                    icon: prizeIcon
                });
                
                // 保存数据
                saveDataToStorage();
                
                // 更新界面
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                // 重置表单
                document.getElementById('prizeName').value = '';
                document.getElementById('prizePoints').value = '';
                document.getElementById('prizeIcon').value = 'fa-gift';
                
                showNotification(`成功添加獎品 ${prizeName}`, 'success');
            });
            
            // 关闭编辑奖品模态框
            closeEditPrizeModal.addEventListener('click', function() {
                editPrizeModal.style.display = 'none';
            });
            
            // 确认编辑奖品
            confirmEditPrize.addEventListener('click', function() {
                const prizeId = document.getElementById('editPrizeId').value;
                const prizeName = document.getElementById('editPrizeName').value;
                const prizePoints = parseInt(document.getElementById('editPrizePoints').value);
                const prizeIcon = document.getElementById('editPrizeIcon').value;
                
                if (!prizeName || isNaN(prizePoints) || prizePoints < 1) {
                    showNotification('請輸入有效的奖品信息', 'error');
                    return;
                }
                
                // 更新奖品信息
                const prize = prizes.find(p => p.id === prizeId);
                if (prize) {
                    prize.name = prizeName;
                    prize.points = prizePoints;
                    prize.icon = prizeIcon;
                    
                    // 保存数据
                    saveDataToStorage();
                    
                    // 更新界面
                    renderPrizesTable();
                    renderPrizes();
                    
                    // 关闭模态框
                    editPrizeModal.style.display = 'none';
                    
                    showNotification(`成功更新獎品 ${prizeName}`, 'success');
                }
            });
            
            // 搜索历史记录按钮事件
            searchHistoryBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchHistoryUser').value;
                renderAdminHistory(searchTerm);
            });
            
            // 条形码扫描模态框事件
            closeScannerModal.addEventListener('click', function() {
                closeBarcodeScanner();
            });
            
            startScannerBtn.addEventListener('click', function() {
                startBarcodeScanner();
            });
            
            stopScannerBtn.addEventListener('click', function() {
                stopBarcodeScanner();
            });
            
            confirmScanBtn.addEventListener('click', function() {
                if (scannedBarcode) {
                    if (scannerType === 'user') {
                        loginWithBarcode(scannedBarcode);
                    } else if (scannerType === 'admin') {
                        loginAdminWithBarcode(scannedBarcode);
                    }
                    closeBarcodeScanner();
                }
            });
            
            // 新增功能事件
            searchUserBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchUser').value;
                renderUsersTable(searchTerm);
            });
            
            clearSearchBtn.addEventListener('click', function() {
                document.getElementById('searchUser').value = '';
                renderUsersTable();
            });
            
            exportUsersBtn.addEventListener('click', function() {
                exportUsersData();
            });
            
            exportPrizesBtn.addEventListener('click', function() {
                exportPrizesData();
            });
            
            exportHistoryBtn.addEventListener('click', function() {
                exportHistoryData();
            });
            
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有積分歷史紀錄吗？此操作不可恢復！')) {
                    pointsHistory = [];
                    saveDataToStorage();
                    renderAdminHistory();
                    updateSystemStats();
                    showNotification('歷史紀錄已清空', 'success');
                }
            });
            
            clearHistorySearchBtn.addEventListener('click', function() {
                document.getElementById('searchHistoryUser').value = '';
                renderAdminHistory();
            });
            
            changePasswordBtn.addEventListener('click', function() {
                changeAdminPassword();
            });
            
            importDataBtn.addEventListener('click', function() {
                dataFile.click();
            });
            
            exportDataBtn.addEventListener('click', function() {
                exportAllData();
            });
            
            resetDataBtn.addEventListener('click', function() {
                resetSystemData();
            });
            
            dataFile.addEventListener('change', function(e) {
                importData(e);
            });
        }
        
        // 主题切换
        function toggleTheme() {
            document.body.classList.toggle('theme-dark');
            if (document.body.classList.contains('theme-dark')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // 设置登录选项切换
        function setupLoginOptions() {
            // 用户登录选项
            userCodeLoginBtn.addEventListener('click', function() {
                userCodeLoginBtn.classList.add('active');
                userBarcodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'block';
                userBarcodeLoginForm.style.display = 'none';
            });
            
            userBarcodeLoginBtn.addEventListener('click', function() {
                userBarcodeLoginBtn.classList.add('active');
                userCodeLoginBtn.classList.remove('active');
                userCodeLoginForm.style.display = 'none';
                userBarcodeLoginForm.style.display = 'block';
            });
            
            // 管理员登录选项
            adminCodeLoginBtn.addEventListener('click', function() {
                adminCodeLoginBtn.classList.add('active');
                adminBarcodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'block';
                adminBarcodeLoginForm.style.display = 'none';
            });
            
            adminBarcodeLoginBtn.addEventListener('click', function() {
                adminBarcodeLoginBtn.classList.add('active');
                adminCodeLoginBtn.classList.remove('active');
                adminCodeLoginForm.style.display = 'none';
                adminBarcodeLoginForm.style.display = 'block';
            });
        }
        
        // 设置选项卡切换
        function setupTabs() {
            // 用户界面选项卡
            const userTabs = document.querySelectorAll('#userDashboard .tab');
            userTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    userTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#userDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history') {
                        renderUserHistory();
                    } else if (tabId === 'leaderboard') {
                        renderUserLeaderboard();
                        renderTierPieChartWithAnimation(tierPieChart, pieLegend);
                    } else if (tabId === 'achievements') {
                        renderAchievements();
                    }
                });
            });
            
            // 管理员界面选项卡
            const adminTabs = document.querySelectorAll('#adminDashboard .tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    adminTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#adminDashboard .tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，渲染历史记录
                    if (tabId === 'history-admin') {
                        renderAdminHistory();
                    } else if (tabId === 'leaderboard-admin') {
                        renderAdminLeaderboard();
                        renderTierPieChartWithAnimation(adminTierPieChart, adminPieLegend);
                    } else if (tabId === 'system-admin') {
                        updateSystemStats();
                    }
                });
            });
        }
        
        // 使用用户编号登录
        function loginWithUserId(userId) {
            const user = users.find(u => u.id === userId && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('用户編號錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用条形码登录
        function loginWithBarcode(barcode) {
            const user = users.find(u => u.barcodeCode === barcode && !u.isAdmin);
            if (user) {
                currentUser = user;
                showUserDashboard();
                showNotification(`用户 ${user.name} 登錄成功！`, 'success');
            } else {
                showNotification('QRcode錯誤或不是普通用户', 'error');
            }
        }
        
        // 使用管理员凭据登录
        function loginAdminWithCredentials(adminId, password) {
            if (password === adminPassword) {
                const adminUser = users.find(u => u.id === adminId && u.isAdmin);
                if (adminUser) {
                    currentAdmin = true;
                    showAdminDashboard();
                    showNotification('管理員登陸成功！', 'success');
                } else {
                    showNotification('管理員編號錯誤！', 'error');
                }
            } else {
                showNotification('密碼錯誤，請重試！', 'error');
            }
        }
        
        // 使用管理员条形码登录
        function loginAdminWithBarcode(barcode) {
            const adminUser = users.find(u => u.barcodeCode === barcode && u.isAdmin);
            if (adminUser) {
                currentAdmin = true;
                showAdminDashboard();
                showNotification('管理員登錄成功！', 'success');
            } else {
                showNotification('管理員QRcode錯誤！', 'error');
            }
        }
        
        // 打开条形码扫描器
        function openBarcodeScanner(type) {
            scannerType = type;
            barcodeScannerModal.style.display = 'flex';
            scanResult.textContent = '等待掃描...';
            confirmScanBtn.style.display = 'none';
            scannedBarcode = '';
        }
        
        // 关闭条形码扫描器
        function closeBarcodeScanner() {
            barcodeScannerModal.style.display = 'none';
            stopBarcodeScanner();
        }
        
        // 开始条形码扫描
        function startBarcodeScanner() {
            if (scannerActive) return;
            
            const scannerContainer = document.getElementById('scanner-container');
            scannerContainer.innerHTML = '';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerContainer,
                    constraints: {
                        width: 480,
                        height: 320,
                        facingMode: "environment" // 使用后置攝像頭
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "upc_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showNotification('無法啟動攝像頭: ' + err, 'error');
                    return;
                }
                Quagga.start();
                scannerActive = true;
                startScannerBtn.style.display = 'none';
                stopScannerBtn.style.display = 'inline-block';
            });
            
            Quagga.onDetected(function(result) {
                if (result && result.codeResult) {
                    scannedBarcode = result.codeResult.code;
                    scanResult.textContent = scannedBarcode;
                    confirmScanBtn.style.display = 'block';
                    showNotification('監測到QRcode: ' + scannedBarcode, 'success');
                    
                    // 自动停止扫描
                    stopBarcodeScanner();
                }
            });
        }
        
        // 停止条形码扫描
        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                startScannerBtn.style.display = 'inline-block';
                stopScannerBtn.style.display = 'none';
            }
        }
        
        // 显示登录区域
        function showLoginSection() {
            loginSection.style.display = 'flex';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            userIdInput.value = '';
        }
        
        // 显示用户仪表盘
        function showUserDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'block';
            adminDashboard.style.display = 'none';
            
            // 更新用户信息
            document.getElementById('dashboardUserName').textContent = currentUser.name;
            document.getElementById('dashboardUserId').textContent = currentUser.id;
            document.getElementById('dashboardUserBarcode').textContent = currentUser.barcodeCode;
            document.getElementById('dashboardUserPoints').textContent = currentUser.points;
            document.getElementById('dashboardUserTotalPoints').textContent = currentUser.totalPoints;
            document.getElementById('dashboardUserTier').textContent = currentUser.tier;
            document.getElementById('dashboardUserTier').className = 'user-tier ' + getTierClass(currentUser.tier);
            
            // 生成用户条形码 - 添加延迟
            setTimeout(() => {
                generateBarcode(currentUser.barcodeCode, userBarcodeDisplay);
            }, 100);
            
            // 重新渲染奖品列表
            renderPrizes();
        }
        
        // 显示管理员仪表盘
        function showAdminDashboard() {
            loginSection.style.display = 'none';
            userDashboard.style.display = 'none';
            adminDashboard.style.display = 'block';
        }
        
        // 渲染奖品列表（用户界面）
        function renderPrizes() {
            prizesGrid.innerHTML = '';
            
            prizes.forEach(prize => {
                const prizeCard = document.createElement('div');
                prizeCard.className = 'prize-card';
                
                const canAfford = currentUser && currentUser.points >= prize.points;
                
                prizeCard.innerHTML = `
                    <div class="prize-image">
                        <i class="fas ${prize.icon}"></i>
                    </div>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-points">${prize.points} 积分</div>
                    <button class="btn ${canAfford ? '' : 'disabled'}" 
                            ${canAfford ? '' : 'disabled'}
                            onclick="redeemPrize('${prize.id}')">
                        ${canAfford ? '立即兌換' : '積分不足'}
                    </button>
                `;
                
                prizesGrid.appendChild(prizeCard);
            });
        }
        
        // 兑换奖品
        function redeemPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            
            if (currentUser.points >= prize.points) {
                currentUser.points -= prize.points;
                
                // 记录积分变更历史
                pointsHistory.push({
                    userId: currentUser.id,
                    timestamp: new Date().getTime(),
                    pointsChange: -prize.points,
                    reason: `兌換獎品：${prize.name}`
                });
                
                // 检查成就
                checkAchievements(currentUser);
                
                // 保存数据
                saveDataToStorage();
                
                document.getElementById('dashboardUserPoints').textContent = currentUser.points;
                renderPrizes();
                showNotification(`成功兑换 ${prize.name}！`, 'success');
            } else {
                showNotification('積分不足，无法兑换該獎品', 'error');
            }
        }
        
        // 渲染用户表格 - 移除批量操作相关代码
        function renderUsersTable(searchTerm = '') {
            usersTableBody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = users.filter(user => 
                    user.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    user.barcodeCode.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.barcodeCode}</td>
                    <td>${user.points}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="selectUser('${user.id}')">选择</button>
                        ${!user.isAdmin ? 
                            `<button class="action-btn" style="background: #f39c12;" onclick="promoteUser('${user.id}')">升级为管理員</button>` : 
                            ''
                        }
                        <button class="action-btn" style="background: #e74c3c;" onclick="deleteUser('${user.id}')">移除人員</button>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });
            
            updateUserStats();
        }
        
        // 渲染奖品表格（管理员界面）
        function renderPrizesTable() {
            prizesTableBody.innerHTML = '';
            
            prizes.forEach(prize => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${prize.id}</td>
                    <td>${prize.name}</td>
                    <td>${prize.points}</td>
                    <td><i class="fas ${prize.icon}"></i> ${prize.icon}</td>
                    <td>
                        <button class="action-btn" style="background: #3498db;" onclick="editPrize('${prize.id}')">编辑</button>
                        <button class="action-btn" style="background: #e74c3c;" onclick="deletePrize('${prize.id}')">移除人員</button>
                    </td>
                `;
                
                prizesTableBody.appendChild(row);
            });
        }
        
        // 渲染用户积分历史
        function renderUserHistory() {
            const userHistoryContent = document.getElementById('userHistoryContent');
            userHistoryContent.innerHTML = '';
            
            // 获取当前用户的历史记录
            const userHistory = pointsHistory
                .filter(record => record.userId === currentUser.id)
                .sort((a, b) => b.timestamp - a.timestamp);
            
            if (userHistory.length === 0) {
                userHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            userHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                userHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染管理员查看的积分历史
        function renderAdminHistory(searchTerm = '') {
            const adminHistoryContent = document.getElementById('adminHistoryContent');
            adminHistoryContent.innerHTML = '';
            
            let filteredHistory = pointsHistory;
            
            // 如果提供了搜索条件，过滤历史记录
            if (searchTerm) {
                // 查找匹配的用户
                const matchedUsers = users.filter(u => 
                    u.id.includes(searchTerm) || 
                    u.name.includes(searchTerm) || 
                    u.barcodeCode.includes(searchTerm)
                );
                
                const matchedUserIds = matchedUsers.map(u => u.id);
                filteredHistory = pointsHistory.filter(record => 
                    matchedUserIds.includes(record.userId)
                );
            }
            
            // 按时间排序
            filteredHistory.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredHistory.length === 0) {
                adminHistoryContent.innerHTML = '<p>暂無積分歷史紀錄</p>';
                return;
            }
            
            filteredHistory.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const user = users.find(u => u.id === record.userId);
                const pointsClass = record.pointsChange >= 0 ? 'points-positive' : 'points-negative';
                const pointsPrefix = record.pointsChange >= 0 ? '+' : '';
                
                historyItem.innerHTML = `
                    <div>
                        <div><strong>${user ? user.name : '未知用户'} (${record.userId})</strong></div>
                        <div>${record.reason}</div>
                        <div class="small">${formatDate(record.timestamp)}</div>
                    </div>
                    <div class="history-points ${pointsClass}">${pointsPrefix}${record.pointsChange}</div>
                `;
                
                adminHistoryContent.appendChild(historyItem);
            });
        }
        
        // 渲染用户排行榜 - 前三名更醒目
        function renderUserLeaderboard() {
            userLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                userLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                userLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染管理员排行榜 - 前三名更醒目
        function renderAdminLeaderboard() {
            adminLeaderboardBody.innerHTML = '';
            
            // 获取普通用户并按累积积分排序
            const sortedUsers = users
                .filter(u => !u.isAdmin)
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            if (sortedUsers.length === 0) {
                adminLeaderboardBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无用户数据</td></tr>';
                return;
            }
            
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                const tierClass = getTierClass(user.tier);
                
                // 为前三名添加特殊样式
                if (index < 3) {
                    row.className = 'top-three';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.id}</td>
                    <td>${user.totalPoints}</td>
                    <td><span class="user-tier ${tierClass}">${user.tier}</span></td>
                `;
                
                adminLeaderboardBody.appendChild(row);
            });
        }
        
        // 渲染成就系统
        function renderAchievements() {
            const achievementsContent = document.getElementById('achievementsContent');
            achievementsContent.innerHTML = '';
            
            if (!currentUser) return;
            
            // 检查并更新用户成就
            checkAchievements(currentUser);
            
            achievements.forEach(achievement => {
                const hasAchievement = currentUser.achievements.includes(achievement.name);
                const achievementItem = document.createElement('div');
                achievementItem.className = 'history-item';
                
                achievementItem.innerHTML = `
                    <div>
                        <div><i class="fas ${achievement.icon} ${hasAchievement ? 'text-success' : 'text-muted'}"></i> ${achievement.name}</div>
                        <div class="small">${achievement.description}</div>
                    </div>
                    <div>
                        ${hasAchievement ? 
                            '<span class="badge" style="background: var(--success);">已獲得</span>' : 
                            '<span class="badge" style="background: var(--secondary);">未獲得</span>'
                        }
                    </div>
                `;
                
                achievementsContent.appendChild(achievementItem);
            });
        }
        
        // 检查用户成就
        function checkAchievements(user) {
            let newAchievements = [];
            
            achievements.forEach(achievement => {
                if (achievement.condition(user) && !user.achievements.includes(achievement.name)) {
                    user.achievements.push(achievement.name);
                    newAchievements.push(achievement.name);
                }
            });
            
            // 如果有新成就，显示通知
            if (newAchievements.length > 0 && currentUser && currentUser.id === user.id) {
                showNotification(`恭喜獲得新成就: ${newAchievements.join(', ')}`, 'success');
            }
            
            return newAchievements;
        }
        
        // 渲染段位饼图 - 带动画效果，更圆润
        function renderTierPieChartWithAnimation(canvasElement, legendElement) {
            // 如果已有动画在进行，取消它
            if (pieChartAnimations[canvasElement.id]) {
                cancelAnimationFrame(pieChartAnimations[canvasElement.id]);
                delete pieChartAnimations[canvasElement.id];
            }
            
            // 统计各段位用户数量
            const tierCounts = {};
            tierThresholds.forEach(tier => {
                tierCounts[tier.name] = 0;
            });
            
            users.filter(u => !u.isAdmin).forEach(user => {
                tierCounts[user.tier]++;
            });
            
            // 过滤掉数量为0的段位
            const filteredTiers = tierThresholds.filter(tier => tierCounts[tier.name] > 0);
            
            // 计算总数
            const totalUsers = users.filter(u => !u.isAdmin).length;
            
            // 生成图例
            legendElement.innerHTML = '';
            filteredTiers.forEach(tier => {
                const percentage = totalUsers > 0 ? ((tierCounts[tier.name] / totalUsers) * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${tier.color};"></div>
                    <span>${tier.name}: ${tierCounts[tier.name]}人 (${percentage}%)</span>
                `;
                legendElement.appendChild(legendItem);
            });
            
            const ctx = canvasElement.getContext('2d');
            const width = canvasElement.width;
            const height = canvasElement.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 * 0.8;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 如果没有数据，显示提示
            if (totalUsers === 0) {
                ctx.fillStyle = '#ccc';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', centerX, centerY);
                return;
            }
            
            // 计算每个扇形的起始和结束角度
            let startAngle = -Math.PI / 2; // 从12点钟方向开始
            const slices = filteredTiers.map(tier => {
                const sliceAngle = (2 * Math.PI * tierCounts[tier.name]) / totalUsers;
                const slice = {
                    tier: tier,
                    startAngle: startAngle,
                    endAngle: startAngle + sliceAngle,
                    color: tier.color
                };
                startAngle += sliceAngle;
                return slice;
            });
            
            // 动画参数
            const duration = 1500; // 动画持续1500毫秒
            let startTime = null;
            
            // 动画函数
            function animate(currentTime) {
                if (!startTime) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1); // 0到1
                
                // 当前角度从0到2PI
                const currentAngle = progress * 2 * Math.PI;
                
                // 清除画布
                ctx.clearRect(0, 0, width, height);
                
                // 绘制每个扇形
                slices.forEach(slice => {
                    // 如果当前角度大于这个扇形的起始角度，则绘制
                    if (currentAngle > slice.startAngle + Math.PI / 2) {
                        const start = slice.startAngle;
                        const end = Math.min(currentAngle - Math.PI / 2, slice.endAngle);
                        
                        if (end > start) {
                            ctx.beginPath();
                            ctx.moveTo(centerX, centerY);
                            ctx.arc(centerX, centerY, radius, start, end);
                            ctx.closePath();
                            ctx.fillStyle = slice.color;
                            ctx.fill();
                            
                            // 绘制分隔线
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                });
                
                // 如果动画未完成，继续
                if (progress < 1) {
                    pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
                } else {
                    // 动画完成，绘制中心圆和文字
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                    
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('段位分布', centerX, centerY - 8);
                    ctx.font = '14px Arial';
                    ctx.fillText(`${totalUsers}人`, centerX, centerY + 10);
                    
                    // 动画完成，清除动画ID
                    delete pieChartAnimations[canvasElement.id];
                }
            }
            
            // 启动动画
            pieChartAnimations[canvasElement.id] = requestAnimationFrame(animate);
        }
        
        // 选择用户
        function selectUser(userId) {
            const user = users.find(u => u.id === userId);
            document.getElementById('searchUser').value = user.id;
        }
        
        // 升级用户为管理员
        function promoteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.isAdmin = true;
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification(`已将 ${user.name} 升級為管理員`, 'success');
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？此操作不可撤銷。')) {
                users = users.filter(u => u.id !== userId);
                
                // 保存数据
                saveDataToStorage();
                
                renderUsersTable();
                updateSystemStats();
                showNotification('用户已删除', 'success');
            }
        }
        
        // 编辑奖品
        function editPrize(prizeId) {
            const prize = prizes.find(p => p.id === prizeId);
            if (prize) {
                document.getElementById('editPrizeId').value = prize.id;
                document.getElementById('editPrizeName').value = prize.name;
                document.getElementById('editPrizePoints').value = prize.points;
                document.getElementById('editPrizeIcon').value = prize.icon;
                
                editPrizeModal.style.display = 'flex';
            }
        }
        
        // 删除奖品
        function deletePrize(prizeId) {
            if (confirm('确定要删除这个獎品吗？此操作不可撤銷。')) {
                prizes = prizes.filter(p => p.id !== prizeId);
                
                // 保存数据
                saveDataToStorage();
                
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                showNotification('獎品已删除', 'success');
            }
        }
        
        // 更新用户统计信息 - 使用累积积分
        function updateUserStats() {
            const totalUsers = users.filter(u => !u.isAdmin).length;
            const totalPoints = users.filter(u => !u.isAdmin).reduce((sum, user) => sum + user.points, 0);
            
            // 使用累积积分统计各段位用户数量
            const activeUsers = users.filter(u => !u.isAdmin && u.totalPoints >= 1500).length;
            const activeUser4 = users.filter(u => !u.isAdmin && u.totalPoints >= 1200 && u.totalPoints < 1500).length;
            const activeUser3 = users.filter(u => !u.isAdmin && u.totalPoints >= 900 && u.totalPoints < 1200).length;
            const activeUser2 = users.filter(u => !u.isAdmin && u.totalPoints >= 600 && u.totalPoints < 900).length;
            const activeUser1 = users.filter(u => !u.isAdmin && u.totalPoints >= 300 && u.totalPoints < 600).length;
            const activeUser0 = users.filter(u => !u.isAdmin && u.totalPoints < 300).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('activeUser4').textContent = activeUser4;
            document.getElementById('activeUser3').textContent = activeUser3;
            document.getElementById('activeUser2').textContent = activeUser2;
            document.getElementById('activeUser1').textContent = activeUser1;
            document.getElementById('activeUser0').textContent = activeUser0;
        }
        
        // 更新系统统计信息
        function updateSystemStats() {
            document.getElementById('systemUsers').textContent = users.filter(u => !u.isAdmin).length;
            document.getElementById('systemPrizes').textContent = prizes.length;
            document.getElementById('systemHistory').textContent = pointsHistory.length;
            document.getElementById('systemAdmins').textContent = users.filter(u => u.isAdmin).length;
            
            updateUserStats();
        }
        
        // 导出用户数据
        function exportUsersData() {
            const dataStr = JSON.stringify(users.filter(u => !u.isAdmin), null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'users_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('用户數據導出成功', 'success');
        }
        
        // 导出奖品数据
        function exportPrizesData() {
            const dataStr = JSON.stringify(prizes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'prizes_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('獎品數據導出成功', 'success');
        }
        
        // 导出历史数据
        function exportHistoryData() {
            const dataStr = JSON.stringify(pointsHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'history_data.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('歷史數據導出成功', 'success');
        }
        
        // 导出所有数据
        function exportAllData() {
            const allData = {
                users: users,
                prizes: prizes,
                history: pointsHistory,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'barcode_system_backup.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('系統數據備份成功', 'success');
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.users && Array.isArray(importedData.users)) {
                        users = importedData.users;
                        
                        // 确保导入的用户数据有累积积分和段位字段
                        users.forEach(user => {
                            if (user.totalPoints === undefined) {
                                user.totalPoints = user.points || 0;
                            }
                            if (user.tier === undefined) {
                                user.tier = calculateUserTier(user.totalPoints);
                            }
                            if (user.achievements === undefined) {
                                user.achievements = [];
                            }
                            
                            // 检查成就
                            checkAchievements(user);
                        });
                    }
                    
                    if (importedData.prizes && Array.isArray(importedData.prizes)) {
                        prizes = importedData.prizes;
                    }
                    
                    if (importedData.history && Array.isArray(importedData.history)) {
                        pointsHistory = importedData.history;
                    }
                    
                    saveDataToStorage();
                    renderUsersTable();
                    renderPrizesTable();
                    renderPrizes();
                    updateSystemStats();
                    
                    showNotification('數據導入成功', 'success');
                } catch (error) {
                    showNotification('數據導入失败：文件格式錯誤', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // 重置文件输入
            event.target.value = '';
        }
        
        // 修改管理员密码
        function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('請填寫所有密碼字段', 'error');
                return;
            }
            
            if (currentPassword !== adminPassword) {
                showNotification('當前密碼錯誤', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('新密碼和确认密碼不匹配', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('新密码长度至少6位', 'error');
                return;
            }
            
            // 在实际应用中，这里应该将新密码保存到安全的地方
            // 由于这是前端演示，我们无法真正修改硬编码的密码
            // 但可以保存到localStorage作为演示
            localStorage.setItem('adminNewPassword', newPassword);
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('密码修改需到代碼層尋找*****', 'success');
        }
        
        // 重置系统数据
        function resetSystemData() {
            if (confirm('确定要重置所有系統數據吗？此操作将删除所有用户、獎品和歷史紀錄，且不可恢复！')) {
                users = [
                    { 
                        id: 'wwlwcf002', 
                        name: '管理员', 
                        barcodeCode: 'wwlwcf002', 
                        points: 0, 
                        totalPoints: 0,
                        tier: '',
                        isAdmin: true,
                        achievements: []
                    }
                ];
                prizes = [];
                pointsHistory = [];
                
                saveDataToStorage();
                renderUsersTable();
                renderPrizesTable();
                renderPrizes();
                updateSystemStats();
                
                showNotification('系統數據已重置', 'success');
            }
        }
        
        // 生成随机用户ID
        function generateUserId() {
            const prefix = 'U';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机条形码编码
        function generateBarcodeCode() {
            const prefix = 'USER';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 生成随机奖品ID
        function generatePrizeId() {
            const prefix = 'P';
            const timestamp = new Date().getTime().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 保存数据到本地存储
        function saveDataToStorage() {
            localStorage.setItem('barcodePointsUsers', JSON.stringify(users));
            localStorage.setItem('barcodePointsPrizes', JSON.stringify(prizes));
            localStorage.setItem('barcodePointsHistory', JSON.stringify(pointsHistory));
        }
        
        // 显示通知
        function showNotification(message, type) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'success') {
                notification.style.background = '#2ecc71';
            } else if (type === 'error') {
                notification.style.background = '#e74c3c';
            } else {
                notification.style.background = '#3498db';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 确保JsBarcode库已加载
        function checkBarcodeLibrary() {
            if (typeof JsBarcode === 'undefined') {
                console.error('JsBarcode库未正确加载');
                // 尝试重新加载
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js';
                script.onload = function() {
                    console.log('JsBarcode库重新加载成功');
                    initPage();
                };
                document.head.appendChild(script);
            } else {
                console.log('JsBarcode库已加载');
                initPage();
            }
        }

        // 在页面加载时检查
        window.addEventListener('load', function() {
            checkBarcodeLibrary();
        });
    </script>
</body>
</html>
